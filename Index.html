<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Coach Tracker Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&family=Inter:wght@400;500&display=swap');
:root {
  --bg:#0B0D0F; --surface:#111417; --surface2:#181C20; --border:#232830;
  --accent:#00E676; --accent2:#FF6B00; --green:#00E676; --red:#FF1744;
  --yellow:#FFD600; --blue:#00B8FF; --text:#F0F2F5; --muted:#6B7A8D;
  --fd:'Bebas Neue',sans-serif; --fb:'Inter',sans-serif; --fr:'Rajdhani',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:var(--fb);min-height:100vh;max-width:640px;margin:0 auto;padding-bottom:110px;}
.header{background:linear-gradient(135deg,#0d1525,#111827);border-bottom:2px solid var(--accent);padding:10px 14px;position:sticky;top:0;z-index:200;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.logo{font-family:var(--fd);font-weight:900;font-size:20px;letter-spacing:2px;color:var(--accent);white-space:nowrap;}
.score-block{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:5px 10px;}
.score-team{font-family:var(--fd);font-size:12px;color:var(--muted);font-weight:700;letter-spacing:1px;max-width:55px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.score-display{font-family:var(--fd);font-size:26px;font-weight:900;display:flex;align-items:center;gap:4px;}
.score-num{background:var(--bg);border:1px solid var(--border);border-radius:6px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;user-select:none;}
.score-num:active{transform:scale(.88);background:var(--accent);color:var(--bg);}
.score-sep{color:var(--muted);font-size:20px;}
.timer-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 14px;display:flex;align-items:center;gap:10px;}
.timer-display{font-family:var(--fd);font-size:40px;font-weight:900;color:var(--accent);letter-spacing:2px;min-width:105px;}
.timer-display.running{color:var(--green);}
.timer-display.paused{color:var(--yellow);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}
.timer-buttons{display:flex;gap:6px;flex:1;}
.btn-timer{flex:1;padding:9px 6px;border:none;border-radius:10px;font-family:var(--fd);font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;transition:all .15s;text-transform:uppercase;}
.btn-timer:active{transform:scale(.93);}
.btn-start{background:var(--green);color:#000;}
.btn-pause{background:var(--yellow);color:#000;}
.btn-reset{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.btn-half{background:var(--accent2);color:#fff;}
.half-badge{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:var(--fd);font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;white-space:nowrap;}
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex:1;min-width:58px;padding:11px 5px;border:none;background:none;color:var(--muted);font-family:var(--fd);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.panel{display:none;padding:12px;}
.panel.active{display:block;}
.section-title{font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin:14px 0 8px 0;border-left:3px solid var(--accent);padding-left:8px;}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px;}
.action-grid.three{grid-template-columns:1fr 1fr 1fr;}
.btn-action{border:none;border-radius:12px;padding:13px 8px;cursor:pointer;font-family:var(--fd);font-weight:700;font-size:14px;letter-spacing:.5px;display:flex;flex-direction:column;align-items:center;gap:3px;transition:all .15s;position:relative;user-select:none;}
.btn-action:active{transform:scale(.92);filter:brightness(1.2);}
.btn-action .icon{font-size:20px;line-height:1;}
.btn-action .label{font-size:10px;letter-spacing:1px;opacity:.85;}
.btn-action .count{position:absolute;top:5px;right:7px;background:rgba(0,0,0,.45);color:#fff;border-radius:10px;font-size:11px;font-weight:900;min-width:17px;height:17px;display:flex;align-items:center;justify-content:center;padding:0 3px;}
.btn-green{background:linear-gradient(135deg,#00873d,#00c853);color:#fff;}
.btn-blue{background:linear-gradient(135deg,#0062cc,#00aaff);color:#fff;}
.btn-red{background:linear-gradient(135deg,#cc0000,#ff4444);color:#fff;}
.btn-orange{background:linear-gradient(135deg,#d94f00,#ff6b35);color:#fff;}
.btn-yellow{background:linear-gradient(135deg,#b28900,#ffd600);color:#000;}
.btn-purple{background:linear-gradient(135deg,#5e35b1,#9c27b0);color:#fff;}
.btn-teal{background:linear-gradient(135deg,#00695c,#00bcd4);color:#fff;}
.btn-grey{background:linear-gradient(135deg,#263238,#37474f);color:#cfd8dc;}
.btn-pink{background:linear-gradient(135deg,#880e4f,#e91e63);color:#fff;}
.zone-buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:8px;}
.btn-zone{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 4px;color:var(--text);font-family:var(--fd);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:all .15s;text-align:center;}
.btn-zone:active,.btn-zone.selected{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.tag-row{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 10px 0;}
.tag{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-family:var(--fd);font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;transition:all .15s;letter-spacing:.5px;}
.tag:active,.tag.sel{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.log-list{list-style:none;display:flex;flex-direction:column;gap:6px;}
.log-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;animation:slideIn .2s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.log-time{font-family:var(--fd);font-size:14px;font-weight:700;color:var(--accent);min-width:38px;}
.log-icon{font-size:17px;}
.log-text{flex:1;font-size:13px;color:var(--text);}
.log-zone{font-size:11px;color:var(--muted);font-family:var(--fd);letter-spacing:1px;}
.btn-delete{background:none;border:none;color:var(--muted);font-size:15px;cursor:pointer;padding:4px;}
.btn-delete:active{color:var(--red);}
.empty-log{text-align:center;color:var(--muted);font-family:var(--fd);font-size:13px;letter-spacing:1px;padding:28px;text-transform:uppercase;}
.notes-area{background:var(--surface2);border:1px solid var(--border);border-radius:12px;width:100%;min-height:140px;padding:12px;color:var(--text);font-family:var(--fb);font-size:15px;line-height:1.6;resize:vertical;outline:none;transition:border-color .2s;}
.notes-area:focus{border-color:var(--accent);}
.stat-row{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 14px;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.stat-label{font-family:var(--fd);font-size:13px;color:var(--muted);letter-spacing:1px;font-weight:700;text-transform:uppercase;display:flex;align-items:center;gap:8px;flex:1;}
.stat-value{font-family:var(--fd);font-size:22px;font-weight:900;color:var(--text);}
.btn-export{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent),#0095b3);color:var(--bg);border:none;border-radius:12px;font-family:var(--fd);font-size:15px;font-weight:900;letter-spacing:2px;text-transform:uppercase;cursor:pointer;margin-top:12px;transition:all .15s;}
.btn-export:active{transform:scale(.97);}
.setup-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;}
.input-row{margin-bottom:10px;}
.input-label{font-family:var(--fd);font-size:11px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;margin-bottom:5px;}
.input-field{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:var(--fb);font-size:15px;outline:none;}
.input-field:focus{border-color:var(--accent);}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:1000;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-top-left-radius:22px;border-top-right-radius:22px;padding:20px;width:100%;max-width:640px;animation:slideUp .25s ease;max-height:85vh;overflow-y:auto;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-title{font-family:var(--fd);font-size:18px;font-weight:900;letter-spacing:2px;text-transform:uppercase;margin-bottom:14px;color:var(--accent);}
.modal-buttons{display:flex;gap:10px;margin-top:14px;}
.btn-modal-cancel{flex:1;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:var(--fd);font-size:14px;font-weight:700;cursor:pointer;}
.btn-modal-confirm{flex:2;padding:12px;background:var(--green);border:none;border-radius:10px;color:#000;font-family:var(--fd);font-size:15px;font-weight:900;letter-spacing:1px;cursor:pointer;}
/* TACTICS */
.format-tabs{display:flex;gap:8px;margin-bottom:12px;}
.format-tab{flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:var(--surface2);color:var(--muted);font-family:var(--fd);font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;text-align:center;transition:all .2s;}
.format-tab.active{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,.08);}
.tactic-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.tactic-card{background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;transition:all .2s;text-align:center;}
.tactic-card.selected{border-color:var(--accent);background:rgba(0,212,255,.1);}
.tactic-name{font-family:var(--fd);font-size:20px;font-weight:900;color:var(--text);letter-spacing:1px;}
.tactic-desc{font-family:var(--fb);font-size:11px;color:var(--muted);margin-top:3px;}
/* PITCH */
.pitch-container{position:relative;width:100%;background:#1e4d1e;border:2px solid #2d6b2d;border-radius:12px;overflow:hidden;margin:10px 0;}
.pitch-svg{width:100%;height:auto;display:block;}
.player-token{position:absolute;transform:translate(-50%,-50%);cursor:default;user-select:none;}
.player-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--fd);font-size:11px;font-weight:900;border:2px solid rgba(255,255,255,.5);box-shadow:0 2px 8px rgba(0,0,0,.6);}
.player-dot.on-field{background:linear-gradient(135deg,#1565c0,#42a5f5);color:#fff;}
.player-dot.substituted{background:linear-gradient(135deg,#444,#777);color:#aaa;opacity:.55;}
.player-dot.empty-slot{background:rgba(255,255,255,.08);color:var(--muted);border-style:dashed;}
.player-name-tag{font-family:var(--fd);font-size:9px;font-weight:700;color:#fff;text-align:center;margin-top:1px;text-shadow:0 1px 3px #000;letter-spacing:.5px;white-space:nowrap;max-width:48px;overflow:hidden;text-overflow:ellipsis;}
/* ROSTER */
.roster-list{display:flex;flex-direction:column;gap:6px;}
.roster-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;}
.player-num{font-family:var(--fd);font-size:20px;font-weight:900;color:var(--accent);min-width:28px;text-align:center;}
.player-info{flex:1;min-width:0;}
.player-pname{font-family:var(--fd);font-size:15px;font-weight:700;color:var(--text);letter-spacing:.5px;}
.player-pos{font-family:var(--fd);font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.player-status{font-family:var(--fd);font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:6px;white-space:nowrap;}
.status-field{background:rgba(0,230,118,.15);color:var(--green);border:1px solid rgba(0,230,118,.3);}
.status-bench{background:rgba(90,106,130,.15);color:var(--muted);border:1px solid var(--border);}
.status-out{background:rgba(255,68,68,.15);color:var(--red);border:1px solid rgba(255,68,68,.3);}
.btn-sub{background:var(--accent2);border:none;border-radius:8px;padding:6px 10px;color:#fff;font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:.5px;cursor:pointer;white-space:nowrap;margin-left:4px;}
.btn-sub:active{transform:scale(.92);}
.btn-sub.enter{background:var(--green);color:#000;}
.playtime-bar-wrap{background:var(--surface);border-radius:4px;height:4px;width:100%;margin-top:4px;overflow:hidden;}
.playtime-bar-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--accent));border-radius:4px;transition:width .5s;}
.sub-item{background:linear-gradient(135deg,rgba(255,107,53,.07),rgba(0,230,118,.07));border:1px solid rgba(255,107,53,.2);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;}
.sub-time-label{font-family:var(--fd);font-size:14px;font-weight:900;color:var(--accent);}
.goal-zone{border:2px solid rgba(255,255,255,0.4);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;font-family:var(--fd);font-size:14px;font-weight:900;padding:10px 4px;cursor:pointer;transition:all .15s;letter-spacing:1px;}
.goal-zone:active,.goal-zone.sel{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.pitch-zone{cursor:pointer;transition:fill .15s;}
.pitch-zone:active{fill:rgba(0,212,255,0.45) !important;}
.pitch-zone.zoned{fill:rgba(0,212,255,0.35) !important;}
.zone-field{display:grid;grid-template-columns:repeat(6,1fr);gap:3px;margin-bottom:8px;}
.btn-zone-field{border:none;border-radius:6px;padding:12px 2px;cursor:pointer;font-family:var(--fd);font-size:13px;font-weight:900;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5);transition:all .15s;text-align:center;letter-spacing:.5px;}
.btn-zone-field:active,.btn-zone-field.selected{filter:brightness(1.4);transform:scale(.95);box-shadow:0 0 0 2px #fff;}
.zone-red{background:linear-gradient(135deg,#b71c1c,#e53935);}
.zone-orange{background:linear-gradient(135deg,#e65100,#fb8c00);}
.zone-green{background:linear-gradient(135deg,#1b5e20,#43a047);}

/* ‚îÄ‚îÄ JERSEY TOKENS ‚îÄ‚îÄ */
.player-token{position:absolute;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:1px;cursor:pointer;z-index:10;}
.jersey-wrap{position:relative;width:36px;height:36px;}
.jersey-wrap svg{width:36px;height:36px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.8));}
.jersey-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-44%);font-family:'Bebas Neue',sans-serif;font-size:10px;line-height:1;color:#000;pointer-events:none;}
.jersey-num.light{color:#fff;}
.token-name{font-family:'Rajdhani',sans-serif;font-size:8px;font-weight:700;color:#fff;letter-spacing:.3px;text-shadow:0 1px 4px rgba(0,0,0,1),0 0 8px rgba(0,0,0,1);max-width:42px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px;}
/* ‚îÄ‚îÄ SECTION TITLE UPDATE ‚îÄ‚îÄ */
.section-title{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin:14px 0 8px;display:flex;align-items:center;gap:7px;}
.section-title::before{content:'';width:2px;height:11px;background:var(--accent);border-radius:1px;display:inline-block;flex-shrink:0;}
/* ‚îÄ‚îÄ TABS OVERRIDE ‚îÄ‚îÄ */
.tabs{scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;}
.tab-icon{font-size:14px;line-height:1;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{border-bottom:2px solid rgba(0,230,118,0.2);}
.logo-name{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;}
.logo-sub{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--accent);}
/* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
.timer-display{font-family:'Bebas Neue',sans-serif;font-size:46px;letter-spacing:4px;color:var(--accent);}
.timer-display.running{text-shadow:0 0 20px rgba(0,230,118,0.3);}
.timer-display.paused{color:var(--yellow);}
.half-badge{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1px;}
.btn-timer{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1.5px;}
/* ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ */
.score-num{font-family:'Bebas Neue',sans-serif;font-size:30px;}
.score-team{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;}
/* ‚îÄ‚îÄ ROSTER ‚îÄ‚îÄ */
.roster-num{font-family:'Bebas Neue',sans-serif;font-size:26px;color:rgba(0,230,118,0.5);}
.roster-name{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;}
.roster-pos{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;}
.roster-status{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;}
/* ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ */
.btn-action{background:var(--surface2);}
.btn-action::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.btn-green::before{background:var(--accent);}
.btn-blue::before{background:var(--blue);}
.btn-yellow::before{background:var(--yellow);}
.btn-red::before{background:var(--red);}
.btn-orange::before{background:var(--accent2);}
.btn-purple::before{background:#CE93D8;}
.btn-teal::before{background:#26C6DA;}
.btn-pink::before{background:#F48FB1;}
.label{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1.5px;}
.count{font-family:'Bebas Neue',sans-serif;}
/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-time{font-family:'Bebas Neue',sans-serif;letter-spacing:1px;}
.log-text{font-family:'Rajdhani',sans-serif;font-weight:600;}
/* ‚îÄ‚îÄ TACTIC CARDS ‚îÄ‚îÄ */
.tactic-name{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;}
.tactic-desc{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:.5px;}
/* ‚îÄ‚îÄ HISTO ‚îÄ‚îÄ */
.histo-result{font-family:'Bebas Neue',sans-serif;letter-spacing:1px;}
.histo-meta{font-family:'Rajdhani',sans-serif;font-weight:600;letter-spacing:2px;}
/* ‚îÄ‚îÄ RAPPORT STATS ‚îÄ‚îÄ */
.rapport-stat-val{font-family:'Bebas Neue',sans-serif;font-size:28px;}
.rapport-stat-lbl{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1.5px;}
/* import btn */
.importStatusBtn{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1.5px;}
.importStatusBtn.sel{background:var(--accent);border-color:var(--accent);color:#000;}


/* ‚îÄ‚îÄ MODULE CLUB ‚îÄ‚îÄ */
.ctab{padding:8px 14px;border:1px solid var(--border);border-radius:5px;background:var(--surface2);font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all .2s;}
.ctab.active{background:rgba(0,230,118,0.1);border-color:rgba(0,230,118,0.3);color:var(--accent);}
.ctab:active{transform:scale(.95);}
.cpanel{display:none;}
.cpanel.active{display:block;}


/* ‚ïê‚ïê RESET FORMULAIRES GLOBAL ‚ïê‚ïê */
input, select, textarea, button {
  -webkit-appearance: none;
  appearance: none;
  outline: none;
}
input:not([type="range"]), textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 11px 13px;
  color: var(--text);
  font-family: var(--fb);
  font-size: 14px;
  font-weight: 500;
  box-sizing: border-box;
  -webkit-text-fill-color: var(--text);
}
input:focus, textarea:focus {
  border-color: rgba(0,230,118,0.4);
  background: rgba(0,230,118,0.04);
}
input::placeholder, textarea::placeholder {
  color: var(--muted);
  opacity: 1;
  -webkit-text-fill-color: var(--muted);
}
select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 11px 36px 11px 13px;
  color: var(--text);
  font-family: var(--fb);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  -webkit-text-fill-color: var(--text);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236B7A8D' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 12px;
}
select option {
  background: #181C20;
  color: #F0F2F5;
}
select:focus {
  border-color: rgba(0,230,118,0.4);
}

/* ‚ïê‚ïê BOUTONS FILTRE / FORMAT ‚ïê‚ïê */
.dur-btn, .tag, .format-tab, .note-quick-btn, .seqEndBtn {
  padding: 7px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 5px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  transition: all .2s;
  -webkit-appearance: none;
}
.dur-btn:active, .tag:active, .format-tab:active { transform: scale(.95); }
.dur-btn.sel, .tag.sel, .format-tab.active,
.dur-btn.active, .seqEndBtn.sel {
  background: rgba(0,230,118,0.1);
  border-color: rgba(0,230,118,0.35);
  color: var(--accent);
}

/* ‚ïê‚ïê BOUTONS MODAL ‚ïê‚ïê */
.btn-modal-cancel {
  flex: 1;
  padding: 13px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  -webkit-appearance: none;
}
.btn-modal-confirm {
  flex: 2;
  padding: 13px;
  background: var(--accent);
  border: none;
  border-radius: 6px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: #000;
  cursor: pointer;
  -webkit-appearance: none;
}
.btn-apply, .btn-export {
  width: 100%;
  padding: 13px;
  background: var(--accent);
  border: none;
  border-radius: 6px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: #000;
  cursor: pointer;
  margin-top: 10px;
  -webkit-appearance: none;
}
.btn-danger-full {
  width: 100%;
  padding: 13px;
  background: rgba(255,23,68,0.08);
  border: 1px solid rgba(255,23,68,0.2);
  border-radius: 6px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--red);
  cursor: pointer;
  margin-top: 8px;
  -webkit-appearance: none;
}

/* ‚ïê‚ïê OPT BUTTONS (modaux) ‚ïê‚ïê */
.opt-btn {
  padding: 8px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 5px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  -webkit-appearance: none;
}
.opt-btn.sel {
  background: rgba(0,230,118,0.1);
  border-color: rgba(0,230,118,0.35);
  color: var(--accent);
}

/* ‚ïê‚ïê IMPORT STATUS BUTTONS ‚ïê‚ïê */
.importStatusBtn {
  padding: 8px 16px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 5px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  -webkit-appearance: none;
}
.importStatusBtn.sel {
  background: rgba(0,230,118,0.1);
  border-color: rgba(0,230,118,0.35);
  color: var(--accent);
}

/* ‚ïê‚ïê SETUP INPUTS ‚ïê‚ïê */
.setup-input, .modal-input, .notes-area {
  width: 100%;
  background: var(--surface2) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  padding: 11px 13px;
  color: var(--text) !important;
  font-family: var(--fb);
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
  -webkit-text-fill-color: var(--text) !important;
  -webkit-appearance: none;
}
.modal-select {
  width: 100%;
  background: var(--surface2) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  padding: 11px 36px 11px 13px;
  color: var(--text) !important;
  font-family: var(--fb);
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 10px;
  cursor: pointer;
  -webkit-text-fill-color: var(--text) !important;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236B7A8D' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: right 12px center !important;
}

</style>
<link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Coach Tracker Pro">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#0B0D0F">
</head>
<body>

<div class="header">
  <div class="logo">‚öΩ COACH</div>
  <div class="score-block">
    <span class="score-team" id="teamHomeName">NOUS</span>
    <div class="score-display">
      <div class="score-num" id="scoreHomeEl" onclick="changeScore('home',1)" oncontextmenu="changeScore('home',-1);return false;">0</div>
      <span class="score-sep">‚Äî</span>
      <div class="score-num" id="scoreAwayEl" onclick="changeScore('away',1)" oncontextmenu="changeScore('away',-1);return false;">0</div>
    </div>
    <span class="score-team" id="teamAwayName">ADV</span>
    <button onclick="openScoreEdit()" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 4px;margin-left:2px;" title="Corriger le score">‚úèÔ∏è</button>
  </div>
</div>

<div class="timer-bar">
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="timer-buttons">
    <button class="btn-timer btn-start" id="btnStart" onclick="startTimer()">‚ñ∂ GO</button>
    <button class="btn-timer btn-pause" id="btnPause" onclick="pauseTimer()" style="display:none">‚è∏</button>
    <button class="btn-timer btn-half" onclick="switchHalf()">¬Ω MT</button>
    <button class="btn-timer btn-reset" onclick="resetTimer()">‚Ü∫</button>
  </div>
  <div class="half-badge" id="halfBadge">1√®re MT</div>
  <div id="locationBadge" style="background:rgba(0,230,118,0.15);border:1px solid rgba(0,230,118,0.35);border-radius:4px;padding:4px 8px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;white-space:nowrap;">üè† DOMICILE</div>
</div>

<!-- BANNER SETUP RAPIDE -->
<div id="setupBanner" style="background:linear-gradient(135deg,rgba(0,212,255,0.12),rgba(0,212,255,0.04));border-bottom:1px solid rgba(0,212,255,0.25);padding:10px 14px;display:flex;align-items:center;gap:10px;">
  <span style="font-size:18px;">‚ö°</span>
  <div style="flex:1;">
    <div style="font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:1px;color:var(--accent);text-transform:uppercase;">Nouveau match ‚Äî configure les √©quipes</div>
    <div style="display:flex;gap:6px;margin-top:6px;">
      <input id="bannerHome" type="text" placeholder="Ton √©quipe" maxlength="20"
        style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-family:var(--fb);font-size:14px;outline:none;">
      <span style="font-family:var(--fd);font-size:18px;color:var(--muted);align-self:center;">vs</span>
      <input id="bannerAway" type="text" placeholder="Adversaire" maxlength="20"
        style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-family:var(--fb);font-size:14px;outline:none;">
      <button onclick="applyBannerSetup()" style="background:var(--accent);border:none;border-radius:8px;padding:7px 12px;color:var(--bg);font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer;white-space:nowrap;">‚úì OK</button>
    </div>
  </div>
  <button onclick="dismissBanner()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px;">‚úï</button>
</div>


<div class="tabs">
  <button class="tab active" onclick="showTab('actions',this)"><span class="tab-icon">‚ö°</span>Actions</button>
  <button class="tab" onclick="showTab('effectif',this)"><span class="tab-icon">üë•</span>Effectif</button>
  <button class="tab" onclick="showTab('club',this);renderClubInfoBar()"><span class="tab-icon">üèü</span>Club</button>
  <button class="tab" onclick="showTab('adversaire',this)"><span class="tab-icon">üî¥</span>Adv.</button>
  <button class="tab" onclick="showTab('tactique',this)"><span class="tab-icon">üìê</span>Tactique</button>
  <button class="tab" onclick="showTab('log',this)"><span class="tab-icon">üìã</span>Journal</button>
  <button class="tab" onclick="showTab('notes',this)"><span class="tab-icon">üìù</span>Notes</button>
  <button class="tab" onclick="showTab('rapport',this)"><span class="tab-icon">üìä</span>Bilan</button>
  <button class="tab" onclick="showTab('historique',this);renderHistorique()"><span class="tab-icon">üóÇ</span>Histo.</button>
  <button class="tab" onclick="showTab('setup',this)"><span class="tab-icon">‚öô</span>Config</button>
</div>

<!-- ACTIONS -->
<div class="panel active" id="panel-actions">
  <div class="section-title">‚öΩ Offensif</div>
  <div class="action-grid">
    <button class="btn-action btn-green" onclick="openTirCadreModal()"><span class="icon">üéØ</span><span class="label">TIR CADR√â</span><span class="count" id="cnt-TIR_CADRE">0</span></button>
    <button class="btn-action btn-blue" onclick="openTirRateModal()"><span class="icon">‚ÜóÔ∏è</span><span class="label">TIR RAT√â</span><span class="count" id="cnt-TIR_NON_CADRE">0</span></button>
    <button class="btn-action btn-green" onclick="openGoalModal()"><span class="icon">üü¢</span><span class="label">BUT !</span><span class="count" id="cnt-BUT">0</span></button>
    <button class="btn-action btn-orange" onclick="openActionModal('Occasion franche','üî•','OCCASION','Joueur','',false)"><span class="icon">üî•</span><span class="label">OCCASION</span><span class="count" id="cnt-OCCASION">0</span></button>
    <button class="btn-action btn-teal" onclick="openActionModal('Passe d√©cisive','üéÅ','ASSIST','Passeur','',false)"><span class="icon">üéÅ</span><span class="label">ASSIST</span><span class="count" id="cnt-ASSIST">0</span></button>
    <button class="btn-action btn-blue" onclick="openCentreModal()"><span class="icon">üìê</span><span class="label">CENTRE</span><span class="count" id="cnt-CENTRE">0</span></button>
    <button class="btn-action btn-pink" onclick="openPenaltyMarqueModal()"><span class="icon">‚öΩ</span><span class="label">PENALTY ‚úì</span><span class="count" id="cnt-PENALTY_MRQ">0</span></button>
    <button class="btn-action btn-purple" onclick="openPenaltyRateOffModal()"><span class="icon">‚ùå</span><span class="label">PENALTY ‚úó</span><span class="count" id="cnt-PENALTY_RATE">0</span></button>
  </div>
  <div class="section-title">üõ° D√©fensif</div>
  <div class="action-grid">
    <button class="btn-action btn-red" onclick="openActionModal('Perte de balle','üíî','PERTE','Joueur','',false)"><span class="icon">üíî</span><span class="label">PERTE</span><span class="count" id="cnt-PERTE">0</span></button>
    <button class="btn-action btn-green" onclick="openActionModal('R√©cup√©ration','üí™','RECUP','R√©cup√©rateur','',false)"><span class="icon">üí™</span><span class="label">R√âCUP</span><span class="count" id="cnt-RECUP">0</span></button>
    <button class="btn-action btn-teal" onclick="openActionModal('Duel gagn√©','üèÜ','DUEL_GAGNE','Joueur','',false)"><span class="icon">üèÜ</span><span class="label">DUEL ‚úì</span><span class="count" id="cnt-DUEL_GAGNE">0</span></button>
    <button class="btn-action btn-grey" onclick="openActionModal('Duel perdu','‚ùå','DUEL_PERDU','Joueur','',false)"><span class="icon">‚ùå</span><span class="label">DUEL ‚úó</span><span class="count" id="cnt-DUEL_PERDU">0</span></button>
    <button class="btn-action btn-blue" onclick="openPenaltyArret√©Modal()"><span class="icon">üß§</span><span class="label">PEN. ARR√äT√â</span><span class="count" id="cnt-PENALTY_ARR">0</span></button>
    <button class="btn-action btn-red" onclick="openPenaltyRateAdverseModal()"><span class="icon">üö´</span><span class="label">PEN. RAT√â ADV</span><span class="count" id="cnt-PENALTY_RATE_ADV">0</span></button>
    <button class="btn-action btn-teal" onclick="openArretGardienModal()"><span class="icon">üß§</span><span class="label">ARR√äT GARDIEN</span><span class="count" id="cnt-ARRET_GK">0</span></button>
    <button class="btn-action btn-orange" onclick="openOppGoalEnrichedModal()"><span class="icon">üî¥</span><span class="label">ENCAISS√â</span><span class="count" id="cnt-ENCAISSE">0</span></button>
  </div>
  <div class="action-grid three">
    <button class="btn-action btn-yellow" onclick="openCardModal('Carton jaune')"><span class="icon">üü®</span><span class="label">JAUNE</span><span class="count" id="cnt-JAUNE">0</span></button>
    <button class="btn-action btn-red" onclick="openCardModal('Carton rouge')"><span class="icon">üü•</span><span class="label">ROUGE</span><span class="count" id="cnt-ROUGE">0</span></button>
    <button class="btn-action btn-grey" onclick="openCartonBlancModal()"><span class="icon" style="font-size:18px;display:inline-block;width:18px;height:22px;background:#fff;border-radius:2px;border:1.5px solid rgba(0,0,0,0.3);"></span><span class="label">CARTON BLANC</span><span class="count" id="cnt-BLANC">0</span></button>
  </div>
  <div class="section-title">‚öôÔ∏è Transition / Phases</div>
  <div class="action-grid">
    <button class="btn-action btn-purple" onclick="openActionModal('Contre-attaque','‚ö°','CONTRE','D√©clencheur','',false)"><span class="icon">‚ö°</span><span class="label">CONTRE</span><span class="count" id="cnt-CONTRE">0</span></button>
    <button class="btn-action btn-blue" onclick="openActionModal('Pressing haut','ü¶æ','PRESSING','Joueur','',false)"><span class="icon">ü¶æ</span><span class="label">PRESSING</span><span class="count" id="cnt-PRESSING">0</span></button>
    <button class="btn-action btn-teal" onclick="openCoupFrancModal()"><span class="icon">üéØ</span><span class="label">COUP FRANC</span><span class="count" id="cnt-COUP_FRANC">0</span></button>
    <button class="btn-action btn-grey" onclick="openCornerModal()"><span class="icon">üö©</span><span class="label">CORNER</span><span class="count" id="cnt-CORNER">0</span></button>
  </div>
  <div class="action-grid">
    <button class="btn-action btn-orange" onclick="openActionModal('Hors-jeu offensif','üö©','HJ_OFF','Joueur','',false)"><span class="icon">üö©</span><span class="label">HJ OFFENSIF</span><span class="count" id="cnt-HJ_OFF">0</span></button>
    <button class="btn-action btn-grey" onclick="openActionModal('Hors-jeu d√©fensif','üè≥Ô∏è','HJ_DEF','Joueur','',false)"><span class="icon">üè≥Ô∏è</span><span class="label">HJ D√âFENSIF</span><span class="count" id="cnt-HJ_DEF">0</span></button>
  </div>


  <!-- BOUTON S√âQUENCE -->
  <div class="section-title" style="margin-top:8px;">üîó S√©quence de jeu</div>
  <div style="padding:0 0 8px 0;">
    <button onclick="openSeqModal()" style="width:100%;padding:14px;background:linear-gradient(135deg,#4a0080,#7b00d4);border:none;border-radius:12px;color:#fff;font-family:var(--fd);font-size:15px;font-weight:900;letter-spacing:2px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;">
      <span style="font-size:20px">üîó</span> S√âQUENCE DE PASSE <span class="count" id="cnt-SEQ" style="background:rgba(255,255,255,0.2);color:#fff;font-size:11px;padding:2px 7px;border-radius:10px;min-width:20px;text-align:center">0</span>
    </button>
  </div>
  <!-- MINI TERRAIN INT√âGR√â -->
  <div class="section-title" style="margin-top:16px;">üìç Zone de l'action</div>
  <div id="lastActionBadge" style="text-align:center;font-family:var(--fb);font-size:12px;color:var(--muted);margin-bottom:6px;min-height:18px;">Enregistre une action puis s√©lectionne sa zone</div>
  <div style="position:relative;width:100%;max-width:320px;margin:0 auto 8px auto;">
    <!-- SVG Terrain vertical ‚Äî 3 colonnes √ó 6 rang√©es
         Col gauche : 1(bas)‚Üí16(haut)  |  Col centre : 2‚Üí17  |  Col droite : 3‚Üí18
         Rang√©e 1 (tout bas, d√©fense profonde) : 1-2-3
         Rang√©e 2 : 4-5-6
         Rang√©e 3 (milieu bas) : 7-8-9
         Rang√©e 4 (milieu haut) : 10-11-12
         Rang√©e 5 : 13-14-15
         Rang√©e 6 (tout haut, attaque) : 16-17-18   -->
    <svg id="pitchSvg" viewBox="0 0 192 320" style="width:100%;display:block;border-radius:8px;" xmlns="http://www.w3.org/2000/svg">
      <!-- Fond -->
      <rect width="192" height="320" fill="#265c26" rx="6"/>

      <!-- ‚ïê‚ïê ZONES : 3 cols (64px each) √ó 6 rows (‚âà53px each) ‚ïê‚ïê
           y part de 0 (haut=attaque) √† 320 (bas=d√©fense)
           Rang√©e 6 haut  y:0   h:53  zones 16,17,18  vert fonc√©
           Rang√©e 5       y:53  h:54  zones 13,14,15  vert
           Rang√©e 4       y:107 h:53  zones 10,11,12  vert clair / orange
           Rang√©e 3       y:160 h:54  zones  7, 8, 9  orange
           Rang√©e 2       y:214 h:53  zones  4, 5, 6  rouge clair
           Rang√©e 1 bas   y:267 h:53  zones  1, 2, 3  rouge fonc√©  -->

      <!-- Rang√©e 6 ‚Äî zones 16,17,18 ‚Äî ATTAQUE HAUTE (vert intense) -->
      <rect x="0"   y="0"   width="64" height="53" fill="rgba(56,142,60,0.45)"  class="pitch-zone" onclick="tagZonePitch(16,this)"/>
      <rect x="64"  y="0"   width="64" height="53" fill="rgba(56,142,60,0.45)"  class="pitch-zone" onclick="tagZonePitch(17,this)"/>
      <rect x="128" y="0"   width="64" height="53" fill="rgba(56,142,60,0.45)"  class="pitch-zone" onclick="tagZonePitch(18,this)"/>
      <!-- Rang√©e 5 ‚Äî zones 13,14,15 ‚Äî ATTAQUE (vert moyen) -->
      <rect x="0"   y="53"  width="64" height="54" fill="rgba(76,175,80,0.32)"  class="pitch-zone" onclick="tagZonePitch(13,this)"/>
      <rect x="64"  y="53"  width="64" height="54" fill="rgba(76,175,80,0.32)"  class="pitch-zone" onclick="tagZonePitch(14,this)"/>
      <rect x="128" y="53"  width="64" height="54" fill="rgba(76,175,80,0.32)"  class="pitch-zone" onclick="tagZonePitch(15,this)"/>
      <!-- Rang√©e 4 ‚Äî zones 10,11,12 ‚Äî MILIEU OFFENSIF (orange clair) -->
      <rect x="0"   y="107" width="64" height="53" fill="rgba(251,140,0,0.25)"  class="pitch-zone" onclick="tagZonePitch(10,this)"/>
      <rect x="64"  y="107" width="64" height="53" fill="rgba(251,140,0,0.25)"  class="pitch-zone" onclick="tagZonePitch(11,this)"/>
      <rect x="128" y="107" width="64" height="53" fill="rgba(251,140,0,0.25)"  class="pitch-zone" onclick="tagZonePitch(12,this)"/>
      <!-- Rang√©e 3 ‚Äî zones 7,8,9 ‚Äî MILIEU D√âFENSIF (orange) -->
      <rect x="0"   y="160" width="64" height="54" fill="rgba(251,140,0,0.35)"  class="pitch-zone" onclick="tagZonePitch(7,this)"/>
      <rect x="64"  y="160" width="64" height="54" fill="rgba(251,140,0,0.35)"  class="pitch-zone" onclick="tagZonePitch(8,this)"/>
      <rect x="128" y="160" width="64" height="54" fill="rgba(251,140,0,0.35)"  class="pitch-zone" onclick="tagZonePitch(9,this)"/>
      <!-- Rang√©e 2 ‚Äî zones 4,5,6 ‚Äî D√âFENSE (rouge clair) -->
      <rect x="0"   y="214" width="64" height="53" fill="rgba(229,57,53,0.30)"  class="pitch-zone" onclick="tagZonePitch(4,this)"/>
      <rect x="64"  y="214" width="64" height="53" fill="rgba(229,57,53,0.30)"  class="pitch-zone" onclick="tagZonePitch(5,this)"/>
      <rect x="128" y="214" width="64" height="53" fill="rgba(229,57,53,0.30)"  class="pitch-zone" onclick="tagZonePitch(6,this)"/>
      <!-- Rang√©e 1 ‚Äî zones 1,2,3 ‚Äî D√âFENSE PROFONDE (rouge intense) -->
      <rect x="0"   y="267" width="64" height="53" fill="rgba(198,40,40,0.45)"  class="pitch-zone" onclick="tagZonePitch(1,this)"/>
      <rect x="64"  y="267" width="64" height="53" fill="rgba(198,40,40,0.45)"  class="pitch-zone" onclick="tagZonePitch(2,this)"/>
      <rect x="128" y="267" width="64" height="53" fill="rgba(198,40,40,0.45)"  class="pitch-zone" onclick="tagZonePitch(3,this)"/>

      <!-- ‚ïê‚ïê LIGNES DU TERRAIN ‚ïê‚ïê -->
      <!-- Contour -->
      <rect x="1" y="1" width="190" height="318" fill="none" stroke="rgba(255,255,255,0.75)" stroke-width="1.5" rx="5"/>
      <!-- Ligne m√©diane -->
      <line x1="1" y1="160" x2="191" y2="160" stroke="rgba(255,255,255,0.75)" stroke-width="1.5"/>
      <!-- Cercle central -->
      <circle cx="96" cy="160" r="30" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.2"/>
      <circle cx="96" cy="160" r="2"  fill="rgba(255,255,255,0.8)"/>
      <!-- Surface adverse (haut) -->
      <rect x="44" y="1"   width="104" height="42" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.2"/>
      <rect x="70" y="1"   width="52"  height="18" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1"/>
      <!-- But adverse -->
      <rect x="78" y="0"   width="36"  height="6"  fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.7)" stroke-width="1"/>
      <!-- Surface notre camp (bas) -->
      <rect x="44" y="277" width="104" height="42" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.2"/>
      <rect x="70" y="301" width="52"  height="18" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1"/>
      <!-- Notre but -->
      <rect x="78" y="314" width="36"  height="6"  fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.7)" stroke-width="1"/>
      <!-- Points penalty -->
      <circle cx="96" cy="52"  r="2" fill="rgba(255,255,255,0.6)"/>
      <circle cx="96" cy="268" r="2" fill="rgba(255,255,255,0.6)"/>
      <!-- S√©parateurs verticaux zones (2 lignes pour 3 cols) -->
      <line x1="64"  y1="1" x2="64"  y2="319" stroke="rgba(255,255,255,0.22)" stroke-width="0.8" stroke-dasharray="4,3"/>
      <line x1="128" y1="1" x2="128" y2="319" stroke="rgba(255,255,255,0.22)" stroke-width="0.8" stroke-dasharray="4,3"/>
      <!-- S√©parateurs horizontaux zones (5 lignes pour 6 rang√©es) -->
      <line x1="1" y1="53"  x2="191" y2="53"  stroke="rgba(255,255,255,0.18)" stroke-width="0.8" stroke-dasharray="4,3"/>
      <line x1="1" y1="107" x2="191" y2="107" stroke="rgba(255,255,255,0.22)" stroke-width="1"   stroke-dasharray="4,3"/>
      <line x1="1" y1="214" x2="191" y2="214" stroke="rgba(255,255,255,0.22)" stroke-width="1"   stroke-dasharray="4,3"/>
      <line x1="1" y1="267" x2="191" y2="267" stroke="rgba(255,255,255,0.18)" stroke-width="0.8" stroke-dasharray="4,3"/>

      <!-- ‚ïê‚ïê NUM√âROS ‚ïê‚ïê (centr√© dans chaque zone : cx=32,96,160 / cy=centre rang√©e) -->
      <!-- Rang√©e 6 (y:0-53, cy=26)   ‚Üí 16,17,18 -->
      <text x="32"  y="31" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">16</text>
      <text x="96"  y="31" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">17</text>
      <text x="160" y="31" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">18</text>
      <!-- Rang√©e 5 (y:53-107, cy=80) ‚Üí 13,14,15 -->
      <text x="32"  y="85" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">13</text>
      <text x="96"  y="85" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">14</text>
      <text x="160" y="85" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">15</text>
      <!-- Rang√©e 4 (y:107-160, cy=133) ‚Üí 10,11,12 -->
      <text x="32"  y="138" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">10</text>
      <text x="96"  y="138" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">11</text>
      <text x="160" y="138" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">12</text>
      <!-- Rang√©e 3 (y:160-214, cy=187) ‚Üí 7,8,9 -->
      <text x="32"  y="192" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">7</text>
      <text x="96"  y="192" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">8</text>
      <text x="160" y="192" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.8)">9</text>
      <!-- Rang√©e 2 (y:214-267, cy=240) ‚Üí 4,5,6 -->
      <text x="32"  y="245" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">4</text>
      <text x="96"  y="245" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">5</text>
      <text x="160" y="245" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.85)">6</text>
      <!-- Rang√©e 1 (y:267-320, cy=293) ‚Üí 1,2,3 -->
      <text x="32"  y="298" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">1</text>
      <text x="96"  y="298" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">2</text>
      <text x="160" y="298" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="15" font-weight="900" fill="rgba(255,255,255,0.9)">3</text>

      <!-- Labels -->
      <text x="96" y="14" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="8" font-weight="700" fill="rgba(255,255,255,0.5)" letter-spacing="2">‚öΩ ATTAQUE</text>
      <text x="96" y="313" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-size="8" font-weight="700" fill="rgba(255,255,255,0.5)" letter-spacing="2">üõ° D√âFENSE</text>
    <!-- Overlay confirmation zone -->
    <div id="zoneConfirmOverlay" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,212,255,0.92);color:#0a0e1a;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;padding:8px 18px;border-radius:20px;pointer-events:none;letter-spacing:1px;"></div>
  </div>
  <div id="zonedEventLabel" style="text-align:center;font-family:var(--fb);font-size:11px;color:var(--accent);min-height:16px;margin-bottom:4px;"></div>
</div>

<!-- EFFECTIF -->
<div class="panel" id="panel-effectif">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
    <div class="section-title" style="margin:0;flex:1;">Effectif du match</div>
    <button onclick="openImportCMModal()" style="background:linear-gradient(135deg,#0E5C14,#1A8C23);border:none;border-radius:6px;padding:7px 10px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;">üì• IMPORTER</button>
    <button onclick="openAddPlayerModal()" style="background:var(--accent);border:none;border-radius:8px;padding:7px 12px;color:var(--bg);font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer;letter-spacing:1px;">+ JOUEUR</button>
    <button onclick="openSubModal(null)" style="background:var(--accent2);border:none;border-radius:8px;padding:7px 12px;color:#fff;font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer;letter-spacing:1px;">üîÑ REM.</button>
  </div>
  <div style="display:flex;gap:6px;margin-bottom:12px;" id="rosterFilterBtns">
    <button class="tag sel" onclick="filterRoster('all',this)">Tous</button>
    <button class="tag" onclick="filterRoster('field',this)">üü¢ Terrain</button>
    <button class="tag" onclick="filterRoster('bench',this)">üí∫ Banc</button>
    <button class="tag" onclick="filterRoster('out',this)">üîÑ Sortis</button>
  </div>
  <div class="roster-list" id="rosterList"><div class="empty-log">Aucun joueur ‚Äî ajoute ton effectif</div></div>
  <div class="section-title" style="margin-top:16px;">üîÑ Remplacements</div>
  <div id="subLog"><div class="empty-log">Aucun remplacement</div></div>
</div>

<!-- ADVERSAIRE -->
<!-- ‚ïê‚ïê PANEL CLUB ‚ïê‚ïê -->
<div class="panel" id="panel-club">

  <!-- SOUS-ONGLETS CLUB -->
  <div style="display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;">
    <button class="ctab active" id="ctab-roster" onclick="showClubTab('roster',this)"><span style="font-size:14px;">üë•</span> Effectif</button>
    <button class="ctab" id="ctab-health" onclick="showClubTab('health',this)"><span style="font-size:14px;">üè•</span> Sant√©</button>
    <button class="ctab" id="ctab-stats" onclick="showClubTab('stats',this)"><span style="font-size:14px;">üìä</span> Stats</button>
    <button class="ctab" id="ctab-season" onclick="showClubTab('season',this)"><span style="font-size:14px;">üìÅ</span> Saison</button>
    <button class="ctab" id="ctab-clubcfg" onclick="showClubTab('clubcfg',this)"><span style="font-size:14px;">‚öô</span> Club</button>
  </div>

  <!-- FORMAT SWITCHER -->
  <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;">
    <div style="font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;">Format :</div>
    <button class="dur-btn sel" id="clubFmt11" onclick="setClubFormat(11,this)">Football √† 11</button>
    <button class="dur-btn" id="clubFmt8" onclick="setClubFormat(8,this)">Football √† 8</button>
  </div>

  <!-- CLUB INFO BAR -->
  <div id="clubInfoBar" style="background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:6px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:12px;">
    <div id="clubLogoDisplay" style="width:38px;height:38px;border-radius:7px;background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">‚öΩ</div>
    <div style="flex:1;">
      <div id="clubNameDisplay" style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--text);line-height:1;">MON CLUB</div>
      <div id="clubMetaDisplay" style="font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;">Saison 2025-2026</div>
    </div>
    <div id="clubQuickStats" style="display:flex;gap:12px;"></div>
  </div>

  <!-- SUB-PANELS -->

  <!-- EFFECTIF -->
  <div id="cpanel-roster" class="cpanel active">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
      <div style="display:flex;gap:6px;flex:1;flex-wrap:wrap;">
        <button class="tag sel" id="clf-all" onclick="setClubFilter('all',this)">Tous</button>
        <button class="tag" id="clf-ok" onclick="setClubFilter('ok',this)">‚úì Dispos</button>
        <button class="tag" id="clf-injured" onclick="setClubFilter('injured',this)">üî¥ Bless√©s</button>
        <button class="tag" id="clf-suspended" onclick="setClubFilter('suspended',this)">üü° Suspendus</button>
      </div>
      <button onclick="openClubPlayerModal(null)" style="background:var(--accent);border:none;border-radius:5px;padding:8px 12px;color:#000;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;white-space:nowrap;">+ JOUEUR</button>
    </div>
    <div id="clubRosterList"></div>
  </div>

  <!-- SANT√â -->
  <div id="cpanel-health" class="cpanel">
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <button class="dur-btn sel" id="injt-injured" onclick="setClubInjType('injured',this)">üî¥ Bless√©s</button>
      <button class="dur-btn" id="injt-suspended" onclick="setClubInjType('suspended',this)">üü° Suspendus</button>
      <button class="dur-btn" id="injt-unavailable" onclick="setClubInjType('unavailable',this)">‚ö´ Indispos</button>
    </div>
    <div id="clubHealthList"></div>
    <button onclick="openClubHealthModal()" style="width:100%;margin-top:10px;padding:12px;background:rgba(255,23,68,0.1);border:1px solid rgba(255,23,68,0.2);border-radius:5px;color:var(--red);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">+ D√âCLARER</button>
  </div>

  <!-- STATS -->
  <div id="cpanel-stats" class="cpanel">
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <button class="dur-btn sel" id="scat-buts" onclick="setClubStatCat('buts',this)">‚öΩ Buts</button>
      <button class="dur-btn" id="scat-passes" onclick="setClubStatCat('passes',this)">üéÅ Passes</button>
      <button class="dur-btn" id="scat-matchs" onclick="setClubStatCat('matchs',this)">üìã Matchs</button>
      <button class="dur-btn" id="scat-minutes" onclick="setClubStatCat('minutes',this)">‚è± Minutes</button>
    </div>
    <div id="clubStatsList"></div>
  </div>

  <!-- SAISON -->
  <div id="cpanel-season" class="cpanel">
    <div id="clubSeasonStats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;"></div>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
      <button class="dur-btn sel" id="shf-all" onclick="setClubSeasonFilter('all',this)">Tous</button>
      <button class="dur-btn" id="shf-win" onclick="setClubSeasonFilter('win',this)">‚úÖ Victoires</button>
      <button class="dur-btn" id="shf-draw" onclick="setClubSeasonFilter('draw',this)">„Ä∞ Nuls</button>
      <button class="dur-btn" id="shf-loss" onclick="setClubSeasonFilter('loss',this)">‚ùå D√©faites</button>
    </div>
    <div id="clubSeasonList"></div>
    <button onclick="syncClubFromHistory()" style="width:100%;margin-top:12px;padding:11px;background:rgba(0,184,255,0.1);border:1px solid rgba(0,184,255,0.2);border-radius:5px;color:var(--blue);font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">üîÑ SYNC DEPUIS HISTORIQUE</button>
  </div>

  <!-- CONFIG CLUB -->
  <div id="cpanel-clubcfg" class="cpanel">
    <div class="setup-card">
      <span class="setup-label">Nom du club</span>
      <input class="setup-input" id="cfgClubName" placeholder="Ex: VVM Chauvigny" oninput="saveClubCfg()">
    </div>
    <div class="setup-card">
      <span class="setup-label">Saison</span>
      <input class="setup-input" id="cfgClubSeason" placeholder="Ex: 2025-2026" oninput="saveClubCfg()">
    </div>
    <div class="setup-card">
      <span class="setup-label">Cat√©gorie</span>
      <input class="setup-input" id="cfgClubCategory" placeholder="Ex: U13, Senior, V√©t√©rans‚Ä¶" oninput="saveClubCfg()">
    </div>
    <div class="setup-card">
      <span class="setup-label">Logo (emoji)</span>
      <input class="setup-input" id="cfgClubEmoji" placeholder="üèÜ" maxlength="4" oninput="saveClubCfg()">
    </div>
    <button onclick="resetClubData()" class="btn-danger-full">üóë R√âINITIALISER LES DONN√âES CLUB</button>
  </div>

</div>

<!-- MODAL JOUEUR CLUB -->
<div class="modal-overlay" id="modalClubPlayer">
  <div class="modal">
    <div class="modal-title" id="clubPlayerModalTitle">NOUVEAU JOUEUR</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div><label class="modal-label">Pr√©nom</label><input class="modal-input" id="cpPrenom" placeholder="Pr√©nom"></div>
      <div><label class="modal-label">Nom</label><input class="modal-input" id="cpNom" placeholder="Nom"></div>
    </div>
    <div style="display:grid;grid-template-columns:80px 1fr;gap:8px;">
      <div><label class="modal-label">N¬∞</label><input class="modal-input" id="cpNum" placeholder="7" type="number"></div>
      <div><label class="modal-label">Poste</label>
        <select class="modal-select" id="cpPoste">
          <option value="Gardien">Gardien</option>
          <option value="D√©fenseur central">D√©fenseur central</option>
          <option value="Lat√©ral gauche">Lat√©ral gauche</option>
          <option value="Lat√©ral droit">Lat√©ral droit</option>
          <option value="Milieu d√©fensif">Milieu d√©fensif</option>
          <option value="Milieu central">Milieu central</option>
          <option value="Milieu offensif">Milieu offensif</option>
          <option value="Ailier gauche">Ailier gauche</option>
          <option value="Ailier droit">Ailier droit</option>
          <option value="Attaquant">Attaquant</option>
        </select>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div><label class="modal-label">Cat√©gorie</label>
        <select class="modal-select" id="cpCat">
          <option>U7</option><option>U8</option><option>U9</option><option>U10</option>
          <option>U11</option><option>U12</option><option>U13</option><option>U14</option>
          <option>U15</option><option>U16</option><option>U17</option><option>U18</option>
          <option>U19</option><option>U21</option><option selected>Senior</option><option>V√©t√©ran</option>
        </select>
      </div>
      <div><label class="modal-label">Pied fort</label>
        <select class="modal-select" id="cpPied">
          <option value="D">Droit</option><option value="G">Gauche</option><option value="B">Les deux</option>
        </select>
      </div>
    </div>
    <label class="modal-label">Stats saison (manuel)</label>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px;">
      <div style="text-align:center;"><div style="font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:3px;">MJ</div><input class="modal-input" id="cpMj" type="number" min="0" value="0" style="text-align:center;padding:8px 4px;"></div>
      <div style="text-align:center;"><div style="font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:3px;">BUTS</div><input class="modal-input" id="cpButs" type="number" min="0" value="0" style="text-align:center;padding:8px 4px;"></div>
      <div style="text-align:center;"><div style="font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:3px;">PASSES</div><input class="modal-input" id="cpPasses" type="number" min="0" value="0" style="text-align:center;padding:8px 4px;"></div>
      <div style="text-align:center;"><div style="font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:3px;">MIN</div><input class="modal-input" id="cpMinutes" type="number" min="0" value="0" style="text-align:center;padding:8px 4px;"></div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn-modal-cancel" onclick="closeModal('modalClubPlayer')">Annuler</button>
      <button class="btn-modal-confirm" onclick="saveClubPlayer()">üíæ ENREGISTRER</button>
    </div>
    <button id="btnDeleteClubPlayer" onclick="deleteClubPlayer()" style="display:none;width:100%;margin-top:8px;padding:11px;background:rgba(255,23,68,0.1);border:1px solid rgba(255,23,68,0.2);border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--red);cursor:pointer;">üóë SUPPRIMER CE JOUEUR</button>
  </div>
</div>

<!-- MODAL SANT√â CLUB -->
<div class="modal-overlay" id="modalClubHealth">
  <div class="modal">
    <div class="modal-title">D√âCLARER INDISPO</div>
    <label class="modal-label">Joueur</label>
    <select class="modal-select" id="chPlayer"></select>
    <label class="modal-label">Statut</label>
    <div class="option-row">
      <button class="opt-btn sel" id="chs-injured" onclick="setClubHealthStatus('injured',this)">üî¥ Bless√©</button>
      <button class="opt-btn" id="chs-suspended" onclick="setClubHealthStatus('suspended',this)">üü° Suspendu</button>
      <button class="opt-btn" id="chs-unavailable" onclick="setClubHealthStatus('unavailable',this)">‚ö´ Indisponible</button>
    </div>
    <label class="modal-label">Note / d√©tail</label>
    <input class="modal-input" id="chNote" placeholder="Ex: Cheville droite, 3 matchs de suspension‚Ä¶">
    <label class="modal-label">Date de retour estim√©e</label>
    <input class="modal-input" id="chRetour" type="date">
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalClubHealth')">Annuler</button>
      <button class="btn-modal-confirm" onclick="saveClubHealth()">‚úÖ VALIDER</button>
    </div>
  </div>
</div>


<div class="panel" id="panel-adversaire">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
    <div class="section-title" style="margin:0;flex:1;">Joueurs adverses</div>
    <button onclick="openAddOppModal()" style="background:var(--red);border:none;border-radius:8px;padding:7px 12px;color:#fff;font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer;letter-spacing:1px;">+ JOUEUR ADV</button>
  </div>
  <div style="font-family:var(--fd);font-size:11px;color:var(--muted);letter-spacing:1px;margin-bottom:10px;line-height:1.6;">
    Saisis les joueurs adverses pour les associer aux buts encaiss√©s, cartons et actions cl√©s.
  </div>
  <div class="roster-list" id="oppRosterList"><div class="empty-log">Aucun joueur adverse saisi</div></div>

  <div class="section-title" style="margin-top:16px;">üìã √âv√©nements adverses</div>
  <div id="oppEventLog"><div class="empty-log">Aucun √©v√©nement adverse</div></div>
</div>

<!-- TACTIQUE -->
<div class="panel" id="panel-tactique">
  <div class="section-title" style="margin-top:0;">Format de jeu</div>
  <div class="format-tabs">
    <button class="format-tab active" onclick="setFormat(11,this)">‚öΩ Football √† 11</button>
    <button class="format-tab" onclick="setFormat(8,this)">‚öΩ Football √† 8</button>
  </div>
  <div class="section-title">üìã Notre tactique</div>
  <div class="tactic-grid" id="tacticGrid"></div>
  <div id="tacticDetails" style="display:none;">
    <div class="section-title">Visualisation terrain</div>
    <div class="pitch-container" id="pitchContainer">
      <svg class="pitch-svg" viewBox="0 0 300 420" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="300" height="420" fill="#2a5e1e"/>
        <rect x="10" y="10" width="280" height="400" rx="2" stroke="#3d8c2a" stroke-width="2" fill="none"/>
        <line x1="10" y1="210" x2="290" y2="210" stroke="#3d8c2a" stroke-width="1.5"/>
        <circle cx="150" cy="210" r="35" stroke="#3d8c2a" stroke-width="1.5" fill="none"/>
        <circle cx="150" cy="210" r="2.5" fill="#3d8c2a"/>
        <rect x="65" y="10" width="170" height="55" stroke="#3d8c2a" stroke-width="1.5" fill="none"/>
        <rect x="105" y="10" width="90" height="22" stroke="#3d8c2a" stroke-width="1.5" fill="none"/>
        <rect x="65" y="355" width="170" height="55" stroke="#3d8c2a" stroke-width="1.5" fill="none"/>
        <rect x="105" y="398" width="90" height="22" stroke="#3d8c2a" stroke-width="1.5" fill="none"/>
        <rect x="118" y="4" width="64" height="8" stroke="rgba(255,255,255,0.4)" stroke-width="1" fill="rgba(255,255,255,0.07)"/>
        <rect x="118" y="408" width="64" height="8" stroke="rgba(255,255,255,0.4)" stroke-width="1" fill="rgba(255,255,255,0.07)"/>
      </svg>
      <div id="playerTokens" style="position:absolute;inset:0;"></div>
    </div>
    <div id="selectedTacticLabel" style="text-align:center;font-family:var(--fd);font-size:14px;color:var(--accent);letter-spacing:2px;margin-top:6px;font-weight:700;text-transform:uppercase;"></div>

    <!-- CHANGEMENT EN COURS DE MATCH -->
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:14px;">
      <div style="font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:2px;color:var(--accent2);text-transform:uppercase;margin-bottom:8px;">üîÑ Changer de tactique en cours de match</div>
      <div style="font-family:var(--fb);font-size:12px;color:var(--muted);margin-bottom:10px;">Adapte-toi : expulsion, retard au score, tenir un r√©sultat‚Ä¶</div>
      <div class="tactic-grid" id="tacticGridChange" style="margin-bottom:8px;"></div>
      <div id="changeTacticReason" style="margin-bottom:8px;display:none;">
        <div style="font-family:var(--fd);font-size:11px;color:var(--muted);letter-spacing:1px;margin-bottom:6px;">RAISON DU CHANGEMENT (optionnel)</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="tag" id="ctr_exp" onclick="selectChangeTacticReason('Expulsion d√©finitive')">üü• Expulsion</button>
          <button class="tag" id="ctr_exc" onclick="selectChangeTacticReason('Exclusion temporaire')">‚¨ú Exclusion</button>
          <button class="tag" id="ctr_ret" onclick="selectChangeTacticReason('Retard au score')">‚¨á Retard</button>
          <button class="tag" id="ctr_avance" onclick="selectChangeTacticReason('Tenir l\'avance')">üõ° Tenir avance</button>
          <button class="tag" id="ctr_adj" onclick="selectChangeTacticReason('Ajustement tactique')">üéØ Ajustement</button>
        </div>
      </div>
      <button id="btnConfirmTacticChange" style="display:none;width:100%;padding:10px;background:linear-gradient(135deg,var(--accent2),#ff8c42);border:none;border-radius:8px;color:#fff;font-family:var(--fd);font-size:13px;font-weight:900;letter-spacing:1px;cursor:pointer;" onclick="confirmTacticChange()">‚úì APPLIQUER CE CHANGEMENT</button>
    </div>

    <!-- TACTIQUE ADVERSE -->
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:10px;">
      <div style="font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:2px;color:var(--red);text-transform:uppercase;margin-bottom:8px;">üî¥ Tactique adverse estim√©e</div>
      <div class="tactic-grid" id="tacticGridOpp"></div>
      <div id="oppTacticLabel" style="text-align:center;font-family:var(--fd);font-size:13px;color:var(--red);letter-spacing:1px;margin-top:6px;min-height:18px;"></div>
    </div>
  </div>
</div>

<!-- TERRAIN -->
<!-- LOG -->
<div class="panel" id="panel-log">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
    <div class="section-title" style="margin:0">Journal des √©v√©nements</div>
    <button onclick="clearLog()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:4px 10px;color:var(--muted);font-family:var(--fd);font-size:11px;cursor:pointer;letter-spacing:1px;">EFFACER</button>
  </div>
  <ul class="log-list" id="logList"><li class="empty-log">Aucun √©v√©nement</li></ul>
</div>

<!-- NOTES -->
<div class="panel" id="panel-notes">
  <div class="section-title">Notes 1√®re mi-temps</div>
  <textarea class="notes-area" id="notes1" placeholder="Observations tactiques, joueurs √† surveiller, instructions..."></textarea>
  <div class="section-title" style="margin-top:14px;">Notes 2√®me mi-temps</div>
  <textarea class="notes-area" id="notes2" placeholder="Ajustements, r√©actions adverses, remplacements √† pr√©voir..."></textarea>
  <div class="section-title" style="margin-top:14px;">M√©mo rapide</div>
  <div class="tag-row">
    <button class="tag" onclick="addNote('Bloc d√©fensif trop √©clat√©. ')">Bloc √©clat√©</button>
    <button class="tag" onclick="addNote('Pressing √† augmenter. ')">+ Pressing</button>
    <button class="tag" onclick="addNote('Transitions trop lentes. ')">Transitions lentes</button>
    <button class="tag" onclick="addNote('C√¥t√© droit peu utilis√©. ')">C√¥t√© D inactif</button>
    <button class="tag" onclick="addNote('C√¥t√© gauche peu utilis√©. ')">C√¥t√© G inactif</button>
    <button class="tag" onclick="addNote('Sortie de balle propre. ')">Sortie propre</button>
    <button class="tag" onclick="addNote('Duels a√©riens domin√©s. ')">A√©riens ‚úì</button>
    <button class="tag" onclick="addNote('Trop de pertes au milieu. ')">Pertes milieu</button>
    <button class="tag" onclick="addNote('Rempla√ßant √† pr√©parer. ')">Remplacement</button>
  </div>
</div>

<!-- RAPPORT -->
<div class="panel" id="panel-rapport">
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button onclick="showRapportTab('summary')" id="rtab-summary" style="flex:1;padding:9px;background:var(--accent);border:none;border-radius:8px;color:#000;font-family:var(--fd);font-size:11px;font-weight:900;cursor:pointer;letter-spacing:1px;">üìã R√âSUM√â</button>
    <button onclick="showRapportTab('analyse')" id="rtab-analyse" style="flex:1;padding:9px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--fd);font-size:11px;font-weight:900;cursor:pointer;letter-spacing:1px;">üî¨ ANALYSE</button>
    <button onclick="showRapportTab('heatmap')" id="rtab-heatmap" style="flex:1;padding:9px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--fd);font-size:11px;font-weight:900;cursor:pointer;letter-spacing:1px;">üå° CHALEUR</button>
  </div>
  <div id="rapport-summary">
    <div class="section-title" style="margin-top:0;">R√©sum√© du match</div>
    <div id="rapportContent"></div>
    <button class="btn-export" onclick="exportReport()">üìã EXPORTER LE RAPPORT</button>
  </div>
  <div id="rapport-analyse" style="display:none"></div>
  <div id="rapport-heatmap" style="display:none"></div>
</div>

<!-- HISTORIQUE -->
<div class="panel" id="panel-historique">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
    <div class="section-title" style="margin:0;flex:1" id="histoTitle">Historique</div>
    <button onclick="archiveCurrentMatch()" style="background:var(--green);border:none;border-radius:8px;padding:7px 12px;color:#000;font-family:var(--fd);font-size:12px;font-weight:900;cursor:pointer">&#128190; ARCHIVER</button>
  </div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px" id="histoFilters"></div>
  <div id="histoSeasonStats"></div>
  <div id="histoList"></div>
  <div id="histoDetail" style="display:none"></div>
  <div id="histoCompare" style="display:none"></div>
</div>

<!-- SETUP -->
<div class="panel" id="panel-setup">
  <div class="setup-card">
    <div class="section-title" style="margin-top:0">√âquipes</div>
    <div class="input-row"><div class="input-label">Ton √©quipe</div><input class="input-field" id="setupHome" type="text" placeholder="Ex: FC Lyon" maxlength="20"></div>
    <div class="input-row"><div class="input-label">Adversaire</div><input class="input-field" id="setupAway" type="text" placeholder="Ex: AS Montpellier" maxlength="20"></div>
    <div class="input-row"><div class="input-label">Comp√©tition / Date</div><input class="input-field" id="setupComp" type="text" placeholder="Ex: Championnat J12"></div>
    <div class="input-row" style="margin-top:8px;">
      <div class="input-label">Lieu du match</div>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="dur-btn sel" id="loc-domicile" onclick="setMatchLocation('domicile',this)">üè† Domicile</button>
        <button class="dur-btn" id="loc-exterieur" onclick="setMatchLocation('exterieur',this)">‚úàÔ∏è Ext√©rieur</button>
        <button class="dur-btn" id="loc-neutre" onclick="setMatchLocation('neutre',this)">‚öñÔ∏è Neutre</button>
      </div>
    </div>
    <button class="btn-modal-confirm" style="width:100%;margin-top:8px;" onclick="applySetup()">‚úì APPLIQUER</button>
  </div>
  <div class="setup-card">
    <div class="section-title" style="margin-top:0">Dur√©e des mi-temps</div>
    <div class="tag-row">
      <button class="tag sel" id="dur-45" onclick="setHalfDuration(45,this)">45 min</button>
      <button class="tag" id="dur-40" onclick="setHalfDuration(40,this)">40 min</button>
      <button class="tag" id="dur-35" onclick="setHalfDuration(35,this)">35 min</button>
      <button class="tag" id="dur-30" onclick="setHalfDuration(30,this)">30 min</button>
    </div>
  </div>
  <div class="setup-card">
    <div class="section-title" style="margin-top:0">R√©initialisation</div>
    <button onclick="fullReset()" style="width:100%;padding:13px;background:linear-gradient(135deg,#7b0000,#cc0000);border:none;border-radius:10px;color:#fff;font-family:var(--fd);font-weight:900;font-size:14px;letter-spacing:2px;cursor:pointer;">‚ö†Ô∏è NOUVEAU MATCH</button>
  </div>
</div>

<!-- MODAL IMPORT CLUB MANAGER -->
<div class="modal-overlay" id="modalImportCM">
  <div class="modal">
    <div class="modal-title">üì• IMPORTER EFFECTIF</div>
    <div id="importCMClubSelect" style="margin-bottom:12px;"></div>
    <div id="importCMPlayerList"></div>
    <div id="importCMNote" style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--muted);margin-bottom:8px;"></div>
    <div style="margin:10px 0 6px;">
      <span style="font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Statut :</span>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="importStatusBtn sel" id="ist-field" onclick="setImportStatus('field',this)">üü¢ Terrain</button>
        <button class="importStatusBtn" id="ist-bench" onclick="setImportStatus('bench',this)">üí∫ Banc</button>
      </div>
    </div>
    <div id="importCMCount" style="font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--muted);margin:6px 0;"></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalImportCM')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmImportCM()">‚úÖ IMPORTER</button>
    </div>
  </div>
</div>

<!-- MODAL S√âQUENCE DE PASSE -->
<div class="modal-overlay" id="modalSeq">
  <div class="modal" style="max-height:85vh;overflow-y:auto;">
    <div class="modal-title">üîó S√©quence de passe</div>
    <div id="seqChain" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;margin-bottom:12px;padding:8px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);align-items:center;">
      <span id="seqChainEmpty" style="font-family:var(--fd);font-size:11px;color:var(--muted)">Ajoute des joueurs ci-dessous...</span>
    </div>
    <div style="font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;">JOUEURS SUR LE TERRAIN</div>
    <div id="seqPlayerBtns" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button onclick="seqMarkLost()" style="flex:1;padding:10px;background:rgba(255,68,68,0.15);border:1px solid rgba(255,68,68,0.4);border-radius:8px;color:var(--red);font-family:var(--fd);font-size:12px;font-weight:900;cursor:pointer;">üíî PASSE RAT√âE (dernier)</button>
      <button onclick="seqUndo()" style="flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--fd);font-size:12px;font-weight:900;cursor:pointer;">‚Ü© ANNULER</button>
    </div>
    <div style="font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:6px;">R√âSULTAT DE LA S√âQUENCE</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;">
      <button class="seqEndBtn sel" id="seqEnd-none" onclick="setSeqEnd('none',this)">‚èπ En cours / Sans suite</button>
      <button class="seqEndBtn" id="seqEnd-but" onclick="setSeqEnd('but',this)">‚öΩ BUT !</button>
      <button class="seqEndBtn" id="seqEnd-tir" onclick="setSeqEnd('tir',this)">üéØ Tir cadr√©</button>
      <button class="seqEndBtn" id="seqEnd-occasion" onclick="setSeqEnd('occasion',this)">üî• Occasion</button>
      <button class="seqEndBtn" id="seqEnd-centre" onclick="setSeqEnd('centre',this)">üìê Centre</button>
      <button class="seqEndBtn" id="seqEnd-perte" onclick="setSeqEnd('perte',this)">üíî Perte de balle</button>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalSeq')">‚úï Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmSeq()">‚úì VALIDER</button>
    </div>
  </div>
</div>

<!-- MODAL ACTION G√âN√âRIQUE -->
<div class="modal-overlay" id="modalAction">
  <div class="modal">
    <div class="modal-title" id="actionModalTitle">Action</div>
    <div class="input-row">
      <div class="input-label" id="actionLabel1">Joueur</div>
      <select class="input-field" id="actionPlayer1"></select>
    </div>
    <div class="input-row" id="actionRow2" style="display:none;">
      <div class="input-label" id="actionLabel2">Passeur</div>
      <select class="input-field" id="actionPlayer2"></select>
    </div>
    <!-- Raccourcis joueurs fr√©quents -->
    <div id="actionQuickBtns" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;"></div>
    <div style="font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;margin-top:8px;">S√©lectionne un joueur ou enregistre sans joueur ¬∑ Annuler = rien n'est enregistr√©</div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalAction')" style="flex:1;">‚úï Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmActionModal(false)" style="flex:1;background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans joueur</button>
      <button class="btn-modal-confirm" onclick="confirmActionModal(true)" style="flex:1.5;">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL BUT -->
<div class="modal-overlay" id="modalGoal">
  <div class="modal">
    <div class="modal-title">üü¢ But marqu√© !</div>
    <div class="input-row"><div class="input-label">Buteur</div><select class="input-field" id="goalScorerSelect"></select></div>
    <div class="input-row"><div class="input-label">Passeur (optionnel)</div><select class="input-field" id="goalAssistSelect"></select></div>

    <!-- Partie du corps -->
    <div class="input-label" style="margin-bottom:6px;">Comment ?</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="tag" id="bodyPied_d" onclick="selectBodyPart('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="bodyPied_g" onclick="selectBodyPart('Pied gauche')">ü¶µ Pied gauche</button>
      <button class="tag" id="bodyTete" onclick="selectBodyPart('T√™te')">ü§ï T√™te</button>
    </div>

    <!-- Sch√©ma but 6 zones -->
    <div class="input-label" style="margin-bottom:6px;">Zone du but</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="gz1" onclick="selectGoalZone(1)">HG</button>
        <button class="goal-zone" id="gz2" onclick="selectGoalZone(2)">HC</button>
        <button class="goal-zone" id="gz3" onclick="selectGoalZone(3)">HD</button>
        <button class="goal-zone" id="gz4" onclick="selectGoalZone(4)">BG</button>
        <button class="goal-zone" id="gz5" onclick="selectGoalZone(5)">BC</button>
        <button class="goal-zone" id="gz6" onclick="selectGoalZone(6)">BD</button>
      </div>
    </div>

    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalGoal')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmGoal()">‚úì ENREGISTRER</button>
    </div>
  </div>
</div>

<!-- MODAL CARTON -->
<div class="modal-overlay" id="modalCard">
  <div class="modal">
    <div class="modal-title" id="cardModalTitle">Carton</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag sel" id="cardTeamOwn" onclick="switchCardTeam('own')">üü¢ Notre joueur</button>
      <button class="tag" id="cardTeamOpp" onclick="switchCardTeam('opp')">üî¥ Adversaire</button>
    </div>
    <div class="input-row"><div class="input-label">Joueur</div><select class="input-field" id="cardPlayerSelect"></select></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalCard')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmCard()">‚úì ENREGISTRER</button>
    </div>
  </div>
</div>

<!-- MODAL CARTON BLANC -->
<div class="modal-overlay" id="modalCartonBlanc">
  <div class="modal">
    <div class="modal-title">‚¨ú Carton blanc ‚Äî Exclusion 10 min</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag sel" id="cbTeamOwn" onclick="switchCbTeam('own')">üü¢ Notre joueur</button>
      <button class="tag" id="cbTeamOpp" onclick="switchCbTeam('opp')">üî¥ Adversaire</button>
    </div>
    <div class="input-row"><div class="input-label">Joueur</div><select class="input-field" id="cbPlayerSelect"></select></div>
    <div id="cbPlaytimeNote" style="font-family:var(--fb);font-size:12px;color:var(--yellow);margin-bottom:8px;display:none;">‚è± Le temps de jeu sera suspendu pendant 10 min</div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalCartonBlanc')">Annuler</button>
      <button class="btn-modal-confirm" style="background:#9e9e9e;color:#111;" onclick="confirmCartonBlanc()">‚úì ENREGISTRER</button>
    </div>
  </div>
</div>

<!-- MODAL REMPLACEMENT -->
<div class="modal-overlay" id="modalSub">
  <div class="modal">
    <div class="modal-title">üîÑ Remplacement</div>
    <div class="input-row"><div class="input-label">üî¥ Joueur qui sort</div><select class="input-field" id="subOutSelect"></select></div>
    <div class="input-row"><div class="input-label">üü¢ Joueur qui entre</div><select class="input-field" id="subInSelect"></select></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalSub')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmSub()">‚úì VALIDER</button>
    </div>
  </div>
</div>

<!-- MODAL AJOUTER JOUEUR -->
<div class="modal-overlay" id="modalAddPlayer">
  <div class="modal">
    <div class="modal-title">‚ûï Ajouter un joueur</div>
    <div class="input-row"><div class="input-label">Num√©ro</div><input class="input-field" id="newPlayerNum" type="number" placeholder="Ex: 9" min="1" max="99"></div>
    <div class="input-row"><div class="input-label">Nom</div><input class="input-field" id="newPlayerName" type="text" placeholder="Ex: Dupont"></div>
    <div class="input-row"><div class="input-label">Poste</div>
      <select class="input-field" id="newPlayerPos">
        <option value="GK">Gardien (GK)</option>
        <option value="DC">D√©fenseur Central (DC)</option>
        <option value="DL">D√©fenseur Lat√©ral G (DL)</option>
        <option value="DR">D√©fenseur Lat√©ral D (DR)</option>
        <option value="MDC">Milieu D√©fensif (MDC)</option>
        <option value="MC">Milieu Central (MC)</option>
        <option value="MO">Milieu Offensif (MO)</option>
        <option value="MG">Milieu Gauche (MG)</option>
        <option value="MD">Milieu Droit (MD)</option>
        <option value="AG">Ailier Gauche (AG)</option>
        <option value="AD">Ailier Droit (AD)</option>
        <option value="ATT">Attaquant (ATT)</option>
      </select>
    </div>
    <div class="input-row"><div class="input-label">Statut initial</div>
      <select class="input-field" id="newPlayerStatus">
        <option value="field">Sur le terrain</option>
        <option value="bench">Banc</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalAddPlayer')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmAddPlayer()">‚úì AJOUTER</button>
    </div>
  </div>
</div>

<!-- MODAL BUT ENCAISS√â -->
<div class="modal-overlay" id="modalOppGoal">
  <div class="modal">
    <div class="modal-title">üî¥ But encaiss√©</div>
    <div class="input-row"><div class="input-label">Buteur adverse (optionnel)</div><select class="input-field" id="oppGoalScorerSelect"></select></div>
    <div class="input-row"><div class="input-label">Passeur adverse (optionnel)</div><select class="input-field" id="oppGoalAssistSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Comment ?</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag" id="ogPied_d" onclick="selectOgBody('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="ogPied_g" onclick="selectOgBody('Pied gauche')">ü¶µ Pied gauche</button>
      <button class="tag" id="ogTete" onclick="selectOgBody('T√™te')">ü§ï T√™te</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Zone du but</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="oggz1" onclick="selectOgZone(1)">HG</button>
        <button class="goal-zone" id="oggz2" onclick="selectOgZone(2)">HC</button>
        <button class="goal-zone" id="oggz3" onclick="selectOgZone(3)">HD</button>
        <button class="goal-zone" id="oggz4" onclick="selectOgZone(4)">BG</button>
        <button class="goal-zone" id="oggz5" onclick="selectOgZone(5)">BC</button>
        <button class="goal-zone" id="oggz6" onclick="selectOgZone(6)">BD</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalOppGoal')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmOppGoalEnriched(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" style="background:var(--red);" onclick="confirmOppGoalEnriched(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL AJOUTER JOUEUR ADVERSE -->
<div class="modal-overlay" id="modalAddOpp">
  <div class="modal">
    <div class="modal-title">‚ûï Joueur adverse</div>
    <div class="input-row"><div class="input-label">Num√©ro</div><input class="input-field" id="newOppNum" type="number" placeholder="Ex: 10" min="1" max="99"></div>
    <div class="input-row"><div class="input-label">Nom (ou surnom)</div><input class="input-field" id="newOppName" type="text" placeholder="Ex: Dubois"></div>
    <div class="input-row"><div class="input-label">Poste</div>
      <select class="input-field" id="newOppPos">
        <option value="GK">Gardien (GK)</option>
        <option value="DC">D√©fenseur Central (DC)</option>
        <option value="DL">D√©fenseur Lat√©ral G (DL)</option>
        <option value="DR">D√©fenseur Lat√©ral D (DR)</option>
        <option value="MDC">Milieu D√©fensif (MDC)</option>
        <option value="MC">Milieu Central (MC)</option>
        <option value="MO">Milieu Offensif (MO)</option>
        <option value="MG">Milieu Gauche (MG)</option>
        <option value="MD">Milieu Droit (MD)</option>
        <option value="AG">Ailier Gauche (AG)</option>
        <option value="AD">Ailier Droit (AD)</option>
        <option value="ATT">Attaquant (ATT)</option>
      </select>
    </div>
    <div class="input-row"><div class="input-label">Note rapide (optionnel)</div><input class="input-field" id="newOppNote" type="text" placeholder="Ex: Rapide, danger sur les c√¥t√©s"></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalAddOpp')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmAddOpp()">‚úì AJOUTER</button>
    </div>
  </div>
</div>

<!-- MODAL √âDITION JOUEUR ADVERSE -->
<div class="modal-overlay" id="modalEditOpp">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Modifier joueur adverse</div>
    <input type="hidden" id="editOppId">
    <div class="input-row"><div class="input-label">Num√©ro</div><input class="input-field" id="editOppNum" type="number" min="1" max="99"></div>
    <div class="input-row"><div class="input-label">Nom</div><input class="input-field" id="editOppName" type="text"></div>
    <div class="input-row"><div class="input-label">Poste</div>
      <select class="input-field" id="editOppPos">
        <option value="GK">Gardien (GK)</option>
        <option value="DC">D√©fenseur Central (DC)</option>
        <option value="DL">D√©fenseur Lat√©ral G (DL)</option>
        <option value="DR">D√©fenseur Lat√©ral D (DR)</option>
        <option value="MDC">Milieu D√©fensif (MDC)</option>
        <option value="MC">Milieu Central (MC)</option>
        <option value="MO">Milieu Offensif (MO)</option>
        <option value="MG">Milieu Gauche (MG)</option>
        <option value="MD">Milieu Droit (MD)</option>
        <option value="AG">Ailier Gauche (AG)</option>
        <option value="AD">Ailier Droit (AD)</option>
        <option value="ATT">Attaquant (ATT)</option>
      </select>
    </div>
    <div class="input-row"><div class="input-label">Note rapide</div><input class="input-field" id="editOppNote" type="text" placeholder="Observations..."></div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" style="background:linear-gradient(135deg,#7b0000,#cc0000);color:#fff;border:none;flex:1;" onclick="deleteOpp(parseInt(document.getElementById('editOppId').value))">üóë</button>
      <button class="btn-modal-cancel" onclick="closeModal('modalEditOpp')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmEditOpp()">‚úì SAUVER</button>
    </div>
  </div>
</div>

<!-- MODAL PENALTY MARQU√â -->
<div class="modal-overlay" id="modalPenaltyMarque">
  <div class="modal">
    <div class="modal-title">‚öΩ Penalty marqu√© !</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="pmTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Pied</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag" id="pmPied_d" onclick="selectPmPied('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="pmPied_g" onclick="selectPmPied('Pied gauche')">ü¶µ Pied gauche</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Zone du but</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="pmgz1" onclick="selectPmZone(1)">HG</button>
        <button class="goal-zone" id="pmgz2" onclick="selectPmZone(2)">HC</button>
        <button class="goal-zone" id="pmgz3" onclick="selectPmZone(3)">HD</button>
        <button class="goal-zone" id="pmgz4" onclick="selectPmZone(4)">BG</button>
        <button class="goal-zone" id="pmgz5" onclick="selectPmZone(5)">BC</button>
        <button class="goal-zone" id="pmgz6" onclick="selectPmZone(6)">BD</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalPenaltyMarque')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmPenaltyMarque(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmPenaltyMarque(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL PENALTY ARR√äT√â -->
<div class="modal-overlay" id="modalPenaltyArrete">
  <div class="modal">
    <div class="modal-title">üß§ Penalty arr√™t√© !</div>
    <div class="input-row"><div class="input-label">Gardien</div><select class="input-field" id="paTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Comment arr√™t√© ?</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
      <button class="tag" id="paMain_d" onclick="selectPaType('Main droite')">ü§ö Main droite</button>
      <button class="tag" id="paMain_g" onclick="selectPaType('Main gauche')">ü§ö Main gauche</button>
      <button class="tag" id="paDeuxMains" onclick="selectPaType('Deux mains')">üôå Deux mains</button>
      <button class="tag" id="paPied" onclick="selectPaType('Pied')">ü¶µ Pied</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Zone du but (o√π le tir √©tait dirig√©)</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="pagz1" onclick="selectPaZone(1)">HG</button>
        <button class="goal-zone" id="pagz2" onclick="selectPaZone(2)">HC</button>
        <button class="goal-zone" id="pagz3" onclick="selectPaZone(3)">HD</button>
        <button class="goal-zone" id="pagz4" onclick="selectPaZone(4)">BG</button>
        <button class="goal-zone" id="pagz5" onclick="selectPaZone(5)">BC</button>
        <button class="goal-zone" id="pagz6" onclick="selectPaZone(6)">BD</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalPenaltyArrete')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmPenaltyArrete(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmPenaltyArrete(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL TIR CADR√â -->
<div class="modal-overlay" id="modalTirCadre">
  <div class="modal">
    <div class="modal-title">üéØ Tir cadr√©</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="tcTireurSelect"></select></div>
    <div class="input-row"><div class="input-label">Passeur (optionnel)</div><select class="input-field" id="tcPasseurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Pied / T√™te</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag" id="tcPied_d" onclick="selectTcBody('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="tcPied_g" onclick="selectTcBody('Pied gauche')">ü¶µ Pied gauche</button>
      <button class="tag" id="tcTete" onclick="selectTcBody('T√™te')">ü§ï T√™te</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Zone du but</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="tcgz1" onclick="selectTcZone(1)">HG</button>
        <button class="goal-zone" id="tcgz2" onclick="selectTcZone(2)">HC</button>
        <button class="goal-zone" id="tcgz3" onclick="selectTcZone(3)">HD</button>
        <button class="goal-zone" id="tcgz4" onclick="selectTcZone(4)">BG</button>
        <button class="goal-zone" id="tcgz5" onclick="selectTcZone(5)">BC</button>
        <button class="goal-zone" id="tcgz6" onclick="selectTcZone(6)">BD</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalTirCadre')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmTirCadre(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmTirCadre(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL TIR RAT√â -->
<div class="modal-overlay" id="modalTirRate">
  <div class="modal">
    <div class="modal-title">‚ÜóÔ∏è Tir non cadr√©</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="trTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Destination du tir</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;">
      <div style="display:flex;gap:6px;">
        <button class="tag" id="tr_cote_g" onclick="selectTrDest('√Ä c√¥t√© gauche')" style="flex:1;text-align:center;">‚óÄ √Ä c√¥t√© gauche</button>
        <button class="tag" id="tr_dessus" onclick="selectTrDest('Au-dessus')" style="flex:1;text-align:center;">‚¨Ü Au-dessus</button>
        <button class="tag" id="tr_cote_d" onclick="selectTrDest('√Ä c√¥t√© droit')" style="flex:1;text-align:center;">√Ä c√¥t√© droit ‚ñ∂</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="tr_poteau_g" onclick="selectTrDest('Poteau gauche')" style="flex:1;text-align:center;">üü° Poteau gauche</button>
        <button class="tag" id="tr_poteau_d" onclick="selectTrDest('Poteau droit')" style="flex:1;text-align:center;">üü° Poteau droit</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="tr_barre" onclick="selectTrDest('Barre transversale')" style="flex:1;text-align:center;">üü° Barre transversale</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalTirRate')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmTirRate(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmTirRate(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL PENALTY RAT√â OFFENSIF -->
<div class="modal-overlay" id="modalPenaltyRateOff">
  <div class="modal">
    <div class="modal-title">‚ùå Penalty rat√©</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="proTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Destination du tir</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;">
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pro_cote_g" onclick="selectProDest('√Ä c√¥t√© gauche')" style="flex:1;text-align:center;">‚óÄ √Ä c√¥t√© gauche</button>
        <button class="tag" id="pro_dessus" onclick="selectProDest('Au-dessus')" style="flex:1;text-align:center;">‚¨Ü Au-dessus</button>
        <button class="tag" id="pro_cote_d" onclick="selectProDest('√Ä c√¥t√© droit')" style="flex:1;text-align:center;">√Ä c√¥t√© droit ‚ñ∂</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pro_poteau_g" onclick="selectProDest('Poteau gauche')" style="flex:1;text-align:center;">üü° Poteau gauche</button>
        <button class="tag" id="pro_poteau_d" onclick="selectProDest('Poteau droit')" style="flex:1;text-align:center;">üü° Poteau droit</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pro_barre" onclick="selectProDest('Barre transversale')" style="flex:1;text-align:center;">üü° Barre transversale</button>
        <button class="tag" id="pro_arrete" onclick="selectProDest('Arr√™t√© gardien')" style="flex:1;text-align:center;">üß§ Arr√™t√© gardien</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalPenaltyRateOff')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmPenaltyRateOff(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmPenaltyRateOff(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL ARR√äT GARDIEN -->
<div class="modal-overlay" id="modalArretGardien">
  <div class="modal">
    <div class="modal-title">üß§ Arr√™t du gardien</div>
    <div class="input-row"><div class="input-label">Gardien</div><select class="input-field" id="agGardienSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Comment arr√™t√© ?</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
      <button class="tag" id="agMain_d" onclick="selectAgType('Main droite')">ü§ö Main droite</button>
      <button class="tag" id="agMain_g" onclick="selectAgType('Main gauche')">ü§ö Main gauche</button>
      <button class="tag" id="agDeuxMains" onclick="selectAgType('Deux mains')">üôå Deux mains</button>
      <button class="tag" id="agPied" onclick="selectAgType('Pied')">ü¶µ Pied</button>
      <button class="tag" id="agPlongeon" onclick="selectAgType('Plongeon')">ü§∏ Plongeon</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Zone du but (o√π le tir √©tait dirig√©)</div>
    <div style="background:#1a5c1a;border:3px solid #fff;border-radius:4px;padding:6px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
        <button class="goal-zone" id="aggz1" onclick="selectAgZone(1)">HG</button>
        <button class="goal-zone" id="aggz2" onclick="selectAgZone(2)">HC</button>
        <button class="goal-zone" id="aggz3" onclick="selectAgZone(3)">HD</button>
        <button class="goal-zone" id="aggz4" onclick="selectAgZone(4)">BG</button>
        <button class="goal-zone" id="aggz5" onclick="selectAgZone(5)">BC</button>
        <button class="goal-zone" id="aggz6" onclick="selectAgZone(6)">BD</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalArretGardien')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmArretGardien(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmArretGardien(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL PENALTY RAT√â ADVERSE -->
<div class="modal-overlay" id="modalPenaltyRateAdverse">
  <div class="modal">
    <div class="modal-title">üö´ Penalty rat√© (adverse)</div>
    <div class="input-label" style="margin-bottom:6px;">Destination du tir</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;">
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pra_cote_g" onclick="selectPraDest('√Ä c√¥t√© gauche')" style="flex:1;text-align:center;">‚óÄ √Ä c√¥t√© gauche</button>
        <button class="tag" id="pra_dessus" onclick="selectPraDest('Au-dessus')" style="flex:1;text-align:center;">‚¨Ü Au-dessus</button>
        <button class="tag" id="pra_cote_d" onclick="selectPraDest('√Ä c√¥t√© droit')" style="flex:1;text-align:center;">√Ä c√¥t√© droit ‚ñ∂</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pra_poteau_g" onclick="selectPraDest('Poteau gauche')" style="flex:1;text-align:center;">üü° Poteau gauche</button>
        <button class="tag" id="pra_poteau_d" onclick="selectPraDest('Poteau droit')" style="flex:1;text-align:center;">üü° Poteau droit</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="tag" id="pra_barre" onclick="selectPraDest('Barre transversale')" style="flex:1;text-align:center;">üü° Barre transversale</button>
        <button class="tag" id="pra_arrete" onclick="selectPraDest('Arr√™t√© gardien')" style="flex:1;text-align:center;">üß§ Arr√™t√© gardien</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalPenaltyRateAdverse')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmPenaltyRateAdverse(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmPenaltyRateAdverse(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL CENTRE -->
<div class="modal-overlay" id="modalCentre">
  <div class="modal">
    <div class="modal-title">üìê Centre</div>
    <div class="input-row"><div class="input-label">Centreur</div><select class="input-field" id="centreurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Pied</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag" id="centrePied_d" onclick="selectCentrePied('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="centrePied_g" onclick="selectCentrePied('Pied gauche')">ü¶µ Pied gauche</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Type de centre</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
      <button class="tag" id="centreRentrant" onclick="selectCentreType('Rentrant')">‚Ü© Rentrant</button>
      <button class="tag" id="centreSortant" onclick="selectCentreType('Sortant')">‚Ü™ Sortant</button>
      <button class="tag" id="centreTendu" onclick="selectCentreType('Tendu')">‚û° Tendu</button>
      <button class="tag" id="centreLobe" onclick="selectCentreType('Lob√©')">üåô Lob√©</button>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalCentre')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmCentre(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmCentre(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL COUP FRANC -->
<div class="modal-overlay" id="modalCoupFranc">
  <div class="modal">
    <div class="modal-title">üéØ Coup franc</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="cfTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Pied</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="tag" id="cfPied_d" onclick="selectCfPied('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="cfPied_g" onclick="selectCfPied('Pied gauche')">ü¶µ Pied gauche</button>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalCoupFranc')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmCoupFranc(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmCoupFranc(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL CORNER -->
<div class="modal-overlay" id="modalCorner">
  <div class="modal">
    <div class="modal-title">üö© Corner</div>
    <div class="input-row"><div class="input-label">Tireur</div><select class="input-field" id="cornerTireurSelect"></select></div>
    <div class="input-label" style="margin-bottom:6px;">Pied</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="tag" id="cornerPied_d" onclick="selectCornerPied('Pied droit')">ü¶µ Pied droit</button>
      <button class="tag" id="cornerPied_g" onclick="selectCornerPied('Pied gauche')">ü¶µ Pied gauche</button>
    </div>
    <div class="input-label" style="margin-bottom:6px;">Effet</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="tag" id="cornerRentrant" onclick="selectCornerEffet('Rentrant')">‚Ü© Rentrant</button>
      <button class="tag" id="cornerSortant" onclick="selectCornerEffet('Sortant')">‚Ü™ Sortant</button>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalCorner')">Annuler</button>
      <button class="btn-modal-cancel" onclick="confirmCorner(false)" style="background:var(--surface2);border:1px solid var(--accent2);color:var(--accent2);">‚ö° Sans d√©tail</button>
      <button class="btn-modal-confirm" onclick="confirmCorner(true)">‚úì OK</button>
    </div>
  </div>
</div>

<!-- MODAL CORRECTION SCORE -->
<div class="modal-overlay" id="modalScoreEdit">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Corriger le score</div>
    <div style="display:flex;gap:16px;align-items:flex-end;margin-bottom:8px;">
      <div class="input-row" style="flex:1;margin:0;">
        <div class="input-label" id="scoreEditHomeLabel">NOUS</div>
        <input class="input-field" id="scoreEditHome" type="number" min="0" max="99" style="font-size:28px;font-family:var(--fd);font-weight:900;text-align:center;">
      </div>
      <div style="font-family:var(--fd);font-size:30px;color:var(--muted);margin-bottom:12px;">‚Äî</div>
      <div class="input-row" style="flex:1;margin:0;">
        <div class="input-label" id="scoreEditAwayLabel">ADV</div>
        <input class="input-field" id="scoreEditAway" type="number" min="0" max="99" style="font-size:28px;font-family:var(--fd);font-weight:900;text-align:center;">
      </div>
    </div>
    <div style="font-family:var(--fd);font-size:11px;color:var(--muted);letter-spacing:1px;margin-bottom:4px;">TAP pour corriger ¬∑ Ex: but annul√©, erreur de saisie</div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" onclick="closeModal('modalScoreEdit')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmScoreEdit()">‚úì CORRIGER</button>
    </div>
  </div>
</div>

<!-- MODAL √âDITION JOUEUR -->
<div class="modal-overlay" id="modalEditPlayer">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Modifier le joueur</div>
    <input type="hidden" id="editPlayerId">
    <div class="input-row"><div class="input-label">Num√©ro</div><input class="input-field" id="editPlayerNum" type="number" min="1" max="99"></div>
    <div class="input-row"><div class="input-label">Nom</div><input class="input-field" id="editPlayerName" type="text"></div>
    <div class="input-row"><div class="input-label">Poste</div>
      <select class="input-field" id="editPlayerPos">
        <option value="GK">Gardien (GK)</option>
        <option value="DC">D√©fenseur Central (DC)</option>
        <option value="DL">D√©fenseur Lat√©ral G (DL)</option>
        <option value="DR">D√©fenseur Lat√©ral D (DR)</option>
        <option value="MDC">Milieu D√©fensif (MDC)</option>
        <option value="MC">Milieu Central (MC)</option>
        <option value="MO">Milieu Offensif (MO)</option>
        <option value="MG">Milieu Gauche (MG)</option>
        <option value="MD">Milieu Droit (MD)</option>
        <option value="AG">Ailier Gauche (AG)</option>
        <option value="AD">Ailier Droit (AD)</option>
        <option value="ATT">Attaquant (ATT)</option>
      </select>
    </div>
    <div class="input-row"><div class="input-label">Statut</div>
      <select class="input-field" id="editPlayerStatus">
        <option value="field">Sur le terrain</option>
        <option value="bench">Banc</option>
        <option value="out">Sorti / Bless√©</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button class="btn-modal-cancel" style="background:linear-gradient(135deg,#7b0000,#cc0000);color:#fff;border:none;flex:1;" onclick="deletePlayer(parseInt(document.getElementById('editPlayerId').value))">üóë Suppr.</button>
      <button class="btn-modal-cancel" onclick="closeModal('modalEditPlayer')">Annuler</button>
      <button class="btn-modal-confirm" onclick="confirmEditPlayer()">‚úì SAUVER</button>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
var matchLocation='domicile'; // 'domicile', 'exterieur', 'neutre'
let timerInterval=null, seconds=0, isRunning=false;
let currentHalf=1, halfDuration=45;
let events=[], counts={};
let scoreHome=0, scoreAway=0;
let selectedZone=null, pendingCardType='';
let currentFormat=11, selectedTactic=null;
let rosterFilter='all';
let roster=[], substitutions=[];
let oppRoster=[]; // { id, num, name, pos, note }
let cardTeamSide='own'; // 'own' or 'opp'

// ===== TACTICS =====
const TACTICS={
  11:[
    {name:'4-4-2',desc:'Classique √©quilibr√©',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:16,y:54,pos:'MG'},{x:36,y:54,pos:'MC'},{x:64,y:54,pos:'MC'},{x:84,y:54,pos:'MD'},
      {x:35,y:28,pos:'ATT'},{x:65,y:28,pos:'ATT'}]},
    {name:'4-3-3',desc:'Offensif, ailiers larges',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:28,y:54,pos:'MC'},{x:50,y:52,pos:'MC'},{x:72,y:54,pos:'MC'},
      {x:16,y:26,pos:'AG'},{x:50,y:23,pos:'ATT'},{x:84,y:26,pos:'AD'}]},
    {name:'4-2-3-1',desc:'Milieu solide + N¬∞10',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:33,y:62,pos:'MDC'},{x:67,y:62,pos:'MDC'},
      {x:16,y:44,pos:'MG'},{x:50,y:42,pos:'MO'},{x:84,y:44,pos:'MD'},
      {x:50,y:21,pos:'ATT'}]},
    {name:'3-5-2',desc:'3 d√©fenseurs, couloirs',positions:[
      {x:50,y:91,pos:'GK'},{x:26,y:76,pos:'DC'},{x:50,y:75,pos:'DC'},{x:74,y:76,pos:'DC'},
      {x:10,y:53,pos:'MG'},{x:30,y:55,pos:'MC'},{x:50,y:53,pos:'MC'},{x:70,y:55,pos:'MC'},{x:90,y:53,pos:'MD'},
      {x:35,y:26,pos:'ATT'},{x:65,y:26,pos:'ATT'}]},
    {name:'3-4-3',desc:'Tr√®s offensif',positions:[
      {x:50,y:91,pos:'GK'},{x:26,y:76,pos:'DC'},{x:50,y:75,pos:'DC'},{x:74,y:76,pos:'DC'},
      {x:16,y:56,pos:'MG'},{x:38,y:55,pos:'MC'},{x:62,y:55,pos:'MC'},{x:84,y:56,pos:'MD'},
      {x:18,y:25,pos:'AG'},{x:50,y:22,pos:'ATT'},{x:82,y:25,pos:'AD'}]},
    {name:'5-3-2',desc:'5 d√©fenseurs, compact',positions:[
      {x:50,y:91,pos:'GK'},{x:9,y:72,pos:'DL'},{x:27,y:76,pos:'DC'},{x:50,y:76,pos:'DC'},{x:73,y:76,pos:'DC'},{x:91,y:72,pos:'DR'},
      {x:28,y:52,pos:'MC'},{x:50,y:50,pos:'MC'},{x:72,y:52,pos:'MC'},
      {x:35,y:27,pos:'ATT'},{x:65,y:27,pos:'ATT'}]},
    {name:'4-1-4-1',desc:'Verrou + milieu haut',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:50,y:64,pos:'MDC'},
      {x:14,y:48,pos:'MG'},{x:35,y:47,pos:'MC'},{x:65,y:47,pos:'MC'},{x:86,y:48,pos:'MD'},
      {x:50,y:22,pos:'ATT'}]},
    {name:'4-3-2-1',desc:'Arbre de No√´l ‚Äî Ancelotti',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:26,y:58,pos:'MC'},{x:50,y:57,pos:'MC'},{x:74,y:58,pos:'MC'},
      {x:34,y:38,pos:'MO'},{x:66,y:38,pos:'MO'},
      {x:50,y:20,pos:'ATT'}]},
    {name:'4-5-1',desc:'Bloc d√©fensif, contre ‚Äî Mourinho',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:10,y:50,pos:'MG'},{x:30,y:52,pos:'MC'},{x:50,y:50,pos:'MDC'},{x:70,y:52,pos:'MC'},{x:90,y:50,pos:'MD'},
      {x:50,y:22,pos:'ATT'}]},
    {name:'4-4-2 Diamant',desc:'Losange, N¬∞10 ‚Äî Capello',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:50,y:63,pos:'MDC'},
      {x:24,y:50,pos:'MC'},{x:76,y:50,pos:'MC'},
      {x:50,y:37,pos:'MO'},
      {x:35,y:22,pos:'ATT'},{x:65,y:22,pos:'ATT'}]},
    {name:'3-4-3',desc:'Total Football ‚Äî Cruyff/Guardiola',positions:[
      {x:50,y:91,pos:'GK'},{x:26,y:76,pos:'DC'},{x:50,y:75,pos:'DC'},{x:74,y:76,pos:'DC'},
      {x:16,y:56,pos:'MG'},{x:38,y:55,pos:'MC'},{x:62,y:55,pos:'MC'},{x:84,y:56,pos:'MD'},
      {x:18,y:25,pos:'AG'},{x:50,y:22,pos:'ATT'},{x:82,y:25,pos:'AD'}]},
    {name:'3-3-1-3',desc:'Bielsa ‚Äî pressing haut',positions:[
      {x:50,y:91,pos:'GK'},{x:25,y:76,pos:'DC'},{x:50,y:75,pos:'DC'},{x:75,y:76,pos:'DC'},
      {x:20,y:57,pos:'MC'},{x:50,y:56,pos:'MC'},{x:80,y:57,pos:'MC'},
      {x:50,y:42,pos:'MO'},
      {x:18,y:24,pos:'AG'},{x:50,y:21,pos:'ATT'},{x:82,y:24,pos:'AD'}]},
    {name:'4-3-3 (Pep)',desc:'Tiki-taka ‚Äî Guardiola',positions:[
      {x:50,y:91,pos:'GK'},{x:18,y:75,pos:'DL'},{x:36,y:75,pos:'DC'},{x:64,y:75,pos:'DC'},{x:82,y:75,pos:'DR'},
      {x:25,y:56,pos:'MDC'},{x:50,y:54,pos:'MC'},{x:75,y:56,pos:'MC'},
      {x:12,y:24,pos:'AG'},{x:50,y:20,pos:'ATT'},{x:88,y:24,pos:'AD'}]},
    {name:'5-4-1',desc:'Ultra d√©fensif ‚Äî protection avance',positions:[
      {x:50,y:91,pos:'GK'},{x:8,y:70,pos:'DL'},{x:26,y:76,pos:'DC'},{x:50,y:77,pos:'DC'},{x:74,y:76,pos:'DC'},{x:92,y:70,pos:'DR'},
      {x:14,y:52,pos:'MG'},{x:36,y:53,pos:'MC'},{x:64,y:53,pos:'MC'},{x:86,y:52,pos:'MD'},
      {x:50,y:23,pos:'ATT'}]},
    {name:'4-3-3 (KLOPP)',desc:'Gegenpressing ‚Äî Liverpool ‚Äî Pressing haut intense',positions:[
      {x:50,y:91,pos:'GK'},
      {x:15,y:72,pos:'DL'},{x:37,y:77,pos:'DC'},{x:63,y:77,pos:'DC'},{x:85,y:72,pos:'DR'},
      {x:25,y:50,pos:'MC'},{x:50,y:55,pos:'MDC'},{x:75,y:50,pos:'MC'},
      {x:14,y:24,pos:'AG'},{x:50,y:20,pos:'ATT'},{x:86,y:24,pos:'AD'}]},
    {name:'3-4-2-1 (ALONSO)',desc:'Leverkusen ‚Äî Transitions + bloc compact',positions:[
      {x:50,y:91,pos:'GK'},
      {x:25,y:78,pos:'DC'},{x:50,y:80,pos:'DC'},{x:75,y:78,pos:'DC'},
      {x:10,y:54,pos:'DL'},{x:35,y:54,pos:'MC'},{x:65,y:54,pos:'MC'},{x:90,y:54,pos:'DR'},
      {x:33,y:28,pos:'MO'},{x:67,y:28,pos:'MO'},
      {x:50,y:16,pos:'ATT'}]},
  ],
  8:[
    {name:'3-3-1',desc:'√âquilibr√© √† 8',positions:[
      {x:50,y:91,pos:'GK'},{x:22,y:73,pos:'DC'},{x:50,y:73,pos:'DC'},{x:78,y:73,pos:'DC'},
      {x:22,y:51,pos:'MC'},{x:50,y:49,pos:'MC'},{x:78,y:51,pos:'MC'},
      {x:50,y:24,pos:'ATT'}]},
    {name:'2-3-2',desc:'Milieu large',positions:[
      {x:50,y:91,pos:'GK'},{x:30,y:76,pos:'DC'},{x:70,y:76,pos:'DC'},
      {x:16,y:52,pos:'MG'},{x:50,y:50,pos:'MC'},{x:84,y:52,pos:'MD'},
      {x:30,y:25,pos:'ATT'},{x:70,y:25,pos:'ATT'}]},
    {name:'3-2-2',desc:'Compact d√©fensivement',positions:[
      {x:50,y:91,pos:'GK'},{x:22,y:74,pos:'DC'},{x:50,y:74,pos:'DC'},{x:78,y:74,pos:'DC'},
      {x:33,y:52,pos:'MC'},{x:67,y:52,pos:'MC'},
      {x:30,y:26,pos:'ATT'},{x:70,y:26,pos:'ATT'}]},
    {name:'2-4-1',desc:'Milieu renforc√©',positions:[
      {x:50,y:91,pos:'GK'},{x:30,y:77,pos:'DC'},{x:70,y:77,pos:'DC'},
      {x:13,y:53,pos:'MG'},{x:37,y:52,pos:'MC'},{x:63,y:52,pos:'MC'},{x:87,y:53,pos:'MD'},
      {x:50,y:25,pos:'ATT'}]},
    {name:'1-3-3',desc:'Tr√®s offensif',positions:[
      {x:50,y:91,pos:'GK'},{x:50,y:75,pos:'DC'},
      {x:22,y:52,pos:'MC'},{x:50,y:50,pos:'MC'},{x:78,y:52,pos:'MC'},
      {x:16,y:27,pos:'AG'},{x:50,y:23,pos:'ATT'},{x:84,y:27,pos:'AD'}]},
    {name:'3-1-3',desc:'Verrou d√©fensif',positions:[
      {x:50,y:91,pos:'GK'},{x:22,y:75,pos:'DC'},{x:50,y:75,pos:'DC'},{x:78,y:75,pos:'DC'},
      {x:50,y:53,pos:'MDC'},
      {x:18,y:27,pos:'AG'},{x:50,y:24,pos:'ATT'},{x:82,y:27,pos:'AD'}]}
  ]
};

// ===== TIMER =====
function getTime(){
  // Always show elapsed time as MM:SS counting UP
  const m=Math.floor(seconds/60);
  const s=seconds%60;
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function updateTimerDisplay(){
  const el=document.getElementById('timerDisplay');
  el.textContent=getTime();
  el.className='timer-display'+(isRunning?' running':seconds>0?' paused':'');
  // Alert visuel quand on approche de la fin de mi-temps
  const halfSecs=halfDuration*60;
  if(isRunning && seconds===halfSecs){
    el.style.animation='pulse 0.5s ease 4';
    if(navigator.vibrate)navigator.vibrate([200,100,200]);
  }
}
function startTimer(){
  if(isRunning)return;isRunning=true;
  timerInterval=setInterval(()=>{seconds++;updateTimerDisplay();tickPlaytimes();},1000);
  document.getElementById('btnStart').style.display='none';
  document.getElementById('btnPause').style.display='';
}
function pauseTimer(){
  isRunning=false;clearInterval(timerInterval);
  document.getElementById('btnStart').style.display='';
  document.getElementById('btnPause').style.display='none';
  updateTimerDisplay();
}
function resetTimer(){pauseTimer();seconds=0;updateTimerDisplay();}
function switchHalf(){
  pauseTimer();seconds=0;currentHalf=currentHalf===1?2:1;
  document.getElementById('halfBadge').textContent=currentHalf===1?'1√®re MT':'2√®me MT';
  updateTimerDisplay();addEventToLog('‚è±','‚Äî Passage √† la 2√®me mi-temps ‚Äî','');
}
function setHalfDuration(d,el){
  halfDuration=d;
  document.querySelectorAll('[id^="dur-"]').forEach(b=>b.classList.remove('sel'));
  if(el)el.classList.add('sel');
  // Update half badge to show configured duration
  document.getElementById('halfBadge').textContent=(currentHalf===1?'1√®re':'2√®me')+' MT ¬∑ '+d+'min';
}

// ===== SCORE =====
function changeScore(team,delta){
  if(team==='home'){scoreHome=Math.max(0,scoreHome+delta);document.getElementById('scoreHomeEl').textContent=scoreHome;}
  else{scoreAway=Math.max(0,scoreAway+delta);document.getElementById('scoreAwayEl').textContent=scoreAway;}
}

// ===== TABS =====
function showTab(id,tabEl){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  if(tabEl)tabEl.classList.add('active');
  if(id==='rapport')buildRapport();
  if(id==='effectif')renderRoster();
  if(id==='adversaire')renderOppRoster();
  if(id==='tactique'&&selectedTactic!==null)renderPitch();
}

// ===== LOG =====
function addEventToLog(icon,text,zone,evType,evPlayerId){
  const ev={time:getTime(),half:currentHalf,icon,text,zone:zone||'',type:evType||'',playerId:evPlayerId||''};
  events.unshift(ev);renderLog();
  // Mettre √† jour le badge derni√®re action sur le mini-terrain
  const badge=document.getElementById('lastActionBadge');
  const zLabel=document.getElementById('zonedEventLabel');
  if(badge)badge.innerHTML=`<span style="color:var(--accent);font-weight:700;">${icon} ${text}</span> <span style="color:var(--muted);">‚Äî tape une zone</span>`;
  if(zLabel)zLabel.textContent=ev.zone?`üìç Zone ${ev.zone} enregistr√©e`:'';
  // R√©initialiser surbrillance zones
  document.querySelectorAll('.pitch-zone').forEach(z=>z.classList.remove('zoned'));
  return ev;
}
function tagZonePitch(zoneNum, el){
  if(!events.length)return;
  // Appliquer la zone au dernier √©v√©nement
  events[0].zone='Zone '+zoneNum;events[0].zoneNum=zoneNum;
  renderLog();
  // Feedback visuel
  document.querySelectorAll('.pitch-zone').forEach(z=>z.classList.remove('zoned'));
  if(el)el.classList.add('zoned');
  const overlay=document.getElementById('zoneConfirmOverlay');
  const zLabel=document.getElementById('zonedEventLabel');
  if(overlay){
    overlay.textContent='Zone '+zoneNum+' ‚úì';
    overlay.style.display='block';
    setTimeout(()=>overlay.style.display='none',800);
  }
  if(zLabel)zLabel.textContent=`üìç Zone ${zoneNum} ‚Üí ${events[0].icon} ${events[0].text}`;
}
function renderLog(){
  const list=document.getElementById('logList');
  if(!events.length){list.innerHTML='<li class="empty-log">Aucun √©v√©nement</li>';return;}
  list.innerHTML=events.map((e,i)=>`
    <li class="log-item">
      <span class="log-time">${e.time}</span>
      <span class="log-icon">${e.icon}</span>
      <span class="log-text">${e.text}${e.zone?`<br><span class="log-zone">üìç ${e.zone}</span>`:''}</span>
      <span style="font-family:var(--fd);font-size:10px;color:var(--muted);margin-right:2px;">${e.half}√®me</span>
      <button class="btn-delete" onclick="deleteEvent(${i})">‚úï</button>
    </li>`).join('');
}
function deleteEvent(i){events.splice(i,1);renderLog();}
function clearLog(){if(confirm('Effacer tout le journal ?')){events=[];renderLog();}}

// ===== ACTIONS =====
function incrementCount(key){
  counts[key]=(counts[key]||0)+1;
  const el=document.getElementById('cnt-'+key);
  if(el)el.textContent=counts[key];
}
function logAction(name,icon,key){
  if(key)incrementCount(key);
  addEventToLog(icon,name);
}

// ===== GENERIC ACTION MODAL =====
let _pendingAction={};
function openActionModal(name, icon, key, label1, label2, skipIfNoRoster){
  // If no roster, log directly without modal
  if(skipIfNoRoster && roster.filter(p=>p.status==='field').length===0){
    logAction(name,icon,key); return;
  }
  _pendingAction={name,icon,key,label1,label2};
  document.getElementById('actionModalTitle').textContent=icon+' '+name;
  document.getElementById('actionLabel1').textContent=label1||'Joueur';
  // Populate player selects
  const fieldPlayers=roster.filter(p=>p.status==='field');
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+fieldPlayers.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('actionPlayer1').innerHTML=opts;
  // Second field
  const row2=document.getElementById('actionRow2');
  if(label2){
    row2.style.display='';
    document.getElementById('actionLabel2').textContent=label2;
    document.getElementById('actionPlayer2').innerHTML=opts;
  } else {
    row2.style.display='none';
  }
  // Quick buttons for field players
  const qb=document.getElementById('actionQuickBtns');
  if(fieldPlayers.length){
    qb.innerHTML=fieldPlayers.map(p=>`<button class="tag" style="padding:6px 10px;" onclick="quickSelectPlayer(${p.id})">${p.num} ${p.name}</button>`).join('');
  } else {
    qb.innerHTML='<span style="font-family:var(--fd);font-size:11px;color:var(--muted);">Ajoute des joueurs dans Effectif pour les associer</span>';
  }
  document.getElementById('modalAction').classList.add('open');
}
function quickSelectPlayer(id){
  const sel=document.getElementById('actionPlayer1');
  sel.value=id;
  // Flash the button
  event.target.classList.add('sel');
  setTimeout(()=>event.target.classList.remove('sel'),400);
}
function confirmActionModal(withPlayer){
  const {name,icon,key,label1,label2}=_pendingAction;
  const sel1=document.getElementById('actionPlayer1');
  const sel2=document.getElementById('actionPlayer2');
  let text=name;
  if(withPlayer){
    const p1=sel1.value?sel1.options[sel1.selectedIndex].text:'';
    const p2=label2&&sel2.value?sel2.options[sel2.selectedIndex].text:'';
    if(p1) text+=` ‚Äî ${p1}`;
    if(p2) text+=` (${label2}: ${p2})`;
  }
  incrementCount(key);
  addEventToLog(icon,text,'',actionKey,withPlayer?roster.find(p=>p.name===text.split(' ')[1])?.id||'':'');
  closeModal('modalAction');
}

// ===== GOAL =====
function openGoalModal(){
  populateSelect('goalScorerSelect',true,false);
  populateSelect('goalAssistSelect',true,true);
  document.getElementById('modalGoal').classList.add('open');
}
function confirmGoal(){
  const ss=document.getElementById('goalScorerSelect');
  const sa=document.getElementById('goalAssistSelect');
  const scorer=ss.value?ss.options[ss.selectedIndex].text:'';
  const assist=sa.value?sa.options[sa.selectedIndex].text:'';
  let text='BUT !'+(scorer?` ‚Äî ${scorer}`:'')+(assist?` (passe: ${assist})`:'');
  incrementCount('BUT');scoreHome++;
  document.getElementById('scoreHomeEl').textContent=scoreHome;
  addEventToLog('üü¢',text);closeModal('modalGoal');
}

// ===== CARD =====
function openCardModal(type){
  pendingCardType=type;
  document.getElementById('cardModalTitle').textContent=type==='Carton jaune'?'üü® Carton jaune':'üü• Carton rouge';
  switchCardTeam('own');
  document.getElementById('modalCard').classList.add('open');
}
function switchCardTeam(side){
  cardTeamSide=side;
  document.getElementById('cardTeamOwn').classList.toggle('sel',side==='own');
  document.getElementById('cardTeamOpp').classList.toggle('sel',side==='opp');
  const sel=document.getElementById('cardPlayerSelect');
  const players=side==='own'?roster:oppRoster;
  sel.innerHTML='<option value="">‚Äî S√©lectionner ‚Äî</option>'+
    players.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
}
function confirmCard(){
  const sel=document.getElementById('cardPlayerSelect');
  const player=sel.value?sel.options[sel.selectedIndex].text:'';
  const icon=pendingCardType==='Carton jaune'?'üü®':'üü•';
  const teamLabel=cardTeamSide==='opp'?' (ADV)':'';
  incrementCount(pendingCardType==='Carton jaune'?'JAUNE':'ROUGE');
  const ev=addEventToLog(icon,pendingCardType+(player?` ‚Äî ${player}${teamLabel}`:''));
  if(cardTeamSide==='opp')addOppEvent(ev);
  closeModal('modalCard');
}

// ===== TERRAIN ZONE =====
function selectZone(zone,el){
  selectedZone=zone;
  document.querySelectorAll('.btn-zone').forEach(b=>b.classList.remove('selected'));
  if(el)el.classList.add('selected');
  document.getElementById('selectedZoneLabel').textContent='üìç Zone : '+zone;
}
function tagZoneAction(name,icon){
  if(!selectedZone){document.getElementById('selectedZoneLabel').textContent='‚ö†Ô∏è S√©lectionne une zone !';return;}
  addEventToLog(icon,name,selectedZone);buildZoneLog();
  const t=event.target.closest('.tag');
  t.style.background='var(--green)';t.style.color='#000';
  setTimeout(()=>{t.style.background='';t.style.color='';},350);
}
function buildZoneLog(){
  if(!selectedZone)return;
  const zlog=document.getElementById('zoneLog');
  const zev=events.filter(e=>e.zone===selectedZone).slice(0,6);
  if(!zev.length){zlog.innerHTML='';return;}
  zlog.innerHTML=`<div class="section-title">Derniers : ${selectedZone}</div>`+
    zev.map(e=>`<div style="font-size:12px;color:var(--muted);padding:3px 0;font-family:var(--fd);">${e.icon} ${e.text} <span style="color:var(--accent)">${e.time}</span></div>`).join('');
}

// ===== NOTES =====
function addNote(text){const el=document.getElementById(currentHalf===1?'notes1':'notes2');el.value+=text;el.focus();}

// ===== CLOSE MODAL =====
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ===== ROSTER =====
function openAddPlayerModal(){
  document.getElementById('newPlayerNum').value='';
  document.getElementById('newPlayerName').value='';
  document.getElementById('modalAddPlayer').classList.add('open');
}
function confirmAddPlayer(){
  const num=document.getElementById('newPlayerNum').value.trim();
  const name=document.getElementById('newPlayerName').value.trim();
  const pos=document.getElementById('newPlayerPos').value;
  const status=document.getElementById('newPlayerStatus').value;
  if(!name){alert('Nom requis');return;}
  roster.push({id:Date.now(),num:num||'?',name,pos,status,entryTime:status==='field'?seconds:null,totalSeconds:0});
  saveRoster();renderRoster();if(selectedTactic!==null)renderPitch();
  closeModal('modalAddPlayer');
}
function openEditPlayerModal(id){
  const p=roster.find(x=>x.id===id);if(!p)return;
  document.getElementById('editPlayerId').value=id;
  document.getElementById('editPlayerNum').value=p.num;
  document.getElementById('editPlayerName').value=p.name;
  document.getElementById('editPlayerPos').value=p.pos;
  document.getElementById('editPlayerStatus').value=p.status;
  document.getElementById('modalEditPlayer').classList.add('open');
}
function confirmEditPlayer(){
  const id=parseInt(document.getElementById('editPlayerId').value);
  const p=roster.find(x=>x.id===id);if(!p)return;
  const newNum=document.getElementById('editPlayerNum').value.trim();
  const newName=document.getElementById('editPlayerName').value.trim();
  const newPos=document.getElementById('editPlayerPos').value;
  const newStatus=document.getElementById('editPlayerStatus').value;
  if(!newName){alert('Nom requis');return;}
  // Handle status change: if going field‚Üíbench, freeze time; bench‚Üífield, start timer
  if(p.status==='field'&&newStatus!=='field'){
    if(p.entryTime!=null)p.totalSeconds+=seconds-p.entryTime;
    p.entryTime=null;
  } else if(p.status!=='field'&&newStatus==='field'&&p.entryTime==null){
    p.entryTime=seconds;
  }
  p.num=newNum||'?';p.name=newName;p.pos=newPos;p.status=newStatus;
  renderRoster();renderSubLog();if(selectedTactic!==null)renderPitch();
  closeModal('modalEditPlayer');
}
function deletePlayer(id){
  if(!confirm('Supprimer ce joueur ?'))return;
  roster=roster.filter(p=>p.id!==id);
  saveRoster();renderRoster();if(selectedTactic!==null)renderPitch();
  closeModal('modalEditPlayer');
}
function calcPlaytime(p){
  if(p.status==='bench')return 0;
  if(p.status==='out')return p.totalSeconds||0;
  var base=p.totalSeconds||0;
  var extra=(p.entryTime!=null&&!isNaN(p.entryTime))?(seconds-p.entryTime):0;
  if(extra<0)extra=0;
  return base+extra;
}
function tickPlaytimes(){
  checkSuspensions();
  if(document.getElementById('panel-effectif').classList.contains('active'))renderRoster();
}
function renderRoster(){
  const list=document.getElementById('rosterList');
  const order={field:0,suspended:0,bench:1,out:2};
  let filtered=rosterFilter==='all'?roster:roster.filter(p=>rosterFilter==='field'?(p.status==='field'||p.status==='suspended'):p.status===rosterFilter);
  if(!filtered.length){list.innerHTML='<div class="empty-log">Aucun joueur</div>';return;}
  const sorted=[...filtered].sort((a,b)=>order[a.status]-order[b.status]||(parseInt(a.num)||99)-(parseInt(b.num)||99));
  const totalMatchSecs=halfDuration*2*60;
  list.innerHTML=sorted.map(p=>{
    const pt=calcPlaytime(p);
    const mins=Math.floor(pt/60);
    const pct=totalMatchSecs>0?Math.min(100,Math.round(pt/totalMatchSecs*100)):0;
    const suspMin=p.status==='suspended'&&p.suspendedUntil?Math.max(0,Math.ceil((p.suspendedUntil-seconds)/60)):0;
    const statusHtml=p.status==='field'?'<span class="player-status status-field">TERRAIN</span>':
      p.status==='suspended'?`<span class="player-status" style="background:rgba(158,158,158,.25);color:#bdbdbd;border-color:#9e9e9e;">‚¨ú EXCLU ${suspMin}min</span>`:
      p.status==='bench'?'<span class="player-status status-bench">BANC</span>':
      '<span class="player-status status-out">SORTI</span>';
    const subBtn=p.status==='field'?`<button class="btn-sub" onclick="openSubModal(${p.id})">üîÑ</button>`:
      p.status==='suspended'?`<button class="btn-sub" style="opacity:.4;cursor:default;">‚¨ú</button>`:
      p.status==='bench'?`<button class="btn-sub enter" onclick="openSubModalForEntry(${p.id})">‚ñ∂ Entre</button>`:
      `<button class="btn-sub enter" style="background:linear-gradient(135deg,#005f8a,#0095b3);" onclick="openSubModalForEntry(${p.id})">‚Ü© R√©-entre</button>`;
    return `<div class="roster-item">
      <div class="player-num">${p.num}</div>
      <div class="player-info">
        <div class="player-pname">${p.name}</div>
        <div class="player-pos">${p.pos}${p.status!=='bench'?` ¬∑ ${isNaN(mins)?0:mins}min`:''}</div>
        ${p.status!=='bench'?`<div class="playtime-bar-wrap"><div class="playtime-bar-fill" style="width:${pct}%"></div></div>`:''}
      </div>
      ${statusHtml}
      <button class="btn-sub" style="background:rgba(0,184,255,0.15);border:1px solid rgba(0,184,255,0.3);color:var(--blue);font-size:16px;padding:8px 10px;min-width:40px;" onclick="openEditPlayerModal(${p.id})">‚úèÔ∏è</button>
      ${subBtn}
    </div>`;
  }).join('');
}
function filterRoster(f,el){
  rosterFilter=f;
  document.querySelectorAll('#rosterFilterBtns .tag').forEach(b=>b.classList.remove('sel'));
  if(el)el.classList.add('sel');renderRoster();
}

// ===== SUBSTITUTION =====
function populateSubSelects(preOutId,preInId){
  const outSel=document.getElementById('subOutSelect');
  const inSel=document.getElementById('subInSelect');
  const fieldPlayers=roster.filter(p=>p.status==='field');
  // "Qui peut entrer" = banc + sortis (remplacements illimit√©s en amateur)
  const availPlayers=roster.filter(p=>p.status==='bench'||p.status==='out');
  outSel.innerHTML=fieldPlayers.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name} (${p.pos})</option>`).join('');
  inSel.innerHTML=availPlayers.map(p=>`<option value="${p.id}">${p.status==='out'?'üîÑ':'üí∫'} ${p.num} ‚Äì ${p.name} (${p.pos})</option>`).join('');
  if(preOutId)outSel.value=preOutId;
  if(preInId)inSel.value=preInId;
}
function openSubModal(preOutId){
  const avail=roster.filter(p=>p.status==='bench'||p.status==='out');
  const field=roster.filter(p=>p.status==='field');
  if(!avail.length){alert('Aucun joueur disponible (banc ou sorti) !');return;}
  if(!field.length){alert('Aucun joueur sur le terrain !');return;}
  populateSubSelects(preOutId,null);
  document.getElementById('modalSub').classList.add('open');
}
function openSubModalForEntry(preInId){
  const field=roster.filter(p=>p.status==='field');
  if(!field.length){alert('Aucun joueur sur le terrain !');return;}
  populateSubSelects(null,preInId);
  document.getElementById('modalSub').classList.add('open');
}
function confirmSub(){
  const outId=parseInt(document.getElementById('subOutSelect').value);
  const inId=parseInt(document.getElementById('subInSelect').value);
  if(!outId||!inId){alert('S√©lectionne les deux joueurs');return;}
  const pOut=roster.find(p=>p.id===outId);
  const pIn=roster.find(p=>p.id===inId);
  if(!pOut||!pIn)return;
  if(pOut.entryTime!=null)pOut.totalSeconds+=seconds-pOut.entryTime;
  pOut.status='out';pOut.entryTime=null;
  pIn.status='field';pIn.entryTime=seconds;
  substitutions.push({time:getTime(),half:currentHalf,outId,inId});
  addEventToLog('üîÑ',`üî¥ ${pOut.num} ${pOut.name} ‚Üî üü¢ ${pIn.num} ${pIn.name}`,'');
  renderRoster();renderSubLog();if(selectedTactic!==null)renderPitch();
  closeModal('modalSub');
}
function renderSubLog(){
  const el=document.getElementById('subLog');
  if(!substitutions.length){el.innerHTML='<div class="empty-log">Aucun remplacement</div>';return;}
  el.innerHTML=substitutions.map(s=>{
    const pOut=roster.find(p=>p.id===s.outId);
    const pIn=roster.find(p=>p.id===s.inId);
    return `<div class="sub-item">
      <span class="sub-time-label">${s.time}</span>
      <span style="font-family:var(--fd);font-size:11px;color:var(--muted);">${s.half}√®me MT</span>
      <span style="font-family:var(--fd);font-size:13px;">üî¥ ${pOut?pOut.num+' '+pOut.name:'?'}</span>
      <span style="color:var(--muted);">‚Üí</span>
      <span style="font-family:var(--fd);font-size:13px;color:var(--green);">üü¢ ${pIn?pIn.num+' '+pIn.name:'?'}</span>
    </div>`;
  }).join('');
}

// ===== PLAYER SELECT HELPER =====
function populateSelect(id,fieldOnly,allowEmpty){
  const sel=document.getElementById(id);
  const players=fieldOnly?roster.filter(p=>p.status==='field'):roster;
  sel.innerHTML=(allowEmpty?'<option value="">‚Äî Aucun ‚Äî</option>':'<option value="">‚Äî S√©lectionner ‚Äî</option>')+
    players.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
}

// ===== TACTICS =====
function setFormat(fmt,el){
  currentFormat=fmt;selectedTactic=null;
  document.querySelectorAll('.format-tab').forEach(b=>b.classList.remove('active'));
  if(el)el.classList.add('active');
  renderTacticGrid();
  document.getElementById('tacticDetails').style.display='none';
}
function renderTacticGrid(){
  const tactics=TACTICS[currentFormat]||[];
  const makeCard=(t,i,fn,prefix)=>`<div class="tactic-card" onclick="${fn}(${i})" id="${prefix}-${i}">
    <div class="tactic-name">${t.name}</div>
    <div class="tactic-desc">${t.desc}</div>
  </div>`;
  const grid=document.getElementById('tacticGrid');
  if(grid)grid.innerHTML=tactics.map((t,i)=>makeCard(t,i,'selectTactic','tc')).join('');
  const gridChange=document.getElementById('tacticGridChange');
  if(gridChange)gridChange.innerHTML=tactics.map((t,i)=>makeCard(t,i,'selectTacticChange','tcc')).join('');
  const gridOpp=document.getElementById('tacticGridOpp');
  if(gridOpp)gridOpp.innerHTML=tactics.map((t,i)=>makeCard(t,i,'selectOppTactic','topp')).join('');
}
function selectTactic(i){
  selectedTactic=i;
  document.querySelectorAll('[id^="tc-"]').forEach(c=>c.classList.remove('selected'));
  const card=document.getElementById('tc-'+i);if(card)card.classList.add('selected');
  document.getElementById('tacticDetails').style.display='block';
  document.getElementById('selectedTacticLabel').textContent='‚öΩ '+TACTICS[currentFormat][i].name+' ‚Äî '+TACTICS[currentFormat][i].desc;
  renderTacticGrid();
  renderPitch();
}

// ‚îÄ‚îÄ CHANGEMENT EN COURS DE MATCH ‚îÄ‚îÄ
let _pendingTacticChange=null, _changeTacticReason='';
function selectTacticChange(i){
  _pendingTacticChange=i;_changeTacticReason='';
  document.querySelectorAll('[id^="tcc-"]').forEach(c=>c.classList.remove('selected'));
  const el=document.getElementById('tcc-'+i);if(el)el.classList.add('selected');
  ['ctr_exp','ctr_exc','ctr_ret','ctr_avance','ctr_adj'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('sel');});
  document.getElementById('changeTacticReason').style.display='';
  document.getElementById('btnConfirmTacticChange').style.display='';
}
function selectChangeTacticReason(r){
  _changeTacticReason=r;
  const map={'Expulsion d√©finitive':'ctr_exp','Exclusion temporaire':'ctr_exc','Retard au score':'ctr_ret',"Tenir l'avance":'ctr_avance','Ajustement tactique':'ctr_adj'};
  ['ctr_exp','ctr_exc','ctr_ret','ctr_avance','ctr_adj'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('sel');});
  if(map[r])document.getElementById(map[r]).classList.add('sel');
}
function confirmTacticChange(){
  if(_pendingTacticChange===null)return;
  const old=selectedTactic!==null?TACTICS[currentFormat][selectedTactic].name:'?';
  const newT=TACTICS[currentFormat][_pendingTacticChange];
  selectedTactic=_pendingTacticChange;
  document.querySelectorAll('[id^="tc-"]').forEach(c=>c.classList.remove('selected'));
  const el=document.getElementById('tc-'+selectedTactic);if(el)el.classList.add('selected');
  document.getElementById('selectedTacticLabel').textContent='‚öΩ '+newT.name+' ‚Äî '+newT.desc;
  let logText=`Changement tactique : ${old} ‚Üí ${newT.name}`;
  if(_changeTacticReason)logText+=` (${_changeTacticReason})`;
  addEventToLog('üîÑ',logText);
  renderPitch();
  _pendingTacticChange=null;_changeTacticReason='';
  document.getElementById('changeTacticReason').style.display='none';
  document.getElementById('btnConfirmTacticChange').style.display='none';
  document.querySelectorAll('[id^="tcc-"]').forEach(c=>c.classList.remove('selected'));
  ['ctr_exp','ctr_exc','ctr_ret','ctr_avance','ctr_adj'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('sel');});
}

// ‚îÄ‚îÄ TACTIQUE ADVERSE ‚îÄ‚îÄ
function selectOppTactic(i){
  document.querySelectorAll('[id^="topp-"]').forEach(c=>c.classList.remove('selected'));
  const el=document.getElementById('topp-'+i);if(el)el.classList.add('selected');
  const t=TACTICS[currentFormat][i];
  document.getElementById('oppTacticLabel').textContent=`üî¥ Adverse : ${t.name} ‚Äî ${t.desc}`;
  addEventToLog('üî¥',`Tactique adverse estim√©e : ${t.name}`);
}

// ‚îÄ‚îÄ CENTRE MODAL ‚îÄ‚îÄ
let _centrePied='', _centreType='';
function openCentreModal(){
  _centrePied='';_centreType='';
  ['centrePied_d','centrePied_g','centreRentrant','centreSortant','centreTendu','centreLobe'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('centreurSelect').innerHTML=opts;
  document.getElementById('modalCentre').classList.add('open');
}
function selectCentrePied(p){
  _centrePied=p;
  document.getElementById('centrePied_d').classList.toggle('sel',p==='Pied droit');
  document.getElementById('centrePied_g').classList.toggle('sel',p==='Pied gauche');
}
function selectCentreType(t){
  _centreType=t;
  ['centreRentrant','centreSortant','centreTendu','centreLobe'].forEach(id=>document.getElementById(id).classList.remove('sel'));
  const map={'Rentrant':'centreRentrant','Sortant':'centreSortant','Tendu':'centreTendu','Lob√©':'centreLobe'};
  if(map[t])document.getElementById(map[t]).classList.add('sel');
}
function confirmCentre(withDetail){
  const sel=document.getElementById('centreurSelect');
  const centreur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Centre';
  if(withDetail){
    if(centreur)text+=` ‚Äî ${centreur}`;
    if(_centrePied)text+=` (${_centrePied}`;
    if(_centreType)text+=_centrePied?`, ${_centreType})`:` (${_centreType})`;
    else if(_centrePied)text+=')';
  }
  incrementCount('CENTRE');
  addEventToLog('üìê',text);
  closeModal('modalCentre');
}
function makeJerseySVG(color, numColor, num) {
  return '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">'
    + '<path d="M8 10 L2 18 L8 20 L8 36 L32 36 L32 20 L38 18 L32 10 C28 8 26 6 20 6 C14 6 12 8 8 10Z" fill="' + color + '" stroke="rgba(0,0,0,0.5)" stroke-width="1.5"/>'
    + '<path d="M14 7 C14 12 26 12 26 7" fill="rgba(255,255,255,0.15)"/>'
    + '<text x="20" y="25" text-anchor="middle" font-family="Bebas Neue,sans-serif" font-size="12" fill="' + numColor + '">' + num + '</text>'
    + '</svg>';
}
function renderPitch(){
  if(selectedTactic===null)return;
  const tactic=TACTICS[currentFormat][selectedTactic];
  const tokenContainer=document.getElementById('playerTokens');
  if(!tokenContainer)return;
  tokenContainer.innerHTML='';
  const posMap={};
  roster.forEach(function(p){if(!posMap[p.pos])posMap[p.pos]=[];posMap[p.pos].push(p);});
  const posUsed={};
  tactic.positions.forEach(function(slot){
    var div=document.createElement('div');
    div.className='player-token';
    div.style.left=slot.x+'%';
    div.style.top=slot.y+'%';
    var k=slot.pos;
    if(!posUsed[k])posUsed[k]=0;
    var candidates=(posMap[k]||[]);
    var player=candidates[posUsed[k]];
    posUsed[k]=(posUsed[k]||0)+1;
    var isOut=player&&player.status==='out';
    var isBench=player&&player.status==='bench';
    var jerseyColor=isOut?'#FF6B00':isBench?'#6B7A8D':'#00E676';
    var numColor=isBench?'#fff':'#000';
    var num=player?player.num:'';
    var shortName=player?(player.name.split(' ').pop().substring(0,8)):slot.pos;
    var wrap=document.createElement('div');
    wrap.className='jersey-wrap';
    wrap.innerHTML=makeJerseySVG(jerseyColor,numColor,num);
    div.appendChild(wrap);
    var lbl=document.createElement('div');
    lbl.className='token-name';
    lbl.textContent=shortName;
    div.appendChild(lbl);
    if(player){
      (function(pid){div.onclick=function(){openEditPlayerModal(pid);};})(player.id);
    }
    tokenContainer.appendChild(div);
  });
}

function buildRapport(){
  const tacticInfo=selectedTactic!==null?TACTICS[currentFormat][selectedTactic].name+' ('+currentFormat+'v'+currentFormat+')':'Non d√©finie';
  const statsList=[
    ['üéØ','Tirs cadr√©s','TIR_CADRE'],['‚ÜóÔ∏è','Tirs non cadr√©s','TIR_NON_CADRE'],
    ['üî•','Occasions franches','OCCASION'],['üíî','Pertes de balle','PERTE'],
    ['üí™','R√©cup√©rations','RECUP'],['üèÜ','Duels gagn√©s','DUEL_GAGNE'],
    ['‚ùå','Duels perdus','DUEL_PERDU'],['üö©','Corners','CORNER'],
    ['‚ö°','Contre-attaques','CONTRE'],['ü¶æ','Pressing haut','PRESSING'],
    ['üü®','Cartons jaunes','JAUNE'],['üü•','Cartons rouges','ROUGE'],
  ];
  const goalsEv=events.filter(e=>e.text.includes('BUT !'));
  const subSec=substitutions.length?`<div class="section-title">Remplacements (${substitutions.length})</div>`+
    substitutions.map(s=>{const pO=roster.find(p=>p.id===s.outId);const pI=roster.find(p=>p.id===s.inId);
      return `<div class="stat-row"><span class="stat-label">‚è± ${s.time} MT${s.half}</span><span style="font-family:var(--fd);font-size:12px;color:var(--text);">üî¥ ${pO?pO.name:'?'} ‚Üí üü¢ ${pI?pI.name:'?'}</span></div>`;}).join(''):'';
  const ptSec=roster.length?`<div class="section-title">‚è± Temps de jeu</div>`+
    [...roster].sort((a,b)=>calcPlaytime(b)-calcPlaytime(a)).map(p=>{
      const m=Math.floor(calcPlaytime(p)/60);
      return `<div class="stat-row"><span class="stat-label">${p.num} ${p.name} <span style="font-size:10px;margin-left:4px;">${p.pos}</span></span><span class="stat-value" style="font-size:18px;">${m}<span style="font-size:11px;color:var(--muted);"> min</span></span></div>`;}).join(''):'';
  const oppSec=oppRoster.length?`<div class="section-title">üî¥ Joueurs adverses not√©s</div>`+
    oppRoster.map(p=>`<div class="stat-row"><span class="stat-label">${p.num} ${p.name} <span style="font-size:10px">${p.pos}</span></span><span style="font-family:var(--fd);font-size:12px;color:var(--yellow);text-align:right;max-width:140px;">${p.note||''}</span></div>`).join('')+
    (oppEvents.length?`<div style="margin-top:6px;">`+oppEvents.map(e=>`<div class="stat-row"><span class="stat-label">‚è± ${e.time} MT${e.half}</span><span style="font-family:var(--fd);font-size:12px;color:var(--red);">${e.icon} ${e.text}</span></div>`).join('')+'</div>':'')
    :'';
  document.getElementById('rapportContent').innerHTML=`
    <div class="stat-row" style="background:linear-gradient(135deg,#002a1a,#004d2e);border-color:#006b3c;margin-bottom:12px;">
      <span class="stat-label" style="font-size:16px;color:var(--green);">‚öΩ Score final</span>
      <span class="stat-value" style="font-size:34px;color:var(--green);">${scoreHome} ‚Äî ${scoreAway}</span>
    </div>
    <div class="stat-row"><span class="stat-label">üìã Tactique</span><span style="font-family:var(--fd);font-size:16px;font-weight:900;color:var(--accent);">${tacticInfo}</span></div>
    ${statsList.map(([icon,label,key])=>`<div class="stat-row"><span class="stat-label">${icon} ${label}</span><span class="stat-value">${counts[key]||0}</span></div>`).join('')}
    ${goalsEv.length?`<div class="section-title">Buts marqu√©s</div>${goalsEv.map(e=>`<div class="stat-row"><span class="stat-label">‚è± ${e.time} MT${e.half}</span><span style="color:var(--green);font-family:var(--fd);font-size:13px;font-weight:700;">${e.text}</span></div>`).join('')}`:''}
    ${subSec}${ptSec}${oppSec}`;
}

function exportReport(){
  const comp=document.getElementById('setupComp').value||'Match';
  const date=new Date().toLocaleDateString('fr-FR');
  const home=document.getElementById('teamHomeName').textContent;
  const away=document.getElementById('teamAwayName').textContent;
  const tac=selectedTactic!==null?TACTICS[currentFormat][selectedTactic].name+' ('+currentFormat+'v'+currentFormat+')':'Non d√©finie';
  let txt=`=== RAPPORT DE MATCH ===\n${comp} ‚Äî ${date}\n${home} ${scoreHome} ‚Äî ${scoreAway} ${away}\nTactique : ${tac}\n\n`;
  txt+=`--- STATISTIQUES ---\n`;
  [['Tirs cadr√©s','TIR_CADRE'],['Tirs non cadr√©s','TIR_NON_CADRE'],['Occasions','OCCASION'],
   ['Pertes','PERTE'],['R√©cup√©rations','RECUP'],['Duels gagn√©s','DUEL_GAGNE'],
   ['Duels perdus','DUEL_PERDU'],['Corners','CORNER'],['Contre-attaques','CONTRE'],
   ['Pressing','PRESSING'],['Cartons jaunes','JAUNE'],['Cartons rouges','ROUGE']]
   .forEach(([k,v])=>txt+=`${k}: ${counts[v]||0}\n`);
  txt+=`\n--- TEMPS DE JEU ---\n`;
  roster.forEach(p=>txt+=`${p.num} ${p.name} (${p.pos}): ${Math.floor(calcPlaytime(p)/60)}min\n`);
  txt+=`\n--- REMPLACEMENTS ---\n`;
  if(substitutions.length)substitutions.forEach(s=>{
    const pO=roster.find(p=>p.id===s.outId);const pI=roster.find(p=>p.id===s.inId);
    txt+=`${s.time} MT${s.half} ‚Äî OUT: ${pO?pO.num+' '+pO.name:'?'} | IN: ${pI?pI.num+' '+pI.name:'?'}\n`;
  });else txt+='Aucun\n';
  txt+=`\n--- JOUEURS ADVERSES ---\n`;
  if(oppRoster.length)oppRoster.forEach(p=>txt+=`${p.num} ${p.name} (${p.pos})${p.note?' ‚Äî '+p.note:''}\n`);
  else txt+='Aucun\n';
  txt+=`\n--- √âV√âNEMENTS ADVERSES ---\n`;
  if(oppEvents.length)[...oppEvents].reverse().forEach(e=>txt+=`[${e.time} MT${e.half}] ${e.icon} ${e.text}\n`);
  else txt+='Aucun\n';
  txt+=`\n--- JOURNAL ---\n`;
  [...events].reverse().forEach(e=>txt+=`[${e.time} MT${e.half}] ${e.icon} ${e.text}${e.zone?' ('+e.zone+')':''}\n`);
  txt+=`\n--- NOTES 1√®re MT ---\n${document.getElementById('notes1').value||'‚Äî'}\n`;
  txt+=`\n--- NOTES 2√®me MT ---\n${document.getElementById('notes2').value||'‚Äî'}\n`;
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`rapport-${date.replace(/\//g,'-')}.txt`;a.click();
  alert('Rapport export√© !');
}

// ===== OPPONENT ROSTER =====
let oppEvents=[];
function addOppEvent(ev){oppEvents.unshift(ev);renderOppEvents();}
function renderOppEvents(){
  const el=document.getElementById('oppEventLog');
  if(!el)return;
  if(!oppEvents.length){el.innerHTML='<div class="empty-log">Aucun √©v√©nement adverse</div>';return;}
  el.innerHTML=oppEvents.map(e=>`
    <div class="log-item">
      <span class="log-time">${e.time}</span>
      <span class="log-icon">${e.icon}</span>
      <span class="log-text">${e.text}</span>
      <span style="font-family:var(--fd);font-size:10px;color:var(--muted);">${e.half}√®me</span>
    </div>`).join('');
}
function openAddOppModal(){
  document.getElementById('newOppNum').value='';
  document.getElementById('newOppName').value='';
  document.getElementById('newOppNote').value='';
  document.getElementById('modalAddOpp').classList.add('open');
}
function confirmAddOpp(){
  const num=document.getElementById('newOppNum').value.trim();
  const name=document.getElementById('newOppName').value.trim();
  const pos=document.getElementById('newOppPos').value;
  const note=document.getElementById('newOppNote').value.trim();
  if(!name){alert('Nom requis');return;}
  oppRoster.push({id:Date.now(),num:num||'?',name,pos,note});
  renderOppRoster();closeModal('modalAddOpp');
}
function renderOppRoster(){
  const list=document.getElementById('oppRosterList');
  if(!oppRoster.length){list.innerHTML='<div class="empty-log">Aucun joueur adverse saisi</div>';return;}
  const sorted=[...oppRoster].sort((a,b)=>(parseInt(a.num)||99)-(parseInt(b.num)||99));
  list.innerHTML=sorted.map(p=>`
    <div class="roster-item">
      <div class="player-num" style="color:var(--red);">${p.num}</div>
      <div class="player-info">
        <div class="player-pname">${p.name}</div>
        <div class="player-pos">${p.pos}${p.note?` ¬∑ <span style="color:var(--yellow);font-size:10px;">${p.note}</span>`:''}</div>
      </div>
      <button class="btn-sub" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-size:15px;padding:6px 8px;" onclick="openEditOppModal(${p.id})">‚úèÔ∏è</button>
    </div>`).join('');
}
function openEditOppModal(id){
  const p=oppRoster.find(x=>x.id===id);if(!p)return;
  document.getElementById('editOppId').value=id;
  document.getElementById('editOppNum').value=p.num;
  document.getElementById('editOppName').value=p.name;
  document.getElementById('editOppPos').value=p.pos;
  document.getElementById('editOppNote').value=p.note||'';
  document.getElementById('modalEditOpp').classList.add('open');
}
function confirmEditOpp(){
  const id=parseInt(document.getElementById('editOppId').value);
  const p=oppRoster.find(x=>x.id===id);if(!p)return;
  p.num=document.getElementById('editOppNum').value.trim()||'?';
  p.name=document.getElementById('editOppName').value.trim();
  p.pos=document.getElementById('editOppPos').value;
  p.note=document.getElementById('editOppNote').value.trim();
  if(!p.name){alert('Nom requis');return;}
  renderOppRoster();closeModal('modalEditOpp');
}
function deleteOpp(id){
  if(!confirm('Supprimer ce joueur adverse ?'))return;
  oppRoster=oppRoster.filter(p=>p.id!==id);
  renderOppRoster();closeModal('modalEditOpp');
}

// ===== OPPONENT GOAL =====
function openOpponentGoalModal(){ openOppGoalEnrichedModal(); }
function openOppGoalEnrichedModal(){
  _ogBody='';_ogZone=0;
  ['ogPied_d','ogPied_g','ogTete'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('oggz'+i);if(el)el.classList.remove('sel');}
  const opts='<option value="">‚Äî Inconnu ‚Äî</option>'+oppRoster.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('oppGoalScorerSelect').innerHTML=opts;
  document.getElementById('oppGoalAssistSelect').innerHTML=opts;
  document.getElementById('modalOppGoal').classList.add('open');
}
let _ogBody='', _ogZone=0;
function selectOgBody(b){
  _ogBody=b;
  document.getElementById('ogPied_d').classList.toggle('sel',b==='Pied droit');
  document.getElementById('ogPied_g').classList.toggle('sel',b==='Pied gauche');
  document.getElementById('ogTete').classList.toggle('sel',b==='T√™te');
}
function selectOgZone(z){
  _ogZone=z;
  for(let i=1;i<=6;i++)document.getElementById('oggz'+i).classList.remove('sel');
  document.getElementById('oggz'+z).classList.add('sel');
}
function confirmOppGoal(){ confirmOppGoalEnriched(false); }
function confirmOppGoalEnriched(withDetail){
  const zl={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  const ss=document.getElementById('oppGoalScorerSelect');
  const sa=document.getElementById('oppGoalAssistSelect');
  const scorer=ss.value?ss.options[ss.selectedIndex].text:'';
  const assist=sa.value?sa.options[sa.selectedIndex].text:'';
  let text='But encaiss√©';
  if(scorer)text+=` ‚Äî ${scorer} (ADV)`;
  if(withDetail){
    if(_ogBody)text+=` (${_ogBody})`;
    if(_ogZone)text+=` [${zl[_ogZone]}]`;
  }
  if(assist)text+=` (passe: ${assist})`;
  incrementCount('ENCAISSE');
  scoreAway++;document.getElementById('scoreAwayEl').textContent=scoreAway;
  const ev=addEventToLog('üî¥',text);
  addOppEvent(ev);
  closeModal('modalOppGoal');
}

// ===== CARTON BLANC =====
let _cbTeam='own';
const _cbSuspensions=[]; // {playerId, startSeconds, endSeconds}
function openCartonBlancModal(){
  _cbTeam='own';
  switchCbTeam('own');
  document.getElementById('modalCartonBlanc').classList.add('open');
}
function switchCbTeam(side){
  _cbTeam=side;
  document.getElementById('cbTeamOwn').classList.toggle('sel',side==='own');
  document.getElementById('cbTeamOpp').classList.toggle('sel',side==='opp');
  const note=document.getElementById('cbPlaytimeNote');
  if(side==='own'){
    const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
    document.getElementById('cbPlayerSelect').innerHTML=opts;
    note.style.display='';
  } else {
    const opts='<option value="">‚Äî Inconnu ‚Äî</option>'+oppRoster.map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
    document.getElementById('cbPlayerSelect').innerHTML=opts;
    note.style.display='none';
  }
}
function confirmCartonBlanc(){
  const sel=document.getElementById('cbPlayerSelect');
  const playerId=sel.value;
  const playerName=sel.value?sel.options[sel.selectedIndex].text:'';
  const side=_cbTeam;
  let text='Carton blanc (10 min)';
  if(playerName) text+=` ‚Äî ${playerName}${side==='opp'?' (ADV)':''}`;
  // Suspendre le temps de jeu du joueur pendant 10 min si c'est notre joueur
  if(side==='own' && playerId){
    const p=roster.find(r=>r.id==playerId);
    if(p){
      p.status='suspended';
      p.suspendedUntil=seconds+(10*60);
      renderRoster();
    }
  }
  incrementCount('BLANC');
  addEventToLog('‚¨ú',text);
  closeModal('modalCartonBlanc');
}
// V√©rification des suspensions √† chaque tick (appel√© depuis tickPlaytimes)
function checkSuspensions(){
  roster.forEach(p=>{
    if(p.status==='suspended' && p.suspendedUntil && seconds>=p.suspendedUntil){
      p.status='field';
      p.suspendedUntil=null;
      addEventToLog('‚úÖ',`Retour apr√®s exclusion ‚Äî ${p.num} ${p.name}`);
      renderRoster();
    }
  });
}

// ===== BANNER =====
function applyBannerSetup(){
  const home=document.getElementById('bannerHome').value.trim();
  const away=document.getElementById('bannerAway').value.trim();
  if(home)document.getElementById('setupHome').value=home;
  if(away)document.getElementById('setupAway').value=away;
  applySetup(true);
  dismissBanner();
}
function dismissBanner(){
  document.getElementById('setupBanner').style.display='none';
}

// ===== TIR CADR√â =====
let _tcBody='', _tcZone=0;
function openTirCadreModal(){
  _tcBody='';_tcZone=0;
  ['tcPied_d','tcPied_g','tcTete'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('tcgz'+i);if(el)el.classList.remove('sel');}
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('tcTireurSelect').innerHTML=opts;
  document.getElementById('tcPasseurSelect').innerHTML=opts.replace('‚Äî Optionnel ‚Äî','‚Äî Aucun ‚Äî');
  document.getElementById('modalTirCadre').classList.add('open');
}
function selectTcBody(b){
  _tcBody=b;
  document.getElementById('tcPied_d').classList.toggle('sel',b==='Pied droit');
  document.getElementById('tcPied_g').classList.toggle('sel',b==='Pied gauche');
  document.getElementById('tcTete').classList.toggle('sel',b==='T√™te');
}
function selectTcZone(z){
  _tcZone=z;
  for(let i=1;i<=6;i++)document.getElementById('tcgz'+i).classList.remove('sel');
  document.getElementById('tcgz'+z).classList.add('sel');
}
function confirmTirCadre(withDetail){
  const zl={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  const sel1=document.getElementById('tcTireurSelect');
  const sel2=document.getElementById('tcPasseurSelect');
  const tireur=sel1.value?sel1.options[sel1.selectedIndex].text:'';
  const passeur=sel2.value?sel2.options[sel2.selectedIndex].text:'';
  let text='Tir cadr√©';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_tcBody)text+=` (${_tcBody})`;
    if(_tcZone)text+=` [${zl[_tcZone]}]`;
    if(passeur)text+=` (passe: ${passeur})`;
  }
  incrementCount('TIR_CADRE');
  addEventToLog('üéØ',text);
  closeModal('modalTirCadre');
}

// ===== TIR RAT√â =====
let _trDest='';
const TIR_RATE_IDS=['tr_cote_g','tr_dessus','tr_cote_d','tr_poteau_g','tr_poteau_d','tr_barre'];
const TIR_RATE_MAP={'√Ä c√¥t√© gauche':'tr_cote_g','Au-dessus':'tr_dessus','√Ä c√¥t√© droit':'tr_cote_d','Poteau gauche':'tr_poteau_g','Poteau droit':'tr_poteau_d','Barre transversale':'tr_barre'};
function openTirRateModal(){
  _trDest='';
  TIR_RATE_IDS.forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('trTireurSelect').innerHTML=opts;
  document.getElementById('modalTirRate').classList.add('open');
}
function selectTrDest(d){
  _trDest=d;
  TIR_RATE_IDS.forEach(id=>document.getElementById(id).classList.remove('sel'));
  if(TIR_RATE_MAP[d])document.getElementById(TIR_RATE_MAP[d]).classList.add('sel');
}
function confirmTirRate(withDetail){
  const sel=document.getElementById('trTireurSelect');
  const tireur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Tir non cadr√©';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_trDest)text+=` (${_trDest})`;
  }
  incrementCount('TIR_NON_CADRE');
  addEventToLog('‚ÜóÔ∏è',text);
  closeModal('modalTirRate');
}

// ===== PENALTY RAT√â OFFENSIF =====
let _proDest='';
const PRO_IDS=['pro_cote_g','pro_dessus','pro_cote_d','pro_poteau_g','pro_poteau_d','pro_barre','pro_arrete'];
const PRO_MAP={'√Ä c√¥t√© gauche':'pro_cote_g','Au-dessus':'pro_dessus','√Ä c√¥t√© droit':'pro_cote_d','Poteau gauche':'pro_poteau_g','Poteau droit':'pro_poteau_d','Barre transversale':'pro_barre','Arr√™t√© gardien':'pro_arrete'};
function openPenaltyRateOffModal(){
  _proDest='';
  PRO_IDS.forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('proTireurSelect').innerHTML=opts;
  document.getElementById('modalPenaltyRateOff').classList.add('open');
}
function selectProDest(d){
  _proDest=d;
  PRO_IDS.forEach(id=>document.getElementById(id).classList.remove('sel'));
  if(PRO_MAP[d])document.getElementById(PRO_MAP[d]).classList.add('sel');
}
function confirmPenaltyRateOff(withDetail){
  const sel=document.getElementById('proTireurSelect');
  const tireur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Penalty rat√©';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_proDest)text+=` (${_proDest})`;
  }
  incrementCount('PENALTY_RATE');
  addEventToLog('‚ùå',text);
  closeModal('modalPenaltyRateOff');
}

// ===== ARR√äT GARDIEN =====
let _agType='', _agZone=0;
function openArretGardienModal(){
  _agType='';_agZone=0;
  ['agMain_d','agMain_g','agDeuxMains','agPied','agPlongeon'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('aggz'+i);if(el)el.classList.remove('sel');}
  const gk=roster.filter(p=>p.status==='field');
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+gk.map(p=>`<option value="${p.id}"${p.pos==='GK'?' selected':''}>${p.num} ‚Äì ${p.name}${p.pos==='GK'?' (GK)':''}</option>`).join('');
  document.getElementById('agGardienSelect').innerHTML=opts;
  document.getElementById('modalArretGardien').classList.add('open');
}
function selectAgType(t){
  _agType=t;
  ['agMain_d','agMain_g','agDeuxMains','agPied','agPlongeon'].forEach(id=>document.getElementById(id).classList.remove('sel'));
  const map={'Main droite':'agMain_d','Main gauche':'agMain_g','Deux mains':'agDeuxMains','Pied':'agPied','Plongeon':'agPlongeon'};
  if(map[t])document.getElementById(map[t]).classList.add('sel');
}
function selectAgZone(z){
  _agZone=z;
  for(let i=1;i<=6;i++)document.getElementById('aggz'+i).classList.remove('sel');
  document.getElementById('aggz'+z).classList.add('sel');
}
function confirmArretGardien(withDetail){
  const zl={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  const sel=document.getElementById('agGardienSelect');
  const gardien=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Arr√™t du gardien';
  if(withDetail){
    if(gardien)text+=` ‚Äî ${gardien}`;
    if(_agType)text+=` (${_agType})`;
    if(_agZone)text+=` [tir: ${zl[_agZone]}]`;
  }
  incrementCount('ARRET_GK');
  addEventToLog('üß§',text);
  closeModal('modalArretGardien');
}

// ===== PENALTY RAT√â ADVERSE =====
let _praDest='';
function openPenaltyRateAdverseModal(){
  _praDest='';
  ['pra_cote_g','pra_dessus','pra_cote_d','pra_poteau_g','pra_poteau_d','pra_barre','pra_arrete']
    .forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  document.getElementById('modalPenaltyRateAdverse').classList.add('open');
}
function selectPraDest(dest){
  _praDest=dest;
  ['pra_cote_g','pra_dessus','pra_cote_d','pra_poteau_g','pra_poteau_d','pra_barre','pra_arrete']
    .forEach(id=>document.getElementById(id).classList.remove('sel'));
  const map={
    '√Ä c√¥t√© gauche':'pra_cote_g','Au-dessus':'pra_dessus','√Ä c√¥t√© droit':'pra_cote_d',
    'Poteau gauche':'pra_poteau_g','Poteau droit':'pra_poteau_d',
    'Barre transversale':'pra_barre','Arr√™t√© gardien':'pra_arrete'
  };
  if(map[dest])document.getElementById(map[dest]).classList.add('sel');
}
function confirmPenaltyRateAdverse(withDetail){
  let text='Penalty rat√© (adverse)';
  if(withDetail && _praDest) text+=` ‚Äî ${_praDest}`;
  incrementCount('PENALTY_RATE_ADV');
  addEventToLog('üö´',text);
  closeModal('modalPenaltyRateAdverse');
}

// ===== PENALTY MARQU√â =====
let _pmPied='', _pmZone=0;
function openPenaltyMarqueModal(){
  _pmPied='';_pmZone=0;
  ['pmPied_d','pmPied_g'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('pmgz'+i);if(el)el.classList.remove('sel');}
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('pmTireurSelect').innerHTML=opts;
  document.getElementById('modalPenaltyMarque').classList.add('open');
}
function selectPmPied(p){
  _pmPied=p;
  document.getElementById('pmPied_d').classList.toggle('sel',p==='Pied droit');
  document.getElementById('pmPied_g').classList.toggle('sel',p==='Pied gauche');
}
function selectPmZone(z){
  _pmZone=z;
  for(let i=1;i<=6;i++)document.getElementById('pmgz'+i).classList.remove('sel');
  document.getElementById('pmgz'+z).classList.add('sel');
}
function confirmPenaltyMarque(withDetail){
  const zoneLabels={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  const sel=document.getElementById('pmTireurSelect');
  const tireur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='‚öΩ Penalty marqu√©';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_pmPied)text+=` (${_pmPied})`;
    if(_pmZone)text+=` [${zoneLabels[_pmZone]}]`;
  }
  incrementCount('PENALTY_MRQ');
  scoreHome++;
  document.getElementById('scoreHomeEl').textContent=scoreHome;
  addEventToLog('‚öΩ',text);
  closeModal('modalPenaltyMarque');
}

// ===== PENALTY ARR√äT√â =====
let _paType='', _paZone=0;
function openPenaltyArret√©Modal(){
  _paType='';_paZone=0;
  ['paMain_d','paMain_g','paDeuxMains','paPied'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('pagz'+i);if(el)el.classList.remove('sel');}
  // Propose le gardien en premier
  const gk=roster.filter(p=>p.status==='field');
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+gk.map(p=>`<option value="${p.id}"${p.pos==='GK'?' selected':''}">${p.num} ‚Äì ${p.name}${p.pos==='GK'?' (GK)':''}</option>`).join('');
  document.getElementById('paTireurSelect').innerHTML=opts;
  document.getElementById('modalPenaltyArrete').classList.add('open');
}
function selectPaType(type){
  _paType=type;
  ['paMain_d','paMain_g','paDeuxMains','paPied'].forEach(id=>document.getElementById(id).classList.remove('sel'));
  const map={'Main droite':'paMain_d','Main gauche':'paMain_g','Deux mains':'paDeuxMains','Pied':'paPied'};
  if(map[type])document.getElementById(map[type]).classList.add('sel');
}
function selectPaZone(z){
  _paZone=z;
  for(let i=1;i<=6;i++)document.getElementById('pagz'+i).classList.remove('sel');
  document.getElementById('pagz'+z).classList.add('sel');
}
function confirmPenaltyArrete(withDetail){
  const zoneLabels={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  const sel=document.getElementById('paTireurSelect');
  const gardien=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Penalty arr√™t√©';
  if(withDetail){
    if(gardien)text+=` ‚Äî ${gardien}`;
    if(_paType)text+=` (${_paType})`;
    if(_paZone)text+=` [tir: ${zoneLabels[_paZone]}]`;
  }
  incrementCount('PENALTY_ARR');
  addEventToLog('üß§',text);
  closeModal('modalPenaltyArrete');
}

// ===== GOAL BODY PART & ZONE =====
let _goalBodyPart='', _goalZone=0;
function selectBodyPart(part){
  _goalBodyPart=part;
  ['Pied_d','Pied_g','Tete'].forEach(k=>document.getElementById('body'+k).classList.remove('sel'));
  const map={'Pied droit':'Pied_d','Pied gauche':'Pied_g','T√™te':'Tete'};
  if(map[part])document.getElementById('body'+map[part]).classList.add('sel');
}
function selectGoalZone(z){
  _goalZone=z;
  for(let i=1;i<=6;i++)document.getElementById('gz'+i).classList.remove('sel');
  document.getElementById('gz'+z).classList.add('sel');
}
function openGoalModal(){
  _goalBodyPart='';_goalZone=0;
  ['Pied_d','Pied_g','Tete'].forEach(k=>{const el=document.getElementById('body'+k);if(el)el.classList.remove('sel');});
  for(let i=1;i<=6;i++){const el=document.getElementById('gz'+i);if(el)el.classList.remove('sel');}
  populateSelect('goalScorerSelect',true,false);
  populateSelect('goalAssistSelect',true,true);
  document.getElementById('modalGoal').classList.add('open');
}
function confirmGoal(){
  const ss=document.getElementById('goalScorerSelect');
  const sa=document.getElementById('goalAssistSelect');
  const scorer=ss.value?ss.options[ss.selectedIndex].text:'';
  const assist=sa.value?sa.options[sa.selectedIndex].text:'';
  const zoneLabels={1:'Haut gauche',2:'Haut centre',3:'Haut droite',4:'Bas gauche',5:'Bas centre',6:'Bas droite'};
  let text='BUT !';
  if(scorer)text+=` ‚Äî ${scorer}`;
  if(_goalBodyPart)text+=` (${_goalBodyPart})`;
  if(_goalZone)text+=` [${zoneLabels[_goalZone]}]`;
  if(assist)text+=` (passe: ${assist})`;
  incrementCount('BUT');scoreHome++;
  document.getElementById('scoreHomeEl').textContent=scoreHome;
  addEventToLog('üü¢',text);closeModal('modalGoal');
}

// ===== TERRAIN 18 ZONES =====
function selectZoneField(num, el){
  selectedZone='Zone '+num;
  document.querySelectorAll('.btn-zone-field').forEach(b=>b.classList.remove('selected'));
  if(el)el.classList.add('selected');
  const cat=num<=6?'üî¥ D√âFENSE':num<=12?'üü† MILIEU':'üü¢ ATTAQUE';
  document.getElementById('selectedZoneLabel').textContent=`üìç Zone ${num} ‚Äî ${cat}`;
}

// ===== COUP FRANC =====
let _cfPied='';
function openCoupFrancModal(){
  _cfPied='';
  ['Pied_d','Pied_g'].forEach(k=>{const el=document.getElementById('cfPied_'+k.split('_')[1]);if(el)el.classList.remove('sel');});
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('cfTireurSelect').innerHTML=opts;
  document.getElementById('modalCoupFranc').classList.add('open');
}
function selectCfPied(pied){
  _cfPied=pied;
  document.getElementById('cfPied_d').classList.toggle('sel',pied==='Pied droit');
  document.getElementById('cfPied_g').classList.toggle('sel',pied==='Pied gauche');
}
function confirmCoupFranc(withDetail){
  const sel=document.getElementById('cfTireurSelect');
  const tireur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Coup franc';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_cfPied)text+=` (${_cfPied})`;
  }
  incrementCount('COUP_FRANC');
  addEventToLog('üéØ',text);
  closeModal('modalCoupFranc');
}

// ===== CORNER =====
let _cornerPied='', _cornerEffet='';
function openCornerModal(){
  _cornerPied='';_cornerEffet='';
  ['cornerPied_d','cornerPied_g','cornerRentrant','cornerSortant'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('sel');});
  const opts='<option value="">‚Äî Optionnel ‚Äî</option>'+roster.filter(p=>p.status==='field').map(p=>`<option value="${p.id}">${p.num} ‚Äì ${p.name}</option>`).join('');
  document.getElementById('cornerTireurSelect').innerHTML=opts;
  document.getElementById('modalCorner').classList.add('open');
}
function selectCornerPied(pied){
  _cornerPied=pied;
  document.getElementById('cornerPied_d').classList.toggle('sel',pied==='Pied droit');
  document.getElementById('cornerPied_g').classList.toggle('sel',pied==='Pied gauche');
}
function selectCornerEffet(effet){
  _cornerEffet=effet;
  document.getElementById('cornerRentrant').classList.toggle('sel',effet==='Rentrant');
  document.getElementById('cornerSortant').classList.toggle('sel',effet==='Sortant');
}
function confirmCorner(withDetail){
  const sel=document.getElementById('cornerTireurSelect');
  const tireur=sel.value?sel.options[sel.selectedIndex].text:'';
  let text='Corner';
  if(withDetail){
    if(tireur)text+=` ‚Äî ${tireur}`;
    if(_cornerPied)text+=` (${_cornerPied}`;
    if(_cornerEffet)text+=_cornerPied?`, ${_cornerEffet})`:` (${_cornerEffet})`;
    else if(_cornerPied)text+=')';
  }
  incrementCount('CORNER');
  addEventToLog('üö©',text);
  closeModal('modalCorner');
}

// ===== SCORE EDIT =====
function openScoreEdit(){
  document.getElementById('scoreEditHome').value=scoreHome;
  document.getElementById('scoreEditAway').value=scoreAway;
  document.getElementById('scoreEditHomeLabel').textContent=document.getElementById('teamHomeName').textContent;
  document.getElementById('scoreEditAwayLabel').textContent=document.getElementById('teamAwayName').textContent;
  document.getElementById('modalScoreEdit').classList.add('open');
}
function confirmScoreEdit(){
  const h=parseInt(document.getElementById('scoreEditHome').value);
  const a=parseInt(document.getElementById('scoreEditAway').value);
  if(isNaN(h)||isNaN(a)||h<0||a<0){alert('Scores invalides');return;}
  const oldH=scoreHome,oldA=scoreAway;
  scoreHome=h;scoreAway=a;
  document.getElementById('scoreHomeEl').textContent=scoreHome;
  document.getElementById('scoreAwayEl').textContent=scoreAway;
  addEventToLog('‚úèÔ∏è',`Score corrig√© : ${oldH}‚Äî${oldA} ‚Üí ${h}‚Äî${a}`,'');
  closeModal('modalScoreEdit');
}

// ===== SETUP =====
function setMatchLocation(loc, el) {
  matchLocation = loc;
  document.querySelectorAll('#btnDomicile,#btnExterieur,#btnNeutre').forEach(function(b){ b.classList.remove('sel'); });
  if(el) el.classList.add('sel');
  updateLocationBadge();
}

function setMatchLocation(loc, el) {
  matchLocation = loc;
  document.querySelectorAll('#loc-domicile,#loc-exterieur,#loc-neutre').forEach(function(b){ b.classList.remove('sel'); });
  if(el) el.classList.add('sel');
  updateLocationBadge();
  // Swap score display if ext√©rieur (nous = right side)
  var homeNameEl = document.getElementById('teamHomeName');
  var awayNameEl = document.getElementById('teamAwayName');
  if(homeNameEl && awayNameEl) {
    var setupHome = document.getElementById('setupHome');
    var setupAway = document.getElementById('setupAway');
    var homeName = (setupHome ? setupHome.value.trim() : '') || 'NOUS';
    var awayName = (setupAway ? setupAway.value.trim() : '') || 'ADV';
    homeNameEl.textContent = homeName.substring(0,8).toUpperCase();
    awayNameEl.textContent = awayName.substring(0,8).toUpperCase();
  }
}

function updateLocationBadge() {
  var badge = document.getElementById('locationBadge');
  if(!badge) return;
  var icons = {domicile:'üè†', exterieur:'‚úàÔ∏è', neutre:'‚öñÔ∏è'};
  var labels = {domicile:'DOMICILE', exterieur:'EXT√âRIEUR', neutre:'NEUTRE'};
  var colors = {domicile:'rgba(0,230,118,0.15)', exterieur:'rgba(0,184,255,0.15)', neutre:'rgba(255,214,0,0.15)'};
  var borderColors = {domicile:'rgba(0,230,118,0.35)', exterieur:'rgba(0,184,255,0.35)', neutre:'rgba(255,214,0,0.35)'};
  var textColors = {domicile:'var(--accent)', exterieur:'var(--blue)', neutre:'var(--yellow)'};
  badge.textContent = icons[matchLocation] + ' ' + labels[matchLocation];
  badge.style.background = colors[matchLocation];
  badge.style.borderColor = borderColors[matchLocation];
  badge.style.color = textColors[matchLocation];
}
function applySetup(silent){
  const home=document.getElementById('setupHome').value.trim()||'NOUS';
  const away=document.getElementById('setupAway').value.trim()||'ADV';
  document.getElementById('teamHomeName').textContent=home.substring(0,8).toUpperCase();
  document.getElementById('teamAwayName').textContent=away.substring(0,8).toUpperCase();
  updateLocationBadge();
  if(!silent)alert('‚úì Appliqu√© !');
}
function fullReset(){
  if(!confirm('Effacer tout et recommencer ?'))return;
  events=[];counts={};substitutions=[];roster=[];oppRoster=[];oppEvents=[];
  scoreHome=0;scoreAway=0;seconds=0;currentHalf=1;selectedTactic=null;selectedZone=null;
  pauseTimer();updateTimerDisplay();
  document.getElementById('scoreHomeEl').textContent='0';
  document.getElementById('scoreAwayEl').textContent='0';
  document.getElementById('halfBadge').textContent='1√®re MT';
  document.getElementById('notes1').value='';document.getElementById('notes2').value='';
  document.querySelectorAll('.count').forEach(el=>el.textContent='0');
  renderLog();renderRoster();renderSubLog();
  document.getElementById('tacticDetails').style.display='none';
  renderTacticGrid();alert('‚úì Pr√™t !');
}

// ===== INIT =====
setHalfDuration(45,document.getElementById('dur-45'));
updateTimerDisplay();renderTacticGrid();renderRoster();

// sequences store
var sequences = [];


// ===== HISTORIQUE =====
var _histoFilter = 'all';
var _compareIds = [];

function getMatchHistory() {
  var d = localStorage.getItem('ct_match_history');
  return d ? JSON.parse(d) : [];
}

function saveMatchHistory(h) {
  localStorage.setItem('ct_match_history', JSON.stringify(h));
}

function archiveCurrentMatch() {
  var home = document.getElementById('teamHomeName').textContent || 'NOUS';
  var away = document.getElementById('teamAwayName').textContent || 'ADV';
  var comp = document.getElementById('setupComp').value || 'Match';
  var tac = selectedTactic !== null ? TACTICS[currentFormat][selectedTactic].name + ' (' + currentFormat + 'v' + currentFormat + ')' : 'Non d√©finie';
  if (scoreHome === 0 && scoreAway === 0 && events.length === 0) {
    alert('Le match semble vide ‚Äî joue avant d\'archiver !');
    return;
  }
  if (!confirm('Archiver ce match ?\n' + home + ' ' + scoreHome + ' ‚Äî ' + scoreAway + ' ' + away)) return;
  var playerStats = roster.map(function(p) {
    var goals = events.filter(function(e) { return e.text && e.text.includes('BUT !') && e.text.includes(p.name); }).length;
    var assists = events.filter(function(e) { return e.text && e.text.toLowerCase().includes('assist') && e.text.includes(p.name); }).length;
    var yellows = events.filter(function(e) { return e.icon === 'üü®' && e.text && e.text.includes(p.name); }).length;
    var reds = events.filter(function(e) { return e.icon === 'üü•' && e.text && e.text.includes(p.name); }).length;
    return {
      id: p.id, num: p.num, name: p.name, pos: p.pos,
      playtime: Math.floor(calcPlaytime(p) / 60),
      goals: goals, assists: assists, yellowCards: yellows, redCards: reds
    };
  });
  var matchData = {
    id: Date.now().toString(),
    date: new Date().toLocaleDateString('fr-FR'),
    dateTs: Date.now(),
    home: home, away: away, comp: comp, tactic: tac,
    format: currentFormat,
    location: matchLocation,
    scoreHome: scoreHome, scoreAway: scoreAway,
    counts: JSON.parse(JSON.stringify(counts)),
    events: JSON.parse(JSON.stringify(events)),
    substitutions: JSON.parse(JSON.stringify(substitutions)),
    roster: playerStats,
    notes1: document.getElementById('notes1').value || '',
    notes2: document.getElementById('notes2').value || ''
  };
  var history = getMatchHistory();
  history.unshift(matchData);
  saveMatchHistory(history);
  syncToClubManager(matchData);
  renderHistorique();
  alert('Match archiv√© ! Stats joueurs synchronis√©es avec le Club Manager.');
}

function syncToClubManager(matchData) {
  var cmData = localStorage.getItem('cm2_clubs');
  if (!cmData) return;
  var clubs = JSON.parse(cmData);
  if (!clubs.length) return;
  var homeUpper = (matchData.home || '').toUpperCase();
  var targetClub = null;
  for (var i = 0; i < clubs.length; i++) {
    var cname = (clubs[i].name || '').toUpperCase();
    if (cname.indexOf(homeUpper.substring(0, 4)) !== -1 || homeUpper.indexOf(cname.substring(0, 4)) !== -1) {
      targetClub = clubs[i]; break;
    }
  }
  if (!targetClub) targetClub = clubs[0];
  if (!targetClub || !targetClub.players) return;
  (matchData.roster || []).forEach(function(mp) {
    var cp = null;
    for (var j = 0; j < targetClub.players.length; j++) {
      var p = targetClub.players[j];
      var mpName = (mp.name || '').toLowerCase();
      var cpFull = ((p.prenom || '') + ' ' + (p.nom || '')).toLowerCase().trim();
      var cpLast = (p.nom || '').toLowerCase();
      if (cpFull === mpName || cpFull.indexOf(mpName) !== -1 || mpName.indexOf(cpLast) !== -1 || (cpLast.length > 3 && mpName.indexOf(cpLast.substring(0, 4)) !== -1)) {
        cp = p; break;
      }
    }
    if (!cp) return;
    if (!cp.stats) cp.stats = {matchs:0,buts:0,passes:0,tirs:0,cj:0,cr:0,minutes:0};
    cp.stats.matchs = (cp.stats.matchs || 0) + 1;
    cp.stats.buts = (cp.stats.buts || 0) + (mp.goals || 0);
    cp.stats.passes = (cp.stats.passes || 0) + (mp.assists || 0);
    cp.stats.cj = (cp.stats.cj || 0) + (mp.yellowCards || 0);
    cp.stats.cr = (cp.stats.cr || 0) + (mp.redCards || 0);
    cp.stats.minutes = (cp.stats.minutes || 0) + (mp.playtime || 0);
  });
  localStorage.setItem('cm2_clubs', JSON.stringify(clubs));
}

function renderHistorique() {
  var history = getMatchHistory();
  var titleEl = document.getElementById('histoTitle');
  if (titleEl) titleEl.textContent = 'Historique ‚Äî ' + history.length + ' match' + (history.length !== 1 ? 's' : '');
  var comps = [];
  history.forEach(function(m) { var c = m.comp || 'Match'; if (comps.indexOf(c) === -1) comps.push(c); });
  var fc = document.getElementById('histoFilters');
  if (!fc) return;
  var filtersHtml = '<button class="tag ' + (_histoFilter === 'all' ? 'sel' : '') + '" onclick="setHistoFilter(\'all\',this)">Tous</button>';
  comps.forEach(function(s) {
    filtersHtml += '<button class="tag ' + (_histoFilter === s ? 'sel' : '') + '" onclick="setHistoFilter(\'' + s + '\',this)">' + s + '</button>';
  });
  fc.innerHTML = filtersHtml;
  var filtered = _histoFilter === 'all' ? history : history.filter(function(m) { return (m.comp || 'Match') === _histoFilter; });
  renderHistoSeasonStats(filtered);
  var listEl = document.getElementById('histoList');
  var detEl = document.getElementById('histoDetail');
  var cmpEl = document.getElementById('histoCompare');
  if (detEl) detEl.style.display = 'none';
  if (cmpEl) cmpEl.style.display = 'none';
  if (listEl) listEl.style.display = '';
  _compareIds = [];
  if (!filtered.length) {
    if (listEl) listEl.innerHTML = '<div class="empty-log" style="text-align:center;padding:30px"><div style="font-size:36px;margin-bottom:8px">üìÅ</div>Aucun match archiv√©<br><small>Appuie sur üíæ ARCHIVER apr√®s un match</small></div>';
    return;
  }
  var html = '';
  filtered.forEach(function(m) {
    var res = m.scoreHome > m.scoreAway ? 'V' : m.scoreHome < m.scoreAway ? 'D' : 'N';
    var rc = res === 'V' ? 'var(--green)' : res === 'D' ? 'var(--red)' : 'var(--yellow)';
    var tirs = (m.counts && m.counts['TIR_CADRE']) || 0;
    var jaunes = (m.counts && m.counts['JAUNE']) || 0;
    var rempl = (m.substitutions && m.substitutions.length) || 0;
    var joueurs = (m.roster && m.roster.length) || 0;
    html += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;cursor:pointer" onclick="showMatchDetail(\'' + m.id + '\')">';
    html += '<div style="display:flex;align-items:center;gap:10px">';
    html += '<div style="background:' + rc + ';color:#000;font-family:var(--fd);font-weight:900;font-size:13px;border-radius:6px;padding:4px 10px">' + res + '</div>';
    html += '<div style="flex:1"><div style="font-family:var(--fd);font-size:15px;font-weight:700">' + m.home + ' <span style="color:var(--accent)">' + m.scoreHome + ' ‚Äî ' + m.scoreAway + '</span> ' + m.away + '</div>';
    html += '<div style="font-family:var(--fd);font-size:10px;color:var(--muted);margin-top:2px">' + m.date + (m.comp ? ' ¬∑ ' + m.comp : '') + (m.location ? ' ¬∑ ' + {domicile:'üè†',exterieur:'‚úàÔ∏è',neutre:'‚öñÔ∏è'}[m.location] : '') + '</div></div>';
    html += '<input type="checkbox" style="width:18px;height:18px;cursor:pointer" onclick="event.stopPropagation();toggleCompare(\'' + m.id + '\',this)">';
    html += '</div>';
    html += '<div style="display:flex;gap:8px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">';
    html += '<div style="text-align:center;flex:1"><div style="font-family:var(--fd);font-size:15px;font-weight:900">' + tirs + '</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">TIRS</div></div>';
    html += '<div style="text-align:center;flex:1"><div style="font-family:var(--fd);font-size:15px;font-weight:900">' + jaunes + 'üü®</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">CARTONS</div></div>';
    html += '<div style="text-align:center;flex:1"><div style="font-family:var(--fd);font-size:15px;font-weight:900">' + rempl + '</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">REMPL.</div></div>';
    html += '<div style="text-align:center;flex:1"><div style="font-family:var(--fd);font-size:15px;font-weight:900">' + joueurs + '</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">JOUEURS</div></div>';
    html += '</div></div>';
  });
  if (filtered.length >= 2) {
    html += '<div style="margin-top:8px;padding:10px;background:var(--surface2);border-radius:10px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:space-between">';
    html += '<span style="font-family:var(--fd);font-size:11px;color:var(--muted)">Coche 2 matchs pour les comparer</span>';
    html += '<button id="btnCompare" onclick="compareMatches()" style="display:none;background:var(--accent);border:none;border-radius:6px;padding:6px 12px;color:#000;font-family:var(--fd);font-size:11px;font-weight:900;cursor:pointer">‚öñÔ∏è COMPARER</button>';
    html += '</div>';
  }
  if (listEl) listEl.innerHTML = html;
}

function renderHistoSeasonStats(matches) {
  var el = document.getElementById('histoSeasonStats');
  if (!el) return;
  if (!matches.length) { el.innerHTML = ''; return; }
  var v = 0, n = 0, d = 0, gf = 0, ga = 0;
  matches.forEach(function(m) {
    if (m.scoreHome > m.scoreAway) v++;
    else if (m.scoreHome < m.scoreAway) d++;
    else n++;
    gf += m.scoreHome || 0;
    ga += m.scoreAway || 0;
  });
  el.innerHTML = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px">'
    + '<div style="font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:8px">BILAN SAISON</div>'
    + '<div style="display:flex;gap:6px">'
    + '<div style="flex:1;text-align:center;background:rgba(0,230,118,.1);border-radius:8px;padding:8px"><div style="font-family:var(--fd);font-size:22px;font-weight:900;color:var(--green)">' + v + '</div><div style="font-family:var(--fd);font-size:8px;color:var(--muted)">VICTOIRES</div></div>'
    + '<div style="flex:1;text-align:center;background:rgba(255,214,0,.1);border-radius:8px;padding:8px"><div style="font-family:var(--fd);font-size:22px;font-weight:900;color:var(--yellow)">' + n + '</div><div style="font-family:var(--fd);font-size:8px;color:var(--muted)">NULS</div></div>'
    + '<div style="flex:1;text-align:center;background:rgba(255,68,68,.1);border-radius:8px;padding:8px"><div style="font-family:var(--fd);font-size:22px;font-weight:900;color:var(--red)">' + d + '</div><div style="font-family:var(--fd);font-size:8px;color:var(--muted)">D√âFAITES</div></div>'
    + '<div style="flex:1;text-align:center;background:var(--surface2);border-radius:8px;padding:8px"><div style="font-family:var(--fd);font-size:18px;font-weight:900;color:var(--accent)">' + gf + '‚Äî' + ga + '</div><div style="font-family:var(--fd);font-size:8px;color:var(--muted)">BUTS</div></div>'
    + '</div></div>';
}

function setHistoFilter(f, el) {
  _histoFilter = f;
  document.querySelectorAll('#histoFilters .tag').forEach(function(b) { b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderHistorique();
}

function toggleCompare(id, cb) {
  if (cb.checked) {
    if (_compareIds.length >= 2) { cb.checked = false; alert('S√©lectionne max 2 matchs'); return; }
    _compareIds.push(id);
  } else {
    _compareIds = _compareIds.filter(function(x) { return x !== id; });
  }
  var btn = document.getElementById('btnCompare');
  if (btn) btn.style.display = _compareIds.length === 2 ? '' : 'none';
}

function showMatchDetail(id) {
  var history = getMatchHistory();
  var m = null;
  for (var i = 0; i < history.length; i++) { if (history[i].id === id) { m = history[i]; break; } }
  if (!m) return;
  var listEl = document.getElementById('histoList');
  var detEl = document.getElementById('histoDetail');
  if (listEl) listEl.style.display = 'none';
  if (!detEl) return;
  detEl.style.display = '';
  var res = m.scoreHome > m.scoreAway ? '‚úÖ Victoire' : m.scoreHome < m.scoreAway ? '‚ùå D√©faite' : 'üü° Nul';
  var resColor = m.scoreHome > m.scoreAway ? 'var(--green)' : m.scoreHome < m.scoreAway ? 'var(--red)' : 'var(--yellow)';
  var goalsEv = (m.events || []).filter(function(e) { return e.text && e.text.includes('BUT !'); });
  var statsKeys = [['üéØ','TIR_CADRE','Tirs cadr√©s'],['‚ÜóÔ∏è','TIR_NON_CADRE','Tirs rat√©s'],['üü®','JAUNE','Cartons J'],['üü•','ROUGE','Cartons R'],['üö©','CORNER','Corners'],['‚ö°','CONTRE','Contres']];
  var statsHtml = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';
  statsKeys.forEach(function(sk) {
    statsHtml += '<div style="background:var(--surface);border-radius:8px;padding:9px;border:1px solid var(--border)"><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">' + sk[0] + ' ' + sk[2] + '</div><div style="font-family:var(--fd);font-size:20px;font-weight:900">' + ((m.counts && m.counts[sk[1]]) || 0) + '</div></div>';
  });
  statsHtml += '</div>';
  var goalsHtml = '';
  if (goalsEv.length) {
    goalsHtml = '<div class="section-title">‚öΩ Buts</div>';
    goalsEv.forEach(function(e) { goalsHtml += '<div class="log-item"><span class="log-time">' + e.time + '</span><span class="log-icon">‚öΩ</span><span class="log-text">' + e.text + '</span></div>'; });
  }
  var ptHtml = '';
  if (m.roster && m.roster.length) {
    ptHtml = '<div class="section-title">‚è± Temps de jeu</div>';
    var sorted = m.roster.slice().sort(function(a,b) { return (b.playtime||0)-(a.playtime||0); });
    sorted.forEach(function(p) { ptHtml += '<div class="stat-row"><span class="stat-label">#' + p.num + ' ' + p.name + '</span><span class="stat-value">' + (p.playtime||0) + '<span style="font-size:11px;color:var(--muted)"> min</span></span></div>'; });
  }
  var journalHtml = '<div class="section-title">üìã Journal</div><div style="background:var(--surface2);border-radius:10px;padding:10px;max-height:180px;overflow-y:auto">';
  if (m.events && m.events.length) {
    var evCopy = m.events.slice().reverse();
    evCopy.forEach(function(e) { journalHtml += '<div class="log-item"><span class="log-time">' + e.time + '</span><span class="log-icon">' + e.icon + '</span><span class="log-text">' + e.text + '</span></div>'; });
  } else { journalHtml += '<div class="empty-log">Journal vide</div>'; }
  journalHtml += '</div>';
  var notesHtml = '';
  if (m.notes1 || m.notes2) {
    notesHtml = '<div class="section-title">üìù Notes coach</div>';
    if (m.notes1) notesHtml += '<div style="background:var(--surface);border-radius:8px;padding:10px;margin-bottom:6px;font-size:13px;border:1px solid var(--border)"><b style="font-family:var(--fd);font-size:9px;color:var(--muted)">1√àRE MI-TEMPS</b><br>' + m.notes1 + '</div>';
    if (m.notes2) notesHtml += '<div style="background:var(--surface);border-radius:8px;padding:10px;font-size:13px;border:1px solid var(--border)"><b style="font-family:var(--fd);font-size:9px;color:var(--muted)">2√àME MI-TEMPS</b><br>' + m.notes2 + '</div>';
  }
  detEl.innerHTML = '<button onclick="closeMatchDetail()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 14px;color:var(--text);font-family:var(--fd);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:12px">‚Üê Retour</button>'
    + '<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px">'
    + '<div style="font-family:var(--fd);font-size:20px;font-weight:900">' + m.home + ' ' + m.scoreHome + ' ‚Äî ' + m.scoreAway + ' ' + m.away + '</div>'
    + '<div style="font-family:var(--fd);font-size:11px;color:var(--muted);margin-top:3px">' + m.date + (m.comp ? ' ¬∑ ' + m.comp : '') + '</div>'
    + '<div style="font-family:var(--fd);font-size:13px;font-weight:700;margin-top:6px;color:' + resColor + '">' + res + '</div>'
    + '</div>'
    + '<div class="section-title" style="margin-top:0">üìä Stats</div>'
    + statsHtml + goalsHtml + ptHtml + journalHtml + notesHtml
    + '<div style="display:flex;gap:8px;margin-top:14px">'
    + '<button onclick="shareMatch(\'' + id + '\')" style="flex:1;padding:12px;background:var(--accent);border:none;border-radius:10px;color:#000;font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer">üì§ PARTAGER</button>'
    + '<button onclick="deleteMatch(\'' + id + '\')" style="flex:1;padding:12px;background:rgba(255,68,68,.15);border:1px solid rgba(255,68,68,.3);border-radius:10px;color:var(--red);font-family:var(--fd);font-size:13px;font-weight:900;cursor:pointer">üóë SUPPRIMER</button>'
    + '</div>';
}

function closeMatchDetail() {
  var detEl = document.getElementById('histoDetail');
  var listEl = document.getElementById('histoList');
  if (detEl) detEl.style.display = 'none';
  if (listEl) listEl.style.display = '';
}

function shareMatch(id) {
  var history = getMatchHistory();
  var m = null;
  for (var i = 0; i < history.length; i++) { if (history[i].id === id) { m = history[i]; break; } }
  if (!m) return;
  var txt = '=== RAPPORT DE MATCH ===\n';
  txt += (m.comp ? m.comp + ' ‚Äî ' : '') + m.date + '\n';
  txt += m.home + ' ' + m.scoreHome + ' ‚Äî ' + m.scoreAway + ' ' + m.away + '\n';
  txt += 'Tactique : ' + (m.tactic || '‚Äî') + '\n\n';
  txt += '--- STATS ---\n';
  [['Tirs cadr√©s','TIR_CADRE'],['Corners','CORNER'],['Cartons jaunes','JAUNE'],['Cartons rouges','ROUGE']].forEach(function(kv) {
    txt += kv[0] + ' : ' + ((m.counts && m.counts[kv[1]]) || 0) + '\n';
  });
  txt += '\n--- BUTS ---\n';
  var goals = (m.events || []).filter(function(e) { return e.text && e.text.includes('BUT !'); });
  if (goals.length) goals.forEach(function(e) { txt += '[' + e.time + '] ' + e.text + '\n'; });
  else txt += 'Aucun\n';
  if (m.notes1) txt += '\n--- NOTES 1√®re MT ---\n' + m.notes1 + '\n';
  if (m.notes2) txt += '\n--- NOTES 2√®me MT ---\n' + m.notes2 + '\n';
  if (navigator.share) {
    navigator.share({ title: 'Rapport ' + m.home + ' ' + m.scoreHome + '-' + m.scoreAway + ' ' + m.away, text: txt }).catch(function() {});
  } else {
    var blob = new Blob([txt], { type: 'text/plain' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'rapport-' + m.date.replace(/\//g, '-') + '.txt';
    a.click();
  }
}

function deleteMatch(id) {
  if (!confirm('Supprimer ce match de l\'historique ?')) return;
  var h = getMatchHistory().filter(function(m) { return m.id !== id; });
  saveMatchHistory(h);
  renderHistorique();
}

function compareMatches() {
  if (_compareIds.length !== 2) { alert('Coche exactement 2 matchs'); return; }
  var history = getMatchHistory();
  var m1 = null, m2 = null;
  history.forEach(function(m) {
    if (m.id === _compareIds[0]) m1 = m;
    if (m.id === _compareIds[1]) m2 = m;
  });
  if (!m1 || !m2) return;
  var listEl = document.getElementById('histoList');
  var cmpEl = document.getElementById('histoCompare');
  if (listEl) listEl.style.display = 'none';
  if (!cmpEl) return;
  cmpEl.style.display = '';
  var statKeys = [['üéØ Tirs cadr√©s','TIR_CADRE'],['üü® Cartons J','JAUNE'],['üö© Corners','CORNER'],['‚ö° Contres','CONTRE']];
  var html = '<button onclick="closeCompare()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 14px;color:var(--text);font-family:var(--fd);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:12px">‚Üê Retour</button>';
  html += '<div class="section-title" style="margin-top:0">‚öñÔ∏è Comparaison</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 60px 1fr;gap:6px;align-items:center;margin-bottom:12px">';
  html += '<div style="background:var(--surface);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)"><div style="font-family:var(--fd);font-size:12px;font-weight:700">' + m1.home + ' ' + m1.scoreHome + '-' + m1.scoreAway + ' ' + m1.away + '</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">' + m1.date + '</div></div>';
  html += '<div style="text-align:center;font-family:var(--fd);font-size:12px;color:var(--muted)">VS</div>';
  html += '<div style="background:var(--surface);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)"><div style="font-family:var(--fd);font-size:12px;font-weight:700">' + m2.home + ' ' + m2.scoreHome + '-' + m2.scoreAway + ' ' + m2.away + '</div><div style="font-family:var(--fd);font-size:9px;color:var(--muted)">' + m2.date + '</div></div>';
  html += '</div>';
  statKeys.forEach(function(sk) {
    var v1 = (m1.counts && m1.counts[sk[1]]) || 0;
    var v2 = (m2.counts && m2.counts[sk[1]]) || 0;
    var c1 = v1 > v2 ? 'color:var(--green)' : '';
    var c2 = v2 > v1 ? 'color:var(--green)' : '';
    html += '<div style="display:grid;grid-template-columns:1fr 100px 1fr;gap:6px;align-items:center;margin-bottom:6px">';
    html += '<div style="background:var(--surface);border-radius:8px;padding:8px;text-align:center;border:1px solid var(--border)"><div style="font-family:var(--fd);font-size:20px;font-weight:900;' + c1 + '">' + v1 + '</div></div>';
    html += '<div style="text-align:center;font-family:var(--fd);font-size:9px;color:var(--muted);letter-spacing:1px">' + sk[0] + '</div>';
    html += '<div style="background:var(--surface);border-radius:8px;padding:8px;text-align:center;border:1px solid var(--border)"><div style="font-family:var(--fd);font-size:20px;font-weight:900;' + c2 + '">' + v2 + '</div></div>';
    html += '</div>';
  });
  cmpEl.innerHTML = html;
}

function closeCompare() {
  var cmpEl = document.getElementById('histoCompare');
  var listEl = document.getElementById('histoList');
  if (cmpEl) cmpEl.style.display = 'none';
  if (listEl) listEl.style.display = '';
}



// ===== STYLES S√âQUENCE =====
(function addSeqStyles() {
  var s = document.createElement('style');
  s.textContent = `
    .seqEndBtn {
      padding:7px 12px;background:var(--surface2);border:1px solid var(--border);
      border-radius:8px;color:var(--text);font-family:var(--fd);font-size:11px;
      font-weight:700;cursor:pointer;letter-spacing:1px;
    }
    .seqEndBtn.sel {
      background:var(--accent);border-color:var(--accent);color:#000;
    }
    .seq-node {
      display:flex;align-items:center;gap:3px;background:var(--surface);
      border:1px solid var(--border);border-radius:8px;padding:4px 8px;
      font-family:var(--fd);font-size:12px;font-weight:700;
    }
    .seq-node.lost { border-color:var(--red);background:rgba(255,68,68,0.1); }
    .seq-arrow { color:var(--accent);font-size:14px;font-weight:900; }
    .rtab-active { background:var(--accent) !important;color:#000 !important;border-color:var(--accent) !important; }
    .hm-zone { transition:opacity 0.2s; cursor:pointer; }
    .hm-zone:hover { opacity:0.8; }
  `;
  document.head.appendChild(s);
})();

// ===== S√âQUENCES =====
var _seqChain = [];
var _seqEnd = 'none';

function openSeqModal() {
  _seqChain = [];
  _seqEnd = 'none';
  renderSeqChain();
  renderSeqPlayerBtns();
  document.querySelectorAll('.seqEndBtn').forEach(function(b) { b.classList.remove('sel'); });
  var none = document.getElementById('seqEnd-none');
  if (none) none.classList.add('sel');
  document.getElementById('modalSeq').classList.add('open');
}

function renderSeqPlayerBtns() {
  var el = document.getElementById('seqPlayerBtns');
  if (!el) return;
  var onField = roster.filter(function(p) { return p.onField !== false; });
  if (!onField.length) {
    el.innerHTML = '<span style="font-family:var(--fd);font-size:11px;color:var(--muted)">Ajoute des joueurs dans l\'onglet Effectif</span>';
    return;
  }
  el.innerHTML = onField.sort(function(a,b) { return (+a.num||99)-(+b.num||99); }).map(function(p) {
    return '<button onclick="seqAddPlayer(' + p.id + ',\'' + p.num + '\',\'' + p.name + '\')" style="padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-family:var(--fd);font-size:13px;font-weight:700;cursor:pointer;color:var(--text)">'
      + '<span style="color:var(--accent)">#' + p.num + '</span> ' + (p.name ? p.name.split(' ')[0] : '')
      + '</button>';
  }).join('');
}

function seqAddPlayer(id, num, name) {
  _seqChain.push({ id: id, num: num, name: name, lost: false });
  renderSeqChain();
}

function seqMarkLost() {
  if (!_seqChain.length) return;
  _seqChain[_seqChain.length - 1].lost = true;
  renderSeqChain();
}

function seqUndo() {
  if (!_seqChain.length) return;
  _seqChain.pop();
  renderSeqChain();
}

function setSeqEnd(val, el) {
  _seqEnd = val;
  document.querySelectorAll('.seqEndBtn').forEach(function(b) { b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
}

function renderSeqChain() {
  var el = document.getElementById('seqChain');
  var empty = document.getElementById('seqChainEmpty');
  if (!el) return;
  if (!_seqChain.length) {
    el.innerHTML = '<span id="seqChainEmpty" style="font-family:var(--fd);font-size:11px;color:var(--muted)">Ajoute des joueurs ci-dessous...</span>';
    return;
  }
  var html = '';
  _seqChain.forEach(function(node, i) {
    if (i > 0) html += '<span class="seq-arrow">‚Üí</span>';
    html += '<div class="seq-node' + (node.lost ? ' lost' : '') + '">';
    html += '<span style="color:var(--accent)">#' + node.num + '</span>';
    if (node.lost) html += ' <span style="color:var(--red);font-size:10px">üíî</span>';
    html += '</div>';
  });
  el.innerHTML = html;
}

function confirmSeq() {
  if (_seqChain.length < 2) { alert('Ajoute au moins 2 joueurs pour une s√©quence.'); return; }
  var time = getTimerDisplay();
  var half = currentHalf;
  // Build pass pairs
  var passPairs = [];
  for (var i = 0; i < _seqChain.length - 1; i++) {
    passPairs.push({
      from: _seqChain[i],
      to: _seqChain[i+1],
      lost: _seqChain[i].lost
    });
  }
  var lastNode = _seqChain[_seqChain.length - 1];
  var chainText = _seqChain.map(function(n) { return '#' + n.num; }).join('‚Üí');
  var endLabel = { none:'', but:'‚öΩ BUT !', tir:'üéØ Tir', occasion:'üî• Occasion', centre:'üìê Centre', perte:'üíî Perte' };
  var logText = 'S√©quence ' + chainText + (_seqEnd !== 'none' ? ' ‚Üí ' + endLabel[_seqEnd] : '');
  var seq = {
    id: Date.now().toString(),
    time: time, half: half,
    chain: _seqChain.slice(),
    pairs: passPairs,
    end: _seqEnd,
    text: logText
  };
  sequences.push(seq);
  // Count
  if (!counts['SEQ']) counts['SEQ'] = 0;
  counts['SEQ']++;
  var cntEl = document.getElementById('cnt-SEQ');
  if (cntEl) cntEl.textContent = counts['SEQ'];
  // Log event
  addEventToLog('üîó', logText, '');
  // If sequence ends in but, auto-trigger goal
  closeModal('modalSeq');
  if (_seqEnd === 'but') {
    setTimeout(function() {
      if (confirm('Ouvrir le d√©tail du but ?')) openGoalModal();
    }, 200);
  }
}

// ===== RAPPORT TABS =====
function showRapportTab(tab) {
  document.getElementById('rapport-summary').style.display = tab === 'summary' ? '' : 'none';
  document.getElementById('rapport-analyse').style.display = tab === 'analyse' ? '' : 'none';
  document.getElementById('rapport-heatmap').style.display = tab === 'heatmap' ? '' : 'none';
  ['summary','analyse','heatmap'].forEach(function(t) {
    var btn = document.getElementById('rtab-' + t);
    if (btn) btn.classList.toggle('rtab-active', t === tab);
  });
  if (tab === 'analyse') buildAnalyse();
  if (tab === 'heatmap') buildHeatmap();
}

// ===== ANALYSE =====
function buildAnalyse() {
  var el = document.getElementById('rapport-analyse');
  if (!el) return;
  var half1Events = events.filter(function(e) { return e.half === 1; });
  var half2Events = events.filter(function(e) { return e.half === 2; });
  var allSeqs = sequences;
  var half1Seqs = allSeqs.filter(function(s) { return s.half === 1; });
  var half2Seqs = allSeqs.filter(function(s) { return s.half === 2; });

  // ‚îÄ‚îÄ Comparaison 1MT vs 2MT ‚îÄ‚îÄ
  var statsKeys = [
    ['‚öΩ Buts','BUT'],['üéØ Tirs cadr√©s','TIR_CADRE'],['‚ÜóÔ∏è Tirs rat√©s','TIR_NON_CADRE'],
    ['üî• Occasions','OCCASION'],['üíî Pertes','PERTE'],['üí™ R√©cups','RECUP'],
    ['üü® Cartons J','JAUNE'],['üîó S√©quences','SEQ']
  ];
  function countHalf(evts, key) {
    if (key === 'SEQ') return evts === half1Events ? half1Seqs.length : half2Seqs.length;
    return evts.filter(function(e) { return e.type === key; }).length;
  }
  var compHtml = '<div class="section-title" style="margin-top:0">‚öñÔ∏è Comparaison 1√®re MT / 2√®me MT</div>';
  compHtml += '<div style="display:grid;grid-template-columns:1fr 80px 1fr;gap:4px;align-items:center;margin-bottom:16px;">';
  compHtml += '<div style="text-align:center;font-family:var(--fd);font-size:11px;font-weight:900;color:var(--accent);padding:6px">1√àRE MT</div>';
  compHtml += '<div></div>';
  compHtml += '<div style="text-align:center;font-family:var(--fd);font-size:11px;font-weight:900;color:var(--green);padding:6px">2√àME MT</div>';
  statsKeys.forEach(function(sk) {
    var v1 = countHalf(half1Events, sk[1]);
    var v2 = countHalf(half2Events, sk[1]);
    var c1 = v1 > v2 ? 'color:var(--accent)' : v1 === v2 ? '' : 'color:var(--muted)';
    var c2 = v2 > v1 ? 'color:var(--green)' : v2 === v1 ? '' : 'color:var(--muted)';
    compHtml += '<div style="background:var(--surface);border-radius:8px;padding:8px;text-align:center"><div style="font-family:var(--fd);font-size:20px;font-weight:900;' + c1 + '">' + v1 + '</div></div>';
    compHtml += '<div style="text-align:center;font-family:var(--fd);font-size:9px;color:var(--muted);letter-spacing:0.5px">' + sk[0] + '</div>';
    compHtml += '<div style="background:var(--surface);border-radius:8px;padding:8px;text-align:center"><div style="font-family:var(--fd);font-size:20px;font-weight:900;' + c2 + '">' + v2 + '</div></div>';
  });
  compHtml += '</div>';

  // ‚îÄ‚îÄ Circuits de passe ‚îÄ‚îÄ
  var circuitHtml = '<div class="section-title">üîó Circuits de passe fr√©quents</div>';
  if (!allSeqs.length) {
    circuitHtml += '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);padding:12px;text-align:center">Aucune s√©quence enregistr√©e</div>';
  } else {
    // Count pair frequencies
    var pairCount = {};
    allSeqs.forEach(function(seq) {
      seq.pairs.forEach(function(pair) {
        if (!pair.lost) {
          var key = '#' + pair.from.num + '‚Üí#' + pair.to.num;
          pairCount[key] = (pairCount[key] || 0) + 1;
        }
      });
    });
    var sortedPairs = Object.keys(pairCount).sort(function(a,b) { return pairCount[b] - pairCount[a]; });
    if (!sortedPairs.length) {
      circuitHtml += '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);padding:12px;text-align:center">Aucune passe r√©ussie enregistr√©e</div>';
    } else {
      var maxVal = pairCount[sortedPairs[0]];
      circuitHtml += '<div style="margin-bottom:12px">';
      sortedPairs.slice(0, 8).forEach(function(key, i) {
        var val = pairCount[key];
        var pct = Math.round(val / maxVal * 100);
        var medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)+'.';
        circuitHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
        circuitHtml += '<div style="font-family:var(--fd);font-size:12px;min-width:16px">' + medal + '</div>';
        circuitHtml += '<div style="font-family:var(--fd);font-size:13px;font-weight:700;min-width:90px;color:var(--text)">' + key + '</div>';
        circuitHtml += '<div style="flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden">';
        circuitHtml += '<div style="height:100%;width:' + pct + '%;background:var(--accent);border-radius:4px"></div>';
        circuitHtml += '</div>';
        circuitHtml += '<div style="font-family:var(--fd);font-size:13px;font-weight:900;color:var(--accent);min-width:20px;text-align:right">' + val + '</div>';
        circuitHtml += '</div>';
      });
      circuitHtml += '</div>';
    }

    // S√©quences compl√®tes
    circuitHtml += '<div class="section-title">üìã S√©quences enregistr√©es</div>';
    allSeqs.slice().reverse().forEach(function(seq) {
      var endIcons = { none:'', but:'‚öΩ', tir:'üéØ', occasion:'üî•', centre:'üìê', perte:'üíî' };
      circuitHtml += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:6px">';
      circuitHtml += '<div style="display:flex;align-items:center;gap:8px">';
      circuitHtml += '<span style="font-family:var(--fd);font-size:10px;color:var(--muted)">' + seq.time + ' MT' + seq.half + '</span>';
      circuitHtml += '<div style="display:flex;flex-wrap:wrap;gap:3px;flex:1">';
      seq.chain.forEach(function(node, i) {
        if (i > 0) circuitHtml += '<span style="color:var(--accent);font-weight:900">‚Üí</span>';
        circuitHtml += '<span style="font-family:var(--fd);font-size:12px;font-weight:700;' + (node.lost ? 'color:var(--red)' : 'color:var(--text)') + '">#' + node.num + (node.lost ? 'üíî' : '') + '</span>';
      });
      circuitHtml += '</div>';
      if (seq.end !== 'none') circuitHtml += '<span style="font-size:16px">' + (endIcons[seq.end] || '') + '</span>';
      circuitHtml += '</div></div>';
    });
  }

  // ‚îÄ‚îÄ Pertes de balle par joueur ‚îÄ‚îÄ
  var lossHtml = '<div class="section-title">üíî Pertes de balle par joueur</div>';
  var lossCount = {};
  // From individual PERTE events
  events.filter(function(e) { return e.type === 'PERTE'; }).forEach(function(e) {
    var name = e.player || 'Non identifi√©';
    lossCount[name] = (lossCount[name] || 0) + 1;
  });
  // From sequences (lost passes)
  allSeqs.forEach(function(seq) {
    seq.pairs.forEach(function(pair) {
      if (pair.lost) {
        var name = '#' + pair.from.num + ' ' + pair.from.name;
        lossCount[name] = (lossCount[name] || 0) + 1;
      }
    });
  });
  var lossKeys = Object.keys(lossCount).sort(function(a,b) { return lossCount[b] - lossCount[a]; });
  if (!lossKeys.length) {
    lossHtml += '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);padding:12px;text-align:center">Aucune perte enregistr√©e</div>';
  } else {
    var maxLoss = lossCount[lossKeys[0]];
    lossHtml += '<div style="margin-bottom:12px">';
    lossKeys.forEach(function(name) {
      var val = lossCount[name];
      var pct = Math.round(val / maxLoss * 100);
      lossHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
      lossHtml += '<div style="font-family:var(--fd);font-size:12px;font-weight:700;min-width:110px;color:var(--text)">' + name + '</div>';
      lossHtml += '<div style="flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden">';
      lossHtml += '<div style="height:100%;width:' + pct + '%;background:var(--red);border-radius:4px"></div>';
      lossHtml += '</div>';
      lossHtml += '<div style="font-family:var(--fd);font-size:13px;font-weight:900;color:var(--red);min-width:20px;text-align:right">' + val + '</div>';
      lossHtml += '</div>';
    });
    lossHtml += '</div>';
  }

  el.innerHTML = compHtml + circuitHtml + lossHtml;
}

// ===== CARTE DE CHALEUR =====
function buildHeatmap() {
  var el = document.getElementById('rapport-heatmap');
  if (!el) return;

  // Tabs for collective vs individual
  var playerOpts = '<option value="all">üå° Collectif</option>';
  roster.forEach(function(p) {
    playerOpts += '<option value="' + p.id + '">#' + p.num + ' ' + p.name + '</option>';
  });

  el.innerHTML = '<div class="section-title" style="margin-top:0">üå° Carte de chaleur</div>'
    + '<div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">'
    + '<select id="hmPlayer" onchange="renderHeatmapFor()" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--text);font-family:var(--fd);font-size:12px;">' + playerOpts + '</select>'
    + '<select id="hmType" onchange="renderHeatmapFor()" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--text);font-family:var(--fd);font-size:12px;">'
    + '<option value="all">Toutes actions</option>'
    + '<option value="PERTE">üíî Pertes</option>'
    + '<option value="RECUP">üí™ R√©cups</option>'
    + '<option value="TIR_CADRE">üéØ Tirs cadr√©s</option>'
    + '<option value="SEQ">üîó S√©quences</option>'
    + '</select></div>'
    + '<div id="hmCanvas" style="position:relative;max-width:280px;margin:0 auto 12px auto;"></div>'
    + '<div id="hmLegend" style="margin-bottom:8px;"></div>'
    + '<div id="hmStats" style="font-family:var(--fd);font-size:11px;color:var(--muted);text-align:center"></div>';

  renderHeatmapFor();
}

function renderHeatmapFor() {
  var playerId = document.getElementById('hmPlayer') ? document.getElementById('hmPlayer').value : 'all';
  var typeFilter = document.getElementById('hmType') ? document.getElementById('hmType').value : 'all';
  var canvas = document.getElementById('hmCanvas');
  if (!canvas) return;

  // Count events per zone
  var zoneCounts = {};
  for (var z = 1; z <= 18; z++) zoneCounts[z] = 0;

  // From regular events
  events.forEach(function(e) {
    if (!e.zone) return;
    var zoneNum = parseInt(e.zone);
    if (!zoneNum || zoneNum < 1 || zoneNum > 18) return;
    var typeMatch = typeFilter === 'all' || e.type === typeFilter;
    var playerMatch = playerId === 'all' || (e.playerId && String(e.playerId) === String(playerId));
    if (typeMatch && playerMatch) zoneCounts[zoneNum] = (zoneCounts[zoneNum] || 0) + 1;
  });

  // From sequences
  if (typeFilter === 'all' || typeFilter === 'SEQ') {
    sequences.forEach(function(seq) {
      if (seq.zone) {
        var zoneNum = parseInt(seq.zone);
        var playerMatch = playerId === 'all' || seq.chain.some(function(n) { return String(n.id) === String(playerId); });
        if (playerMatch && zoneNum >= 1 && zoneNum <= 18) {
          zoneCounts[zoneNum] = (zoneCounts[zoneNum] || 0) + 1;
        }
      }
    });
  }

  var maxVal = Math.max.apply(null, Object.values(zoneCounts).concat([1]));
  var totalEvents = Object.values(zoneCounts).reduce(function(a,b) { return a+b; }, 0);

  // Build SVG heatmap - 3 cols x 6 rows like the pitch
  var W = 192, H = 320;
  var cols = 3, rows = 6;
  var cw = W / cols, rh = H / rows;

  function zoneToPos(z) {
    // Zone 1-3 = row 0 (bottom/defense), 16-18 = row 5 (top/attack)
    var idx = z - 1;
    var col = idx % 3;
    var row = Math.floor(idx / 3);
    return { col: col, row: rows - 1 - row }; // invert: row 0 = top in SVG
  }

  function heatColor(val, max) {
    if (val === 0) return 'rgba(0,0,0,0)';
    var ratio = val / max;
    if (ratio < 0.33) {
      var t = ratio / 0.33;
      return 'rgba(255,214,0,' + (0.3 + t * 0.4) + ')';
    } else if (ratio < 0.66) {
      var t = (ratio - 0.33) / 0.33;
      return 'rgba(255,' + Math.round(214 - t*146) + ',0,' + (0.6 + t * 0.2) + ')';
    } else {
      var t = (ratio - 0.66) / 0.34;
      return 'rgba(' + Math.round(255) + ',' + Math.round(68 - t*68) + ',0,' + (0.75 + t * 0.25) + ')';
    }
  }

  var svgParts = ['<svg viewBox="0 0 ' + W + ' ' + H + '" style="width:100%;display:block;border-radius:8px" xmlns="http://www.w3.org/2000/svg">'];
  svgParts.push('<rect width="' + W + '" height="' + H + '" fill="#1a4a1a" rx="6"/>');

  // Terrain lines (simplified)
  svgParts.push('<line x1="0" y1="' + (H/2) + '" x2="' + W + '" y2="' + (H/2) + '" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>');
  svgParts.push('<rect x="' + (W*0.2) + '" y="' + (H*0.04) + '" width="' + (W*0.6) + '" height="' + (H*0.18) + '" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>');
  svgParts.push('<rect x="' + (W*0.2) + '" y="' + (H*0.78) + '" width="' + (W*0.6) + '" height="' + (H*0.18) + '" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>');
  svgParts.push('<circle cx="' + (W/2) + '" cy="' + (H/2) + '" r="30" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>');

  // Grid lines
  for (var c = 1; c < cols; c++) {
    svgParts.push('<line x1="' + (c*cw) + '" y1="0" x2="' + (c*cw) + '" y2="' + H + '" stroke="rgba(255,255,255,0.15)" stroke-width="0.5"/>');
  }
  for (var r = 1; r < rows; r++) {
    svgParts.push('<line x1="0" y1="' + (r*rh) + '" x2="' + W + '" y2="' + (r*rh) + '" stroke="rgba(255,255,255,0.15)" stroke-width="0.5"/>');
  }

  // Heat zones
  for (var z = 1; z <= 18; z++) {
    var pos = zoneToPos(z);
    var x = pos.col * cw;
    var y = pos.row * rh;
    var val = zoneCounts[z];
    var color = heatColor(val, maxVal);
    if (val > 0) {
      svgParts.push('<rect x="' + x + '" y="' + y + '" width="' + cw + '" height="' + rh + '" fill="' + color + '" rx="2"/>');
      svgParts.push('<text x="' + (x + cw/2) + '" y="' + (y + rh/2 + 5) + '" text-anchor="middle" font-family="monospace" font-weight="bold" font-size="16" fill="white">' + val + '</text>');
    }
    // Zone label (small)
    svgParts.push('<text x="' + (x + 4) + '" y="' + (y + 12) + '" font-family="monospace" font-size="8" fill="rgba(255,255,255,0.4)">' + z + '</text>');
  }

  // Labels
  svgParts.push('<text x="' + (W/2) + '" y="14" text-anchor="middle" font-family="monospace" font-size="9" fill="rgba(255,255,255,0.6)">ATTAQUE</text>');
  svgParts.push('<text x="' + (W/2) + '" y="' + (H-4) + '" text-anchor="middle" font-family="monospace" font-size="9" fill="rgba(255,255,255,0.6)">D√âFENSE</text>');
  svgParts.push('</svg>');

  canvas.innerHTML = svgParts.join('');

  // Legend
  var legendEl = document.getElementById('hmLegend');
  if (legendEl) {
    legendEl.innerHTML = '<div style="display:flex;align-items:center;gap:8px;justify-content:center">'
      + '<div style="width:16px;height:12px;background:rgba(255,214,0,0.5);border-radius:2px"></div>'
      + '<span style="font-family:var(--fd);font-size:10px;color:var(--muted)">Faible</span>'
      + '<div style="width:16px;height:12px;background:rgba(255,100,0,0.8);border-radius:2px"></div>'
      + '<span style="font-family:var(--fd);font-size:10px;color:var(--muted)">Moyen</span>'
      + '<div style="width:16px;height:12px;background:rgba(255,0,0,1);border-radius:2px"></div>'
      + '<span style="font-family:var(--fd);font-size:10px;color:var(--muted)">√âlev√©</span>'
      + '</div>';
  }

  var statsEl = document.getElementById('hmStats');
  if (statsEl) {
    if (totalEvents === 0) {
      statsEl.textContent = 'Aucune action avec zone enregistr√©e ‚Äî s√©lectionne une zone apr√®s chaque action';
    } else {
      var hotZone = Object.keys(zoneCounts).sort(function(a,b) { return zoneCounts[b]-zoneCounts[a]; })[0];
      statsEl.textContent = totalEvents + ' action(s) ¬∑ Zone la plus active : ' + hotZone;
    }
  }
}


// ===== IMPORT DEPUIS CLUB MANAGER =====
var _importStatus = 'field';
var _importSelectedPlayers = [];
var _importClubId = null;

function openImportCMModal() {
  _importSelectedPlayers = [];
  _importStatus = 'field';
  document.querySelectorAll('.importStatusBtn').forEach(function(b){b.classList.remove('sel');});
  var istField = document.getElementById('ist-field');
  if(istField) istField.classList.add('sel');
  var note = document.getElementById('importCMNote');
  if(note) note.textContent = '';
  var cmRaw = localStorage.getItem('cm2_clubs');
  var clubList = document.getElementById('importCMClubSelect');
  var playerList = document.getElementById('importCMPlayerList');
  if(!cmRaw) {
    clubList.innerHTML = '';
    playerList.innerHTML = '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);text-align:center;padding:16px;">Aucun club dans Club Manager. Cr√©e un club et ajoute des joueurs.</div>';
    document.getElementById('modalImportCM').classList.add('open');
    return;
  }
  var clubs = JSON.parse(cmRaw);
  if(!clubs.length) {
    clubList.innerHTML = '';
    playerList.innerHTML = '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);text-align:center;padding:16px;">Aucun club trouv√©.</div>';
    document.getElementById('modalImportCM').classList.add('open');
    return;
  }
  // Build club selector using DOM
  clubList.innerHTML = '';
  var clabel = document.createElement('div');
  clabel.style.cssText = 'font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:6px;';
  clabel.textContent = 'CLUB';
  clubList.appendChild(clabel);
  var cbtns = document.createElement('div');
  cbtns.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px;';
  clubs.forEach(function(c) {
    var btn = document.createElement('button');
    btn.id = 'iclub-' + c.id;
    btn.style.cssText = 'padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-family:var(--fd);font-size:12px;font-weight:700;cursor:pointer;color:var(--text);';
    btn.textContent = c.name || 'Club';
    btn.dataset.cid = c.id;
    btn.onclick = function(){ selectImportClub(this.dataset.cid); };
    cbtns.appendChild(btn);
  });
  clubList.appendChild(cbtns);
  // Auto-select if only one club
  if(clubs.length === 1) { _importClubId = clubs[0].id; renderImportPlayers(clubs[0]); }
  else { playerList.innerHTML = '<div style="font-family:var(--fd);font-size:11px;color:var(--muted);text-align:center;padding:8px;">S√©lectionne un club</div>'; }
  document.getElementById('modalImportCM').classList.add('open');
}

function selectImportClub(clubId) {
  var cmRaw = localStorage.getItem('cm2_clubs');
  if(!cmRaw) return;
  var clubs = JSON.parse(cmRaw);
  var c = clubs.find(function(x){ return x.id === clubId; });
  if(!c) return;
  _importClubId = clubId;
  _importSelectedPlayers = [];
  document.querySelectorAll('[id^="iclub-"]').forEach(function(b){
    b.style.background='var(--surface2)'; b.style.borderColor='var(--border)'; b.style.color='var(--text)';
  });
  var btn = document.getElementById('iclub-' + clubId);
  if(btn){ btn.style.background='var(--accent)'; btn.style.borderColor='var(--accent)'; btn.style.color='#000'; }
  renderImportPlayers(c);
}

function renderImportPlayers(club) {
  var allPlayers = club.players || [];
  var playerList = document.getElementById('importCMPlayerList');
  var note = document.getElementById('importCMNote');
  playerList.innerHTML = '';
  if(!allPlayers.length) {
    playerList.innerHTML = '<div style="font-family:var(--fd);font-size:12px;color:var(--muted);text-align:center;padding:16px;">Aucun joueur dans ce club.</div>';
    return;
  }
  var available = allPlayers.filter(function(p){ return p.status==='ok' || !p.status; });
  var unavailable = allPlayers.filter(function(p){ return p.status && p.status!=='ok'; });
  // Header
  var header = document.createElement('div');
  header.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:8px;';
  var lbl = document.createElement('div');
  lbl.style.cssText = 'font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;flex:1;';
  lbl.textContent = 'JOUEURS (' + available.length + ' dispos)';
  var selAllBtn = document.createElement('button');
  selAllBtn.textContent = 'Tout s√©lectionner';
  selAllBtn.style.cssText = 'background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-family:var(--fd);font-size:10px;font-weight:700;cursor:pointer;color:var(--text);';
  selAllBtn.onclick = selectAllImportPlayers;
  header.appendChild(lbl); header.appendChild(selAllBtn);
  playerList.appendChild(header);
  // List
  var list = document.createElement('div');
  list.style.cssText = 'display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto;';
  available.sort(function(a,b){ return (+a.num||99)-(+b.num||99); }).forEach(function(p) {
    var fullName = ((p.prenom||'') + ' ' + (p.nom||'')).trim() || 'Joueur';
    var card = document.createElement('div');
    card.id = 'ip-' + p.id;
    card.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;';
    card.dataset.pid = String(p.id);
    card.dataset.num = p.num || '?';
    card.dataset.name = fullName;
    card.dataset.pos = p.poste || '';
    card.onclick = function() { toggleImportPlayer(this.dataset.pid, this.dataset.num, this.dataset.name, this.dataset.pos); };
    var numEl = document.createElement('div');
    numEl.style.cssText = 'font-family:var(--fd);font-size:14px;font-weight:900;color:var(--accent);min-width:28px;';
    numEl.textContent = '#' + (p.num || '?');
    var info = document.createElement('div'); info.style.flex = '1';
    var nameEl = document.createElement('div');
    nameEl.style.cssText = 'font-family:var(--fd);font-size:13px;font-weight:700;';
    nameEl.textContent = fullName;
    var posEl = document.createElement('div');
    posEl.style.cssText = 'font-family:var(--fd);font-size:10px;color:var(--muted);';
    posEl.textContent = p.poste || '';
    info.appendChild(nameEl); info.appendChild(posEl);
    var check = document.createElement('div');
    check.id = 'ipcheck-' + p.id;
    check.style.cssText = 'width:20px;height:20px;border:2px solid var(--border);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;';
    card.appendChild(numEl); card.appendChild(info); card.appendChild(check);
    list.appendChild(card);
  });
  if(unavailable.length) {
    var uLabel = document.createElement('div');
    uLabel.style.cssText = 'font-family:var(--fd);font-size:10px;color:var(--muted);letter-spacing:1px;margin-top:8px;margin-bottom:4px;';
    uLabel.textContent = 'INDISPONIBLES (non import√©s)';
    list.appendChild(uLabel);
    unavailable.forEach(function(p){
      var icon = p.status==='injured'?'üî¥':p.status==='suspended'?'üü†':'üü°';
      var fullName = ((p.prenom||'') + ' ' + (p.nom||'')).trim() || 'Joueur';
      var card = document.createElement('div');
      card.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;opacity:0.4;';
      var numEl = document.createElement('div');
      numEl.style.cssText = 'font-family:var(--fd);font-size:14px;font-weight:900;color:var(--muted);min-width:28px;';
      numEl.textContent = '#' + (p.num||'?');
      var nameEl = document.createElement('div');
      nameEl.style.cssText = 'flex:1;font-family:var(--fd);font-size:13px;font-weight:700;';
      nameEl.textContent = fullName;
      var iconEl = document.createElement('span');
      iconEl.textContent = icon;
      card.appendChild(numEl); card.appendChild(nameEl); card.appendChild(iconEl);
      list.appendChild(card);
    });
  }
  playerList.appendChild(list);
  if(note) note.textContent = '';
}

function toggleImportPlayer(id, num, name, pos) {
  var idx = _importSelectedPlayers.findIndex(function(p){ return p.id === id; });
  var card = document.getElementById('ip-' + id);
  var check = document.getElementById('ipcheck-' + id);
  if(idx === -1) {
    _importSelectedPlayers.push({id:id, num:num, name:name, pos:pos});
    if(card){ card.style.borderColor='var(--accent)'; card.style.background='rgba(0,212,255,0.08)'; }
    if(check){ check.style.background='var(--accent)'; check.style.borderColor='var(--accent)'; check.textContent='‚úì'; check.style.color='#000'; check.style.fontWeight='900'; check.style.fontSize='12px'; }
  } else {
    _importSelectedPlayers.splice(idx,1);
    if(card){ card.style.borderColor='var(--border)'; card.style.background='var(--surface)'; }
    if(check){ check.style.background=''; check.style.borderColor='var(--border)'; check.textContent=''; }
  }
  var note = document.getElementById('importCMNote');
  if(note) note.textContent = _importSelectedPlayers.length ? _importSelectedPlayers.length + ' joueur(s) s√©lectionn√©(s)' : '';
}

function selectAllImportPlayers() {
  var cmRaw = localStorage.getItem('cm2_clubs');
  if(!cmRaw || !_importClubId) return;
  var clubs = JSON.parse(cmRaw);
  var c = clubs.find(function(x){ return x.id === _importClubId; });
  if(!c) return;
  _importSelectedPlayers = [];
  (c.players||[]).filter(function(p){ return p.status==='ok' || !p.status; }).forEach(function(p){
    var fullName = ((p.prenom||'') + ' ' + (p.nom||'')).trim() || 'Joueur';
    _importSelectedPlayers.push({id:String(p.id), num:p.num||'?', name:fullName, pos:p.poste||''});
    var card = document.getElementById('ip-' + p.id);
    var check = document.getElementById('ipcheck-' + p.id);
    if(card){ card.style.borderColor='var(--accent)'; card.style.background='rgba(0,212,255,0.08)'; }
    if(check){ check.style.background='var(--accent)'; check.style.borderColor='var(--accent)'; check.textContent='‚úì'; check.style.color='#000'; check.style.fontWeight='900'; check.style.fontSize='12px'; }
  });
  var note = document.getElementById('importCMNote');
  if(note) note.textContent = _importSelectedPlayers.length + ' joueur(s) s√©lectionn√©(s)';
}

function setImportStatus(val, el) {
  _importStatus = val;
  document.querySelectorAll('.importStatusBtn').forEach(function(b){b.classList.remove('sel');});
  if(el) el.classList.add('sel');
}

function confirmImportCM() {
  if(!_importSelectedPlayers.length){ alert('S√©lectionne au moins un joueur'); return; }
  var added = 0, skipped = 0;
  _importSelectedPlayers.forEach(function(p){
    var exists = roster.find(function(r){ return r.name.toLowerCase().trim() === p.name.toLowerCase().trim(); });
    if(!exists){
      roster.push({
        id: Date.now() + Math.floor(Math.random()*1000),
        num: p.num, name: p.name, pos: p.pos,
        status: _importStatus,
        entryTime: _importStatus==='field' ? seconds : null,
        totalSeconds: 0
      });
      added++;
    } else { skipped++; }
  });
  renderRoster();
  if(selectedTactic !== null) renderPitch();
  closeModal('modalImportCM');
  var msg = added + ' joueur(s) import√©(s) ‚úÖ';
  if(skipped) msg += '\n(' + skipped + ' d√©j√† pr√©sent(s) ‚Äî ignor√©(s))';
  alert(msg);
}




// ===== MODULE CLUB INT√âGR√â =====

var _clubFormat = 11;
var _clubFilter = 'all';
var _clubStatCat = 'buts';
var _clubInjType = 'injured';
var _clubSeasonFilter = 'all';
var _clubHealthStatus = 'injured';
var _editClubPlayerId = null;

function loadClubData() {
  var d = localStorage.getItem('ct_club');
  return d ? JSON.parse(d) : {
    name: 'Mon Club', season: '2025-2026', category: '', emoji: '‚öΩ',
    players11: [], players8: []
  };
}
function saveClubData(data) {
  localStorage.setItem('ct_club', JSON.stringify(data));
}
function clubPlayers() {
  var d = loadClubData();
  return _clubFormat === 11 ? (d.players11 || []) : (d.players8 || []);
}
function saveClubPlayers(players) {
  var d = loadClubData();
  if (_clubFormat === 11) d.players11 = players; else d.players8 = players;
  saveClubData(d);
}

function showClubTab(tab, el) {
  document.querySelectorAll('.ctab').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('.cpanel').forEach(function(p){ p.classList.remove('active'); });
  if (el) el.classList.add('active');
  var panel = document.getElementById('cpanel-' + tab);
  if (panel) panel.classList.add('active');
  if (tab === 'roster') renderClubRoster();
  if (tab === 'health') renderClubHealth();
  if (tab === 'stats') renderClubStats();
  if (tab === 'season') renderClubSeason();
  if (tab === 'clubcfg') renderClubCfg();
}

function setClubFormat(fmt, el) {
  _clubFormat = fmt;
  document.querySelectorAll('#clubFmt11,#clubFmt8').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderClubRoster();
  renderClubInfoBar();
}

function renderClubInfoBar() {
  var d = loadClubData();
  var el = document.getElementById('clubNameDisplay');
  var meta = document.getElementById('clubMetaDisplay');
  var logo = document.getElementById('clubLogoDisplay');
  if (el) el.textContent = (d.name || 'Mon Club').toUpperCase();
  if (meta) meta.textContent = (d.category ? d.category + ' ‚Äî ' : '') + (d.season || 'Saison');
  if (logo) logo.textContent = d.emoji || '‚öΩ';
  // Quick stats
  var players = clubPlayers();
  var ok = players.filter(function(p){ return !p.status || p.status === 'ok'; }).length;
  var injured = players.filter(function(p){ return p.status === 'injured'; }).length;
  var qs = document.getElementById('clubQuickStats');
  if (qs) qs.innerHTML =
    '<div style="text-align:center;"><div style="font-family:\'Bebas Neue\',sans-serif;font-size:22px;color:var(--accent);line-height:1;">' + players.length + '</div><div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;">Joueurs</div></div>' +
    '<div style="text-align:center;"><div style="font-family:\'Bebas Neue\',sans-serif;font-size:22px;color:var(--green);line-height:1;">' + ok + '</div><div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;">Dispos</div></div>' +
    (injured > 0 ? '<div style="text-align:center;"><div style="font-family:\'Bebas Neue\',sans-serif;font-size:22px;color:var(--red);line-height:1;">' + injured + '</div><div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;">Bless√©s</div></div>' : '');
}

function renderClubRoster() {
  renderClubInfoBar();
  var players = clubPlayers();
  var filtered = players.filter(function(p) {
    if (_clubFilter === 'all') return true;
    if (_clubFilter === 'ok') return !p.status || p.status === 'ok';
    return p.status === _clubFilter;
  });
  filtered.sort(function(a, b) { return (parseInt(a.num)||99) - (parseInt(b.num)||99); });
  var list = document.getElementById('clubRosterList');
  if (!list) return;
  if (!filtered.length) { list.innerHTML = '<div class="empty-log">Aucun joueur</div>'; return; }
  list.innerHTML = filtered.map(function(p) {
    var statusColor = p.status === 'injured' ? 'var(--red)' : p.status === 'suspended' ? 'var(--yellow)' : p.status === 'unavailable' ? 'var(--muted)' : 'rgba(0,230,118,0.4)';
    var statusLabel = p.status === 'injured' ? 'üî¥ BLESS√â' : p.status === 'suspended' ? 'üü° SUSPENDU' : p.status === 'unavailable' ? '‚ö´ INDISPO' : '‚úÖ DISPO';
    var statsBar = '<span style="font-family:\'Rajdhani\',sans-serif;font-size:10px;font-weight:600;color:var(--muted);">' +
      (p.stats ? (p.stats.matchs||0) + ' MJ ‚Äî ' + (p.stats.buts||0) + ' ‚öΩ ‚Äî ' + (p.stats.passes||0) + ' üéÅ' : '') + '</span>';
    return '<div class="roster-item" style="border-left-color:' + statusColor + ';cursor:pointer;" onclick="openClubPlayerModal(\'' + p.id + '\')">' +
      '<div class="roster-num">' + (p.num||'') + '</div>' +
      '<div style="flex:1;">' +
        '<div class="roster-name">' + (p.prenom ? p.prenom + ' ' : '') + p.nom + '</div>' +
        '<div style="display:flex;align-items:center;gap:8px;">' +
          '<div class="roster-pos">' + (p.poste||'') + '</div>' +
          statsBar +
        '</div>' +
      '</div>' +
      '<div class="roster-status" style="background:rgba(0,0,0,0.2);color:' + statusColor + ';border:1px solid ' + statusColor + ';padding:3px 7px;border-radius:3px;font-size:9px;white-space:nowrap;">' + statusLabel + '</div>' +
    '</div>';
  }).join('');
}

function setClubFilter(f, el) {
  _clubFilter = f;
  document.querySelectorAll('#clf-all,#clf-ok,#clf-injured,#clf-suspended').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderClubRoster();
}

function openClubPlayerModal(pid) {
  _editClubPlayerId = pid;
  var players = clubPlayers();
  var p = pid ? players.find(function(x){ return x.id === pid; }) : null;
  var title = document.getElementById('clubPlayerModalTitle');
  if (title) title.textContent = p ? 'MODIFIER JOUEUR' : 'NOUVEAU JOUEUR';
  document.getElementById('cpPrenom').value = p ? (p.prenom||'') : '';
  document.getElementById('cpNom').value = p ? (p.nom||'') : '';
  document.getElementById('cpNum').value = p ? (p.num||'') : '';
  document.getElementById('cpPoste').value = p ? (p.poste||'Milieu central') : 'Milieu central';
  document.getElementById('cpCat').value = p ? (p.cat||'Senior') : 'Senior';
  document.getElementById('cpPied').value = p ? (p.pied||'D') : 'D';
  document.getElementById('cpMj').value = p && p.stats ? (p.stats.matchs||0) : 0;
  document.getElementById('cpButs').value = p && p.stats ? (p.stats.buts||0) : 0;
  document.getElementById('cpPasses').value = p && p.stats ? (p.stats.passes||0) : 0;
  document.getElementById('cpMinutes').value = p && p.stats ? (p.stats.minutes||0) : 0;
  var delBtn = document.getElementById('btnDeleteClubPlayer');
  if (delBtn) delBtn.style.display = p ? 'block' : 'none';
  document.getElementById('modalClubPlayer').classList.add('open');
}

function saveClubPlayer() {
  var prenom = document.getElementById('cpPrenom').value.trim();
  var nom = document.getElementById('cpNom').value.trim();
  if (!prenom && !nom) { alert('Saisis au moins le pr√©nom ou le nom'); return; }
  var players = clubPlayers();
  var pd = {
    id: _editClubPlayerId || Date.now().toString(),
    prenom: prenom, nom: nom,
    num: document.getElementById('cpNum').value,
    poste: document.getElementById('cpPoste').value,
    cat: document.getElementById('cpCat').value,
    pied: document.getElementById('cpPied').value,
    stats: {
      matchs: parseInt(document.getElementById('cpMj').value)||0,
      buts: parseInt(document.getElementById('cpButs').value)||0,
      passes: parseInt(document.getElementById('cpPasses').value)||0,
      minutes: parseInt(document.getElementById('cpMinutes').value)||0
    },
    status: 'ok'
  };
  if (_editClubPlayerId) {
    var idx = players.findIndex(function(x){ return x.id === _editClubPlayerId; });
    if (idx >= 0) {
      pd.status = players[idx].status || 'ok';
      pd.injNote = players[idx].injNote;
      pd.retour = players[idx].retour;
      players[idx] = pd;
    }
  } else {
    players.push(pd);
  }
  saveClubPlayers(players);
  closeModal('modalClubPlayer');
  renderClubRoster();
  renderClubInfoBar();
}

function deleteClubPlayer() {
  if (!_editClubPlayerId) return;
  if (!confirm('Supprimer ce joueur ?')) return;
  var players = clubPlayers().filter(function(p){ return p.id !== _editClubPlayerId; });
  saveClubPlayers(players);
  closeModal('modalClubPlayer');
  renderClubRoster();
  renderClubInfoBar();
}

// SANT√â
function renderClubHealth() {
  var players = clubPlayers();
  var filtered = players.filter(function(p){ return p.status === _clubInjType; });
  var list = document.getElementById('clubHealthList');
  if (!list) return;
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-log">Aucun joueur dans cette cat√©gorie</div>';
    return;
  }
  list.innerHTML = filtered.map(function(p) {
    var icon = p.status === 'injured' ? 'üî¥' : p.status === 'suspended' ? 'üü°' : '‚ö´';
    return '<div class="roster-item" style="cursor:pointer;" onclick="clearClubHealth(\'' + p.id + '\')">' +
      '<div class="roster-num">' + (p.num||'') + '</div>' +
      '<div style="flex:1;">' +
        '<div class="roster-name">' + icon + ' ' + (p.prenom ? p.prenom + ' ' : '') + p.nom + '</div>' +
        '<div style="font-family:\'Rajdhani\',sans-serif;font-size:11px;font-weight:600;color:var(--muted);">' +
          (p.injNote||'') + (p.retour ? ' ‚Äî Retour : ' + p.retour : '') +
        '</div>' +
      '</div>' +
      '<div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Tap = R√©tabli</div>' +
    '</div>';
  }).join('');
}

function setClubInjType(t, el) {
  _clubInjType = t;
  document.querySelectorAll('#injt-injured,#injt-suspended,#injt-unavailable').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderClubHealth();
}

function openClubHealthModal() {
  var players = clubPlayers().filter(function(p){ return !p.status || p.status === 'ok'; });
  var sel = document.getElementById('chPlayer');
  if (!sel) return;
  sel.innerHTML = players.map(function(p){
    return '<option value="' + p.id + '">' + (p.num ? '#'+p.num+' ' : '') + (p.prenom ? p.prenom+' ' : '') + p.nom + '</option>';
  }).join('');
  _clubHealthStatus = 'injured';
  document.querySelectorAll('#chs-injured,#chs-suspended,#chs-unavailable').forEach(function(b){ b.classList.remove('sel'); });
  var injEl = document.getElementById('chs-injured');
  if (injEl) injEl.classList.add('sel');
  document.getElementById('chNote').value = '';
  document.getElementById('chRetour').value = '';
  document.getElementById('modalClubHealth').classList.add('open');
}

function setClubHealthStatus(s, el) {
  _clubHealthStatus = s;
  document.querySelectorAll('#chs-injured,#chs-suspended,#chs-unavailable').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
}

function saveClubHealth() {
  var pid = document.getElementById('chPlayer').value;
  var players = clubPlayers();
  var p = players.find(function(x){ return x.id === pid; });
  if (!p) return;
  p.status = _clubHealthStatus;
  p.injNote = document.getElementById('chNote').value.trim();
  p.retour = document.getElementById('chRetour').value;
  saveClubPlayers(players);
  closeModal('modalClubHealth');
  renderClubHealth();
  renderClubInfoBar();
}

function clearClubHealth(pid) {
  if (!confirm('Marquer ce joueur comme r√©tabli ?')) return;
  var players = clubPlayers();
  var p = players.find(function(x){ return x.id === pid; });
  if (p) { p.status = 'ok'; p.injNote = ''; p.retour = ''; }
  saveClubPlayers(players);
  renderClubHealth();
  renderClubInfoBar();
}

// STATS
function renderClubStats() {
  var players = clubPlayers().filter(function(p){ return p.stats; });
  players.sort(function(a, b) {
    var va = a.stats[_clubStatCat] || 0;
    var vb = b.stats[_clubStatCat] || 0;
    return vb - va;
  });
  var list = document.getElementById('clubStatsList');
  if (!list) return;
  if (!players.length) { list.innerHTML = '<div class="empty-log">Aucune stat disponible</div>'; return; }
  var max = players[0].stats[_clubStatCat] || 1;
  list.innerHTML = players.map(function(p, i) {
    var val = p.stats[_clubStatCat] || 0;
    var pct = Math.round((val / max) * 100);
    var medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)+'.';
    return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:6px;">' +
      '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">' +
        '<div style="font-family:\'Rajdhani\',sans-serif;font-size:14px;font-weight:700;min-width:26px;">' + medal + '</div>' +
        '<div style="flex:1;font-family:\'Rajdhani\',sans-serif;font-size:15px;font-weight:700;">' + (p.prenom ? p.prenom+' ':'')+p.nom + '</div>' +
        '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:26px;color:var(--accent);line-height:1;">' + val + '</div>' +
      '</div>' +
      '<div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden;">' +
        '<div style="height:100%;width:' + pct + '%;background:var(--accent);border-radius:2px;transition:width .4s;"></div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function setClubStatCat(cat, el) {
  _clubStatCat = cat;
  document.querySelectorAll('#scat-buts,#scat-passes,#scat-matchs,#scat-minutes').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderClubStats();
}

// SAISON
function renderClubSeason() {
  var history = getMatchHistory();
  // Filter by format
  var matches = history;
  // Season stats
  var total = matches.length;
  var wins = matches.filter(function(m){ return m.homeScore > m.awayScore; }).length;
  var draws = matches.filter(function(m){ return m.homeScore === m.awayScore; }).length;
  var losses = total - wins - draws;
  var gf = matches.reduce(function(s,m){ return s + (m.homeScore||0); }, 0);
  var ga = matches.reduce(function(s,m){ return s + (m.awayScore||0); }, 0);
  var pts = wins * 3 + draws;

  var statsEl = document.getElementById('clubSeasonStats');
  if (statsEl) statsEl.innerHTML = [
    ['MJ', total, 'var(--text)'],
    ['V', wins, 'var(--accent)'],
    ['N', draws, 'var(--yellow)'],
    ['D', losses, 'var(--red)'],
    ['PTS', pts, 'var(--blue)'],
    ['GF', gf, 'var(--accent)'],
    ['GA', ga, 'var(--red)'],
    ['DIFF', (gf-ga >= 0 ? '+':'')+( gf-ga), gf>=ga?'var(--accent)':'var(--red)'],
    ['%V', total ? Math.round(wins/total*100)+'%' : '‚Äî', 'var(--text)']
  ].map(function(s){
    return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 6px;text-align:center;">' +
      '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:26px;color:' + s[2] + ';line-height:1;">' + s[1] + '</div>' +
      '<div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;">' + s[0] + '</div>' +
    '</div>';
  }).join('');

  // Match list
  var filtered = matches.filter(function(m) {
    if (_clubSeasonFilter === 'all') return true;
    if (_clubSeasonFilter === 'win') return m.homeScore > m.awayScore;
    if (_clubSeasonFilter === 'draw') return m.homeScore === m.awayScore;
    if (_clubSeasonFilter === 'loss') return m.homeScore < m.awayScore;
    return true;
  });
  filtered = filtered.slice().reverse();

  var list = document.getElementById('clubSeasonList');
  if (!list) return;
  if (!filtered.length) { list.innerHTML = '<div class="empty-log">Aucun match archiv√©</div>'; return; }
  list.innerHTML = filtered.map(function(m) {
    var isWin = m.homeScore > m.awayScore;
    var isDraw = m.homeScore === m.awayScore;
    var resultColor = isWin ? 'var(--accent)' : isDraw ? 'var(--yellow)' : 'var(--red)';
    var resultLabel = isWin ? 'V' : isDraw ? 'N' : 'D';
    var date = m.date ? new Date(m.date).toLocaleDateString('fr-FR', {day:'2-digit',month:'2-digit'}) : '';
    return '<div style="background:var(--surface2);border:1px solid var(--border);border-left:3px solid ' + resultColor + ';border-radius:6px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;">' +
      '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:18px;color:' + resultColor + ';min-width:20px;">' + resultLabel + '</div>' +
      '<div style="flex:1;">' +
        '<div style="font-family:\'Rajdhani\',sans-serif;font-size:14px;font-weight:700;">' + (m.homeTeam||'Nous') + ' ' + m.homeScore + ' ‚Äî ' + m.awayScore + ' ' + (m.awayTeam||'Adv') + '</div>' +
        '<div style="font-family:\'Rajdhani\',sans-serif;font-size:10px;font-weight:600;color:var(--muted);letter-spacing:1px;">' + (m.tactic||'') + (date ? ' ¬∑ ' + date : '') + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function setClubSeasonFilter(f, el) {
  _clubSeasonFilter = f;
  document.querySelectorAll('#shf-all,#shf-win,#shf-draw,#shf-loss').forEach(function(b){ b.classList.remove('sel'); });
  if (el) el.classList.add('sel');
  renderClubSeason();
}

function syncClubFromHistory() {
  var history = getMatchHistory();
  if (!history.length) { alert('Aucun match archiv√© √† synchroniser.'); return; }
  // Update player stats from match events
  var players = clubPlayers();
  players.forEach(function(p) {
    var totalButs = 0, totalPasses = 0, totalMatchs = 0, totalMin = 0;
    history.forEach(function(m) {
      if (!m.events) return;
      var played = m.events.some(function(e){ return e.playerId == p.id; });
      var subIn = m.substitutions ? m.substitutions.some(function(s){ return s.inId == p.id; }) : false;
      var subOut = m.substitutions ? m.substitutions.find(function(s){ return s.outId == p.id; }) : null;
      if (played || subIn) {
        totalMatchs++;
        totalButs += m.events.filter(function(e){ return e.playerId == p.id && (e.type === 'BUT' || e.type === 'PENALTY_MRQ'); }).length;
        totalPasses += m.events.filter(function(e){ return e.playerId == p.id && e.type === 'ASSIST'; }).length;
      }
    });
    if (!p.stats) p.stats = {};
    p.stats.matchs = totalMatchs;
    p.stats.buts = totalButs;
    p.stats.passes = totalPasses;
  });
  saveClubPlayers(players);
  renderClubStats();
  renderClubRoster();
  alert('‚úÖ Stats synchronis√©es depuis ' + history.length + ' matchs.');
}

// CONFIG CLUB
function renderClubCfg() {
  var d = loadClubData();
  var n = document.getElementById('cfgClubName'); if (n) n.value = d.name || '';
  var s = document.getElementById('cfgClubSeason'); if (s) s.value = d.season || '';
  var cat = document.getElementById('cfgClubCategory'); if (cat) cat.value = d.category || '';
  var e = document.getElementById('cfgClubEmoji'); if (e) e.value = d.emoji || '‚öΩ';
}
function saveClubCfg() {
  var d = loadClubData();
  var n = document.getElementById('cfgClubName'); if (n) d.name = n.value;
  var s = document.getElementById('cfgClubSeason'); if (s) d.season = s.value;
  var cat = document.getElementById('cfgClubCategory'); if (cat) d.category = cat.value;
  var e = document.getElementById('cfgClubEmoji'); if (e) d.emoji = e.value;
  saveClubData(d);
  renderClubInfoBar();
}
function resetClubData() {
  if (!confirm('Supprimer TOUTES les donn√©es club ? Cette action est irr√©versible.')) return;
  localStorage.removeItem('ct_club');
  renderClubRoster();
  renderClubInfoBar();
  renderClubCfg();
  alert('Donn√©es club r√©initialis√©es.');
}

// IMPORT DEPUIS CLUB (pour le match en cours)
function openImportCMModal() {
  var players = clubPlayers().filter(function(p){ return !p.status || p.status === 'ok'; });
  var list = document.getElementById('importCMPlayerList');
  var clubSel = document.getElementById('importCMClubSelect');
  var note = document.getElementById('importCMNote');
  _importSelectedPlayers = [];
  _importStatus = 'field';
  document.querySelectorAll('.importStatusBtn').forEach(function(b){ b.classList.remove('sel'); });
  var istField = document.getElementById('ist-field');
  if (istField) istField.classList.add('sel');
  if (note) note.textContent = '';

  if (!players.length) {
    if (clubSel) clubSel.innerHTML = '<div style="font-family:\'Rajdhani\',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;">Aucun joueur dans le module Club (Format ' + _clubFormat + ')</div>';
    if (list) list.innerHTML = '';
    document.getElementById('modalImportCM').classList.add('open');
    return;
  }

  if (clubSel) {
    var d = loadClubData();
    clubSel.innerHTML = '<div style="font-family:\'Rajdhani\',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">üì• Import depuis : ' + (d.name||'Mon Club') + ' ‚Äî Football √† ' + _clubFormat + '</div>';
  }

  // Show already imported players
  var existingIds = roster.map(function(r){ return r.id; });
  if (list) list.innerHTML = players.map(function(p) {
    var already = existingIds.indexOf(p.id) >= 0;
    var fullName = (p.prenom ? p.prenom + ' ' : '') + p.nom;
    return '<div id="imp-' + p.id + '" onclick="' + (already ? '' : 'toggleImportPlayer(\'' + p.id + '\')') + '" style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:6px;cursor:' + (already?'default':'pointer') + ';opacity:' + (already?'0.4':'1') + ';">' +
      '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:20px;color:rgba(0,230,118,0.5);min-width:28px;">' + (p.num||'') + '</div>' +
      '<div style="flex:1;"><div style="font-family:\'Rajdhani\',sans-serif;font-size:14px;font-weight:700;">' + fullName + '</div>' +
      '<div style="font-family:\'Rajdhani\',sans-serif;font-size:10px;font-weight:600;color:var(--muted);letter-spacing:1px;">' + (p.poste||'') + '</div></div>' +
      (already ? '<div style="font-family:\'Rajdhani\',sans-serif;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;">D√âJ√Ä AJOUT√â</div>' : '<div id="imp-chk-' + p.id + '" style="width:20px;height:20px;border:2px solid var(--border);border-radius:4px;"></div>') +
    '</div>

  <div class="setup-card">
    <div class="section-title" style="margin-top:0">üíæ Sauvegarde des donn√©es</div>
    <div style="font-family:var(--fb);font-size:11px;color:var(--muted);margin-bottom:12px;line-height:1.6;">
      Exporte tes donn√©es avant chaque mise √† jour de l'app.<br>
      L'import restaure : effectif Club, joueurs, stats et historique.
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
      <button class="btn-modal-confirm" style="background:linear-gradient(135deg,#0047ab,#0095cc);" onclick="exportSauvegarde()">üì§ EXPORTER</button>
      <button class="btn-modal-confirm" style="background:linear-gradient(135deg,#6a0dad,#9b30d8);" onclick="document.getElementById('importSauvegardeFile').click()">üì• IMPORTER</button>
    </div>
    <input type="file" id="importSauvegardeFile" accept=".json" style="display:none" onchange="importSauvegarde(event)">
    <div style="font-family:var(--fb);font-size:10px;color:rgba(255,107,0,0.8);margin-top:4px;">‚ö†Ô∏è L'import remplace les donn√©es existantes</div>
  </div>';
  }).join('');

  document.getElementById('modalImportCM').classList.add('open');
}

function toggleImportPlayer(pid) {
  var idx = _importSelectedPlayers.indexOf(pid);
  var chk = document.getElementById('imp-chk-' + pid);
  var row = document.getElementById('imp-' + pid);
  if (idx >= 0) {
    _importSelectedPlayers.splice(idx, 1);
    if (chk) { chk.style.background = ''; chk.style.borderColor = 'var(--border)'; chk.textContent = ''; }
    if (row) row.style.background = 'var(--surface2)';
  } else {
    _importSelectedPlayers.push(pid);
    if (chk) { chk.style.background = 'var(--accent)'; chk.style.borderColor = 'var(--accent)'; chk.textContent = '‚úì'; chk.style.color='#000'; chk.style.textAlign='center'; chk.style.lineHeight='18px'; chk.style.fontSize='12px'; }
    if (row) row.style.background = 'rgba(0,230,118,0.05)';
  }
  var cnt = document.getElementById('importCMCount');
  if (cnt) cnt.textContent = _importSelectedPlayers.length + ' joueur(s) s√©lectionn√©(s)';
}

function confirmImportCM() {
  if (!_importSelectedPlayers.length) { alert('S√©lectionne au moins un joueur.'); return; }
  var players = clubPlayers();
  var added = 0;
  _importSelectedPlayers.forEach(function(pid) {
    var p = players.find(function(x){ return x.id === pid; });
    if (!p) return;
    if (roster.find(function(r){ return r.id === pid; })) return;
    roster.push({
      id: p.id,
      num: p.num || '',
      name: (p.prenom ? p.prenom + ' ' : '') + p.nom,
      pos: posFromPoste(p.poste),
      status: _importStatus,
      entryTime: _importStatus === 'field' ? seconds : null,
      totalSeconds: 0
    });
    added++;
  });
  saveRoster();
  closeModal('modalImportCM');
  renderRoster();
  if (typeof renderPitch === 'function') renderPitch();
  alert('‚úÖ ' + added + ' joueur(s) import√©(s) dans le match.');
}

function posFromPoste(poste) {
  var map = {
    'Gardien':'GK','D√©fenseur central':'DC','Lat√©ral gauche':'DL','Lat√©ral droit':'DR',
    'Milieu d√©fensif':'MDC','Milieu central':'MC','Milieu offensif':'MO',
    'Ailier gauche':'AG','Ailier droit':'AD','Attaquant':'ATT'
  };
  return map[poste] || 'MC';
}

// Initialisation du module Club
function initClubModule() {
  renderClubInfoBar();
}

// Init Club
initClubModule();
  updateLocationBadge();

// ===== EXPORT / IMPORT DONN√âES =====
function exportAllData() {
  var data = {
    version: 5,
    exportDate: new Date().toISOString(),
    appName: 'Coach Tracker Pro',
    matchHistory: localStorage.getItem('ct_match_history') || '[]',
    clubData: localStorage.getItem('ct_club') || 'null',
    rosterData: localStorage.getItem('ct_roster') || '[]',
    setupData: {
      home: document.getElementById('setupHome') ? document.getElementById('setupHome').value : '',
      away: document.getElementById('setupAway') ? document.getElementById('setupAway').value : '',
      comp: document.getElementById('setupComp') ? document.getElementById('setupComp').value : '',
      halfDuration: halfDuration,
      format: currentFormat,
      location: matchLocation
    }
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  var d = new Date();
  a.href = url;
  a.download = 'coach-tracker-backup-' + d.getDate() + '-' + (d.getMonth()+1) + '-' + d.getFullYear() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  var st = document.getElementById('importStatus');
  if(st) { st.textContent = 'Donnees exportees !'; st.style.color = 'var(--accent)'; }
}

function importAllData(event) {
  var file = event.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if(!data.appName || data.appName !== 'Coach Tracker Pro') {
        alert('Fichier invalide.');
        return;
      }
      if(!confirm('Importer les donnees ? Effectif, historique et config seront restaures.')) return;
      if(data.matchHistory) localStorage.setItem('ct_match_history', data.matchHistory);
      if(data.clubData && data.clubData !== 'null') localStorage.setItem('ct_club', data.clubData);
      if(data.rosterData) localStorage.setItem('ct_roster', data.rosterData);
      if(data.setupData) {
        var s = data.setupData;
        if(document.getElementById('setupHome')) document.getElementById('setupHome').value = s.home || '';
        if(document.getElementById('setupAway')) document.getElementById('setupAway').value = s.away || '';
        if(document.getElementById('setupComp')) document.getElementById('setupComp').value = s.comp || '';
        if(s.halfDuration) setHalfDuration(s.halfDuration, null);
        if(s.format) currentFormat = s.format;
        if(s.location) {
          matchLocation = s.location;
          var locBtn = document.getElementById('loc-' + s.location);
          if(locBtn) setMatchLocation(s.location, locBtn);
        }
        applySetup(true);
      }
      var storedRoster = localStorage.getItem('ct_roster');
      if(storedRoster) { try { roster = JSON.parse(storedRoster); } catch(e2) {} }
      renderRoster();
      renderHistorique();
      if(typeof renderClubInfoBar === 'function') renderClubInfoBar();
      var st = document.getElementById('importStatus');
      if(st) { st.textContent = 'Import reussi !'; st.style.color = 'var(--accent)'; }
      alert('Import reussi ! Donnees restaurees.');
    } catch(err) {
      alert('Erreur import : ' + err.message);
    }
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê SAUVEGARDE EXPORT / IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportSauvegarde(){
  var data = {
    appName: 'CoachTrackerPro',
    version: '5.0',
    exportDate: new Date().toLocaleDateString('fr-FR'),
    exportTs: Date.now(),
    // Club + effectif
    ct_club: localStorage.getItem('ct_club'),
    // Historique matchs
    ct_match_history: localStorage.getItem('ct_match_history'),
    // Effectif match en cours (optionnel)
    roster: JSON.stringify(roster),
    // Events match en cours
    events: JSON.stringify(events),
    matchLocation: matchLocation,
    scoreHome: scoreHome,
    scoreAway: scoreAway,
    currentFormat: currentFormat,
    halfDuration: halfDuration,
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'coach-tracker-sauvegarde-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úÖ Sauvegarde export√©e !\nGarde ce fichier en lieu s√ªr avant de mettre √† jour l\'app.');
}

function importSauvegarde(event){
  var file = event.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if(!data.appName || data.appName !== 'CoachTrackerPro'){
        alert('‚ùå Fichier invalide ‚Äî ce n\'est pas une sauvegarde Coach Tracker Pro.');
        return;
      }
      var msg = 'üì• Restaurer la sauvegarde du ' + (data.exportDate||'?') + ' ?\n\n';
      msg += '‚úÖ Sera restaur√© :\n‚Ä¢ Effectif Club (joueurs, stats, sant√©)\n‚Ä¢ Historique des matchs\n‚Ä¢ Match en cours\n\n';
      msg += '‚ö†Ô∏è Les donn√©es actuelles seront remplac√©es.';
      if(!confirm(msg)) return;
      // Restore localStorage keys
      if(data.ct_club) localStorage.setItem('ct_club', data.ct_club);
      if(data.ct_match_history) localStorage.setItem('ct_match_history', data.ct_match_history);
      // Restore in-memory state
      if(data.roster) { try { roster = JSON.parse(data.roster); } catch(e){} }
      if(data.events) { try { events = JSON.parse(data.events); } catch(e){} }
      if(data.matchLocation) matchLocation = data.matchLocation;
      if(data.scoreHome !== undefined) { scoreHome = data.scoreHome; document.getElementById('scoreHomeEl').textContent = scoreHome; }
      if(data.scoreAway !== undefined) { scoreAway = data.scoreAway; document.getElementById('scoreAwayEl').textContent = scoreAway; }
      if(data.currentFormat) currentFormat = data.currentFormat;
      if(data.halfDuration) halfDuration = data.halfDuration;
      // Re-render
      renderRoster();
      renderHistorique();
      updateLocationBadge();
      if(typeof initClubModule === 'function') initClubModule();
      alert('‚úÖ Sauvegarde restaur√©e avec succ√®s !\nTon effectif et historique sont de retour.');
    } catch(err) {
      alert('‚ùå Erreur lors de l\'import : ' + err.message);
    }
  };
  reader.readAsText(file);
  // Reset input so same file can be re-imported
  event.target.value = '';
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê SAUVEGARDE EXPORT / IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportSauvegarde(){
  var data = {
    appName: 'CoachTrackerPro',
    version: '5.0',
    exportDate: new Date().toLocaleDateString('fr-FR'),
    exportTs: Date.now(),
    ct_club: localStorage.getItem('ct_club'),
    ct_match_history: localStorage.getItem('ct_match_history'),
    roster: JSON.stringify(roster),
    events: JSON.stringify(events),
    substitutions: JSON.stringify(substitutions),
    matchLocation: matchLocation,
    scoreHome: scoreHome,
    scoreAway: scoreAway,
    currentFormat: currentFormat,
    halfDuration: halfDuration
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href=url;
  a.download = 'coach-tracker-' + new Date().toISOString().slice(0,10) + '.json';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Sauvegarde export√©e !\nGarde ce fichier en lieu s√ªr avant de mettre √† jour l\'app.');
}

function importSauvegarde(event){
  var file = event.target.files[0]; if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e){
    try{
      var data = JSON.parse(e.target.result);
      if(!data.appName || data.appName !== 'CoachTrackerPro'){
        alert('‚ùå Fichier invalide ‚Äî ce n\'est pas une sauvegarde Coach Tracker Pro.'); return;
      }
      var msg = 'üì• Restaurer la sauvegarde du ' + (data.exportDate||'?') + ' ?\n\n';
      msg += '‚úÖ Sera restaur√© :\n‚Ä¢ Effectif Club (joueurs, stats, sant√©)\n‚Ä¢ Historique des matchs\n‚Ä¢ Match en cours\n\n';
      msg += '‚ö†Ô∏è Les donn√©es actuelles seront remplac√©es.';
      if(!confirm(msg)) return;
      if(data.ct_club) localStorage.setItem('ct_club', data.ct_club);
      if(data.ct_match_history) localStorage.setItem('ct_match_history', data.ct_match_history);
      try{ if(data.roster) roster = JSON.parse(data.roster); }catch(ex){}
      try{ if(data.events) events = JSON.parse(data.events); }catch(ex){}
      try{ if(data.substitutions) substitutions = JSON.parse(data.substitutions); }catch(ex){}
      if(data.matchLocation) { matchLocation=data.matchLocation; updateLocationBadge(); setMatchLocationButtons(); }
      if(data.scoreHome!==undefined){ scoreHome=data.scoreHome; document.getElementById('scoreHomeEl').textContent=scoreHome; }
      if(data.scoreAway!==undefined){ scoreAway=data.scoreAway; document.getElementById('scoreAwayEl').textContent=scoreAway; }
      if(data.currentFormat) currentFormat=data.currentFormat;
      if(data.halfDuration) halfDuration=data.halfDuration;
      renderRoster(); renderHistorique();
      if(typeof initClubModule==='function') initClubModule();
      alert('‚úÖ Sauvegarde restaur√©e !\nEffectif et historique sont de retour.');
    }catch(err){ alert('‚ùå Erreur import : '+err.message); }
  };
  reader.readAsText(file);
  event.target.value='';
}

function setMatchLocationButtons(){
  ['domicile','exterieur','neutre'].forEach(function(loc){
    var btn = document.getElementById('loc-'+loc);
    if(btn){ if(loc===matchLocation) btn.classList.add('sel'); else btn.classList.remove('sel'); }
  });
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

